{
	"ID": "20250328014529-i14ckfn",
	"Spec": "1",
	"Type": "NodeDocument",
	"Properties": {
		"id": "20250328014529-i14ckfn",
		"title": "KVM IO虚拟化_virtualio和virtual bus-CSDN博客",
		"type": "doc",
		"updated": "20250328014529"
	},
	"Children": [
		{
			"ID": "20250328014529-4m52ya3",
			"Type": "NodeThematicBreak",
			"Properties": {
				"id": "20250328014529-4m52ya3",
				"updated": "20250328014529"
			}
		},
		{
			"ID": "20250328014529-jgc4qg1",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20250328014529-jgc4qg1",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"ID": "20250328014529-qr55u2v",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-qr55u2v",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-gs2va46",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-gs2va46",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "KVM IO虚拟化_virtualio和virtual bus-CSDN博客"
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-ozeds7y",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-ozeds7y",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-8uenex2",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-8uenex2",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752",
									"TextMarkTextContent": "https://blog.csdn.net/home19900111/article/details/128610752"
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-0831mbi",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-0831mbi",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-dh8ap58",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-dh8ap58",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "KVM IO虚拟化 摘要：本文介绍了KVM IO虚拟化的相关概念，包括PCIe通信、PCIe Configuration Space、MSI和DMA等。"
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-2d1xyam",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-2d1xyam",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-6mo719v",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-6mo719v",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "2025-03-28 01:45:29"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-5ds9avk",
			"Type": "NodeThematicBreak",
			"Properties": {
				"id": "20250328014529-5ds9avk",
				"updated": "20250328014529"
			}
		},
		{
			"ID": "20250328014529-yohup29",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-yohup29",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeTextMark",
					"TextMarkType": "strong",
					"TextMarkTextContent": "目录"
				}
			]
		},
		{
			"ID": "20250328014529-49zyxpf",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-49zyxpf",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t0",
					"TextMarkTextContent": "1 I/O概述"
				}
			]
		},
		{
			"ID": "20250328014529-s3rs09f",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-s3rs09f",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t1",
					"TextMarkTextContent": "2 PCIe"
				}
			]
		},
		{
			"ID": "20250328014529-ijj8c33",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-ijj8c33",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t2",
					"TextMarkTextContent": "2.1 PCIe通信"
				}
			]
		},
		{
			"ID": "20250328014529-tulvuq5",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-tulvuq5",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t3",
					"TextMarkTextContent": "2.2 PCIe Configuration Space"
				}
			]
		},
		{
			"ID": "20250328014529-qzx03x9",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-qzx03x9",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t4",
					"TextMarkTextContent": "2.2.1 概述"
				}
			]
		},
		{
			"ID": "20250328014529-ebq7ewu",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-ebq7ewu",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t5",
					"TextMarkTextContent": "2.2.2 枚举"
				}
			]
		},
		{
			"ID": "20250328014529-cydr2so",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-cydr2so",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t6",
					"TextMarkTextContent": "2.2.3 Command \u0026amp; Status"
				}
			]
		},
		{
			"ID": "20250328014529-ueu3ka8",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-ueu3ka8",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t7",
					"TextMarkTextContent": "2.2.4 BAR"
				}
			]
		},
		{
			"ID": "20250328014529-o15gsmf",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-o15gsmf",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t8",
					"TextMarkTextContent": "2.3 MSI"
				}
			]
		},
		{
			"ID": "20250328014529-h18y4au",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-h18y4au",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t9",
					"TextMarkTextContent": "3 I/O虚拟化(一)"
				}
			]
		},
		{
			"ID": "20250328014529-8j1tyxl",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-8j1tyxl",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t10",
					"TextMarkTextContent": "3.1 Trap I/O 操作"
				}
			]
		},
		{
			"ID": "20250328014529-avjmucn",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-avjmucn",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t11",
					"TextMarkTextContent": "3.1.1 PIO"
				}
			]
		},
		{
			"ID": "20250328014529-6lm75fv",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-6lm75fv",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t12",
					"TextMarkTextContent": "3.1.2 MMIO"
				}
			]
		},
		{
			"ID": "20250328014529-1ns801a",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-1ns801a",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t13",
					"TextMarkTextContent": "3.2 Emulate I/O"
				}
			]
		},
		{
			"ID": "20250328014529-fldu5f6",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-fldu5f6",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t14",
					"TextMarkTextContent": "4 PCI Emulation"
				}
			]
		},
		{
			"ID": "20250328014529-3rur9vg",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-3rur9vg",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t15",
					"TextMarkTextContent": "4.1 PCI设备初始化"
				}
			]
		},
		{
			"ID": "20250328014529-7xwcpdu",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-7xwcpdu",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t16",
					"TextMarkTextContent": "4.2 PCI Configuration Space"
				}
			]
		},
		{
			"ID": "20250328014529-bxpzort",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-bxpzort",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t17",
					"TextMarkTextContent": "4.3 PCI Bar"
				}
			]
		},
		{
			"ID": "20250328014529-yasra4q",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-yasra4q",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t18",
					"TextMarkTextContent": " 4.4 MSI-X"
				}
			]
		},
		{
			"ID": "20250328014529-kpkacqm",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-kpkacqm",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t19",
					"TextMarkTextContent": "5 VirtIO"
				}
			]
		},
		{
			"ID": "20250328014529-z5k8gvt",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-z5k8gvt",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t20",
					"TextMarkTextContent": "5.1 Virtio基础"
				}
			]
		},
		{
			"ID": "20250328014529-0la669t",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-0la669t",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t21",
					"TextMarkTextContent": "5.2 VirtIO in Qemu"
				}
			]
		},
		{
			"ID": "20250328014529-w8uj7o6",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-w8uj7o6",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t22",
					"TextMarkTextContent": "5.2.1 框架"
				}
			]
		},
		{
			"ID": "20250328014529-7pj16cs",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-7pj16cs",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t23",
					"TextMarkTextContent": "5.2.2 virtio queue"
				}
			]
		},
		{
			"ID": "20250328014529-xqmuok9",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-xqmuok9",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t24",
					"TextMarkTextContent": "5.3 vhost"
				}
			]
		},
		{
			"ID": "20250328014529-v9fwlxh",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-v9fwlxh",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t25",
					"TextMarkTextContent": "5.3.1 目的"
				}
			]
		},
		{
			"ID": "20250328014529-pnbdy6j",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-pnbdy6j",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t26",
					"TextMarkTextContent": " 5.3.2 evnetfd"
				}
			]
		},
		{
			"ID": "20250328014529-w5ou264",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-w5ou264",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t27",
					"TextMarkTextContent": "6 Passthrough"
				}
			]
		},
		{
			"ID": "20250328014529-8gst9hn",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-8gst9hn",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t28",
					"TextMarkTextContent": "6.1 IOMMU"
				}
			]
		},
		{
			"ID": "20250328014529-uhwq6xu",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-uhwq6xu",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t29",
					"TextMarkTextContent": "6.1.1 DMA Remapping"
				}
			]
		},
		{
			"ID": "20250328014529-m9tlbs4",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-m9tlbs4",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t30",
					"TextMarkTextContent": "6.1.2 IOMMU Group"
				}
			]
		},
		{
			"ID": "20250328014529-fx5bjo9",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-fx5bjo9",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t31",
					"TextMarkTextContent": " 6.2 VFIO"
				}
			]
		},
		{
			"ID": "20250328014529-nzvhvmz",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-nzvhvmz",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t32",
					"TextMarkTextContent": "6.2.1 Container/Group/Device"
				}
			]
		},
		{
			"ID": "20250328014529-azfczw9",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-azfczw9",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t33",
					"TextMarkTextContent": "6.2.2 Config/Bar"
				}
			]
		},
		{
			"ID": "20250328014529-gxj461a",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-gxj461a",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t34",
					"TextMarkTextContent": "6.2.3 Interrupt"
				}
			]
		},
		{
			"ID": "20250328014529-sxdgfpp",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-sxdgfpp",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://blog.csdn.net/home19900111/article/details/128610752#t35",
					"TextMarkTextContent": "6.2.4 DMA"
				}
			]
		},
		{
			"ID": "20250328014529-v0uqb9f",
			"Type": "NodeThematicBreak",
			"Properties": {
				"id": "20250328014529-v0uqb9f",
				"updated": "20250328014529"
			}
		},
		{
			"ID": "20250328014529-le3esh6",
			"Type": "NodeHeading",
			"HeadingLevel": 2,
			"Properties": {
				"id": "20250328014529-le3esh6",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "1 I/O概述"
				}
			]
		},
		{
			"ID": "20250328014529-vdyigqj",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-vdyigqj",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " I/O，input/output，参考下图，除内存之外，都可以认为是I/O设备，或者应该称作外设。"
				}
			]
		},
		{
			"ID": "20250328014529-jmz7cqb",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20250328014529-jmz7cqb",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20250328014529-mb1eo9d",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20250328014529-mb1eo9d",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"Type": "NodeTextMark",
							"TextMarkType": "strong",
							"TextMarkTextContent": "注:"
						},
						{
							"Type": "NodeText",
							"Data": "在x86架构中，有两个地址空间，即I/O和memory，一个用in/out指令操作，一个用mov操作；在早期的计算机系统中，需要使用in/out操作的设备，应该就是I/O设备；当然，这些位于I/O地址空间的设备，后来都可以用memory指令进行操作，即MMIO，两者的界限就变得模糊了。"
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-r4fdwj5",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-r4fdwj5",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://en.wikipedia.org/wiki/Intel_X99",
					"TextMarkATitle": "https://en.wikipedia.org/wiki/Intel_X99",
					"TextMarkTextContent": "https://en.wikipedia.org/wiki/Intel\\_X99"
				}
			]
		},
		{
			"ID": "20250328014529-71hmwh3",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-71hmwh3",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/030a3859b14a61eeabfc80257e6a0bba.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20250328014529-lx3mgff",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20250328014529-lx3mgff",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20250328014529-he1zg3t",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20250328014529-he1zg3t",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "Note: 我们也将存储栈称为I/O栈，但其实这种称呼是不准确的，因为网络也可以认为是一种I/O。"
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-0wwqmbq",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-0wwqmbq",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 所以，IO"
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://so.csdn.net/so/search?q=%E8%99%9A%E6%8B%9F%E5%8C%96\u0026amp;spm=1001.2101.3001.7020",
					"TextMarkTextContent": "虚拟化"
				},
				{
					"Type": "NodeText",
					"Data": "，其实就是这些外设的虚拟化。在了解如何进行IO虚拟化之前，我们需要先知道，这些设备是如何工作的。"
				}
			]
		},
		{
			"ID": "20250328014529-g68l77h",
			"Type": "NodeHeading",
			"HeadingLevel": 2,
			"Properties": {
				"id": "20250328014529-g68l77h",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "2 "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://so.csdn.net/so/search?q=PCIe\u0026amp;spm=1001.2101.3001.7020",
					"TextMarkTextContent": "PCIe"
				}
			]
		},
		{
			"ID": "20250328014529-xh51qz4",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-xh51qz4",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 这是我们最常见的外设设备总线，部分图和内容参考自下课程"
				}
			]
		},
		{
			"ID": "20250328014529-8r1asby",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-8r1asby",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "icon-default.png?t=N7T8"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/003a2ce7eb50c2e24a8c624c260c5930.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://marz.utk.edu/my-courses/cosc562/pcie/",
					"TextMarkATitle": "(PCIE) Peripheral Component Interconnect [Express] – Stephen Marz",
					"TextMarkTextContent": "https://marz.utk.edu/my-courses/cosc562/pcie/(PCIE) Peripheral Component Interconnect [Express] – Stephen Marzhttps://marz.utk.edu/my-courses/cosc562/pcie/"
				}
			]
		},
		{
			"ID": "20250328014529-5njrxou",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20250328014529-5njrxou",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "2.1 PCIe通信"
				}
			]
		},
		{
			"ID": "20250328014529-ubd0urn",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-ubd0urn",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " PCIe本质上，是一个CPU与外设之间的通信方式，正如其名称，Peripheral Component Interconnect Express，参考下图，引用自\n"
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://pcisig.com/sites/default/files/files/PCI_Express_Basics_Background.pdf#page=26",
					"TextMarkATitle": "PCI Express Basics Background.https://pcisig.com/sites/default/files/files/PCI_Express_Basics_Background.pdf#page=26",
					"TextMarkTextContent": "PCI Express Basics Background.https://pcisig.com/sites/default/files/files/PCI\\_Express\\_Basics\\_Background.pdf#page\\=26"
				}
			]
		},
		{
			"ID": "20250328014529-6nfjlof",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-6nfjlof",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/3914d3974ec0c4f67a31575f0787beef.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20250328014529-kowobt2",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-kowobt2",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "http://xillybus.com/tutorials/pci-express-tlp-pcie-primer-tutorial-guide-1",
					"TextMarkATitle": "Down to the TLP: How PCI express devices talk (Part I) | xillybus.com",
					"TextMarkTextContent": "Down to the TLP: How PCI express devices talk (Part I) | xillybus.com"
				},
				{
					"Type": "NodeText",
					"Data": " 有很好的概括："
				}
			]
		},
		{
			"ID": "20250328014529-15j2me1",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20250328014529-15j2me1",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20250328014529-l7xwukt",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20250328014529-l7xwukt",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "PCIe is more like a network, with each card connected to a network switch through a dedicated set of wires. Exactly like a local Ethernet network, each card has its own physical connection to the switch fabric. The similarity goes further: The communication takes the form of packets transmitted over these dedicated lines, with flow control, error detection and retransmissions."
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-6m1b7zw",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-6m1b7zw",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " Request\n are translated to one of four transaction types by the Transaction Layer:"
				}
			]
		},
		{
			"ID": "20250328014529-7vwwkn2",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20250328014529-7vwwkn2",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"ID": "20250328014529-xh8pzzj",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-xh8pzzj",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-hu06zqp",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-hu06zqp",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "Memory Read or Memory Write. Used to transfer data from or to a memory mapped location. – The protocol also supports a locked memory read transaction variant"
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-ubi8gc3",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-ubi8gc3",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-oyxmmzx",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-oyxmmzx",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "I/O Read or I/O Write. Used to transfer data from or to an I/O location. – These transactions are restricted to supporting legacy endpoint devices"
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-9e9u4fr",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-9e9u4fr",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-9whhsdf",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-9whhsdf",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "Configuration Read or Configuration Write. Used to discover device capabilities, program features, and check status in the 4KB PCI Express configuration space."
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-ff6iay1",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-ff6iay1",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-5h5om6g",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-5h5om6g",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "Messages. Handled like posted writes. Used for event signaling and general purpose messaging."
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-pbnh06k",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-pbnh06k",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 下图是Host和DMA通信过程示意，同样引用自以上连接："
				}
			]
		},
		{
			"ID": "20250328014529-zkp2unz",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-zkp2unz",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/d9afc3addad66e501e174a14e1f76bc5.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20250328014529-e5qgfjl",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-e5qgfjl",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/1a497c4a950592f31aef305e6b5ac3d9.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20250328014529-ahyh2af",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-ahyh2af",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 我们看到，无论是Host去操作Endpont，还是Endpoint执行DMA，都需要经过Root Complex；参考"
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://en.wikipedia.org/wiki/Root_complex",
					"TextMarkATitle": "https://en.wikipedia.org/wiki/Root_complex",
					"TextMarkTextContent": "https://en.wikipedia.org/wiki/Root\\_complex"
				}
			]
		},
		{
			"ID": "20250328014529-otf6k50",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20250328014529-otf6k50",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20250328014529-c1jkcjr",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20250328014529-c1jkcjr",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "A "
						},
						{
							"Type": "NodeTextMark",
							"TextMarkType": "strong",
							"TextMarkTextContent": "root complex"
						},
						{
							"Type": "NodeText",
							"Data": " device connects the CPU and memory subsystem to the PCI Express switch fabric composed of one or more PCIe or PCI devices"
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-pzjahr8",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-pzjahr8",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 总结起来它需要完成两方面的功能："
				}
			]
		},
		{
			"ID": "20250328014529-eib4s9n",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20250328014529-eib4s9n",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"ID": "20250328014529-hjo7tjo",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-hjo7tjo",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-btmdojv",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-btmdojv",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "将来自CPU的对某个地址的load/store指令操作，转换成Memory Read/Write Transaction Packet，这其中包括了从memory地址到PCIe通信地址的转化；"
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-bpo1jfx",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-bpo1jfx",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-2iq6ifr",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-2iq6ifr",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "处理来自PCIe Endpoint的Memory Read/Write Transaction Packet包，并去对应的内存地址存取数据；"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-kiyzabh",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20250328014529-kiyzabh",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "2.2 PCIe Configuration Space"
				}
			]
		},
		{
			"ID": "20250328014529-zud6kgd",
			"Type": "NodeHeading",
			"HeadingLevel": 4,
			"Properties": {
				"id": "20250328014529-zud6kgd",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "2.2.1 概述"
				}
			]
		},
		{
			"ID": "20250328014529-d2y55qd",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-d2y55qd",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 下图是一个Type 0的PCI Configuration Space，256 Bytes；而PCIe的则拓展到4K。"
				}
			]
		},
		{
			"ID": "20250328014529-uglg11v",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-uglg11v",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/72bcf4c904f49e9950f085280ea3620d.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20250328014529-kxmnp2p",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-kxmnp2p",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 前256字节，即PCI compatible的部分，可以通过两种方式访问，即"
				}
			]
		},
		{
			"ID": "20250328014529-w02zlxd",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20250328014529-w02zlxd",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"ID": "20250328014529-t7jvqee",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-t7jvqee",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-n2awkcy",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-n2awkcy",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "I/O port，即configuration address port  CF8h - CFBh和  and configuration data port CFCh - CFFh"
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "strong",
									"TextMarkTextContent": "，"
								},
								{
									"Type": "NodeText",
									"Data": "方法如下："
								}
							]
						},
						{
							"ID": "20250328014529-gdsapk3",
							"Type": "NodeCodeBlock",
							"IsFencedCodeBlock": true,
							"Properties": {
								"id": "20250328014529-gdsapk3",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeCodeBlockFenceOpenMarker",
									"Data": "```"
								},
								{
									"Type": "NodeCodeBlockFenceInfoMarker",
									"CodeBlockInfo": "Y3Bw"
								},
								{
									"Type": "NodeCodeBlockCode",
									"Data": "// put the address of the PCI chip register to be accessed in eax\n// CONFIG_ADDRESS is the following:\n// 0x80000000 | bus \u003c\u003c 16 | device \u003c\u003c 11 | function \u003c\u003c  8 | offset\n// offset here is the offset in pci configuration space\nmov eax,80000064h \n// put the address port in dx\nmov dx,0CF8h\n//s end the PCI address port to the I/O space of the processor\nout dx,eax\n//put the data port in dx\nmov dx,0CFCh\n// put the data read from the device in eax\nin eax,dx\n"
								},
								{
									"Type": "NodeCodeBlockFenceCloseMarker",
									"Data": "```"
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-9b7gplv",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-9b7gplv",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-hjpeyiz",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-hjpeyiz",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "Memory mapped address；"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-uzwj3p4",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-uzwj3p4",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " PCIe Configuration space多出来的部分，则只能通过memory mapping的方式访问。I/O port的访问地址是固定的，memory mapping的地址是如何确定的呢？参考，"
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://www.mouser.com/pdfdocs/3010datasheet.pdf",
					"TextMarkATitle": "https://www.mouser.com/pdfdocs/3010datasheet.pdf",
					"TextMarkTextContent": "https://www.mouser.com/pdfdocs/3010datasheet.pdf"
				},
				{
					"Type": "NodeText",
					"Data": "  3.3.2 PCI Express Enhanced Configuration Mechanism"
				}
			]
		},
		{
			"ID": "20250328014529-f3yh8w3",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20250328014529-f3yh8w3",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20250328014529-6aoq9z3",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20250328014529-6aoq9z3",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "The PCI Express Enhanced Configuration Mechanism utilizes a flat memory-mapped address\nspace to access device configuration registers. This address space is reported by the system firmware to the operating system. There is a register, PCIEXBAR, that defines the base address for the 256 MB block of addresses below top of addressable memory (currently 8 GB) for the configuration space associated with all buses, devices and functions that are potentially a part of the PCI Express root complex hierarchy."
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-vuxuvgl",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-vuxuvgl",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 为什么是256M？"
				}
			]
		},
		{
			"ID": "20250328014529-uanqn7a",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20250328014529-uanqn7a",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20250328014529-y59nyvb",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20250328014529-y59nyvb",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "Each PCIe device has 4KB configuration registers, PCIe supports the same number of buses as PCI, i.e. 256 buses, 32 devices per bus, and 8 functions per device. Therefore, the total size of the required memory range is: 256 x 32 x 8 x 4KB; which is equal to 256MB"
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-5iltqtk",
			"Type": "NodeHeading",
			"HeadingLevel": 4,
			"Properties": {
				"id": "20250328014529-5iltqtk",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "2.2.2 枚举"
				}
			]
		},
		{
			"ID": "20250328014529-dwopea7",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-dwopea7",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 在得到了256M的PCI Configuration Space之后，需要做设备枚举，参考"
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://en.wikipedia.org/wiki/PCI_configuration_space",
					"TextMarkATitle": "https://en.wikipedia.org/wiki/PCI_configuration_space",
					"TextMarkTextContent": "https://en.wikipedia.org/wiki/PCI\\_configuration\\_space"
				},
				{
					"Type": "NodeText",
					"Data": "具体方法为："
				}
			]
		},
		{
			"ID": "20250328014529-nlar3w3",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20250328014529-nlar3w3",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20250328014529-javaor8",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20250328014529-javaor8",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "Bus enumeration is performed by attempting to access the PCI configuration space registers for each buses (即尝试读取PCI Configration Space的前4个字节，Device ID | Vender ID\n), devices and functions. If no response is received from the device's function #0, the "
						},
						{
							"Type": "NodeTextMark",
							"TextMarkType": "a",
							"TextMarkAHref": "https://en.wikipedia.org/wiki/Bus_mastering",
							"TextMarkATitle": "bus master",
							"TextMarkTextContent": "bus master"
						},
						{
							"Type": "NodeText",
							"Data": " performs an abort and returns an all-bits-on value (FFFFFFFF in hexadecimal), which is an invalid VID/DID value, thus the BIOS or operating system can tell that the specified combination bus/device"
						},
						{
							"Type": "NodeBackslash",
							"Data": "span",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "_"
								}
							]
						},
						{
							"Type": "NodeText",
							"Data": "number/function (B/D/F) is not present."
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-yog0h54",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-yog0h54",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 在Linux\n内核中，PCI的枚举并不是直接去扫描整个PCI Configration Space，而是由ACPI介入提供Bus Number；"
				}
			]
		},
		{
			"ID": "20250328014529-ou6rbek",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-ou6rbek",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 参考连接："
				}
			]
		},
		{
			"ID": "20250328014529-i244mxp",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-i244mxp",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "icon-default.png?t=N7T8"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/003a2ce7eb50c2e24a8c624c260c5930.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://www.reddit.com/r/osdev/comments/pz1f3m/acpi_device_enumeration/",
					"TextMarkATitle": "ACPI Device Enumeration",
					"TextMarkTextContent": "https://www.reddit.com/r/osdev/comments/pz1f3m/acpi_device_enumeration/ACPI Device Enumerationhttps://www.reddit.com/r/osdev/comments/pz1f3m/acpi\\_device\\_enumeration/"
				}
			]
		},
		{
			"ID": "20250328014529-4opup4y",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20250328014529-4opup4y",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20250328014529-7fcrmd4",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20250328014529-7fcrmd4",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"Type": "NodeTextMark",
							"TextMarkType": "u",
							"TextMarkTextContent": "ACPI is meant to enumerate devices which are not otherwise discoverable by other means"
						},
						{
							"Type": "NodeText",
							"Data": ". For instance on x86, most devices are on the PCI bus, which has a mechanism for discovery, and are therefore not listed in ACPI. This is true even if the device is soldered onto the motherboard. That said, the PCI controller itself is not immediately discoverable and needs to be described in ACPI to begin to enumerate PCI devices."
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-2hf86vt",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-2hf86vt",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " ACPI是用来枚举无法通过其他方式发现的设备，比如那些被焊接在主板上的设备；PCI Controller就是这样一种设备；而位于PCI Bus上设备，则可以通过PCI总线自己的机制发现。"
				}
			]
		},
		{
			"ID": "20250328014529-gzvmkpf",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-gzvmkpf",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " ACPI提供给系统的是一个树形结构，参考连接："
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "icon-default.png?t=N7T8"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/003a2ce7eb50c2e24a8c624c260c5930.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://docs.kernel.org/firmware-guide/acpi/namespace.html",
					"TextMarkATitle": "ACPI Device Tree - Representation of ACPI Namespace — The Linux Kernel  documentation",
					"TextMarkTextContent": "https://docs.kernel.org/firmware-guide/acpi/namespace.htmlACPI Device Tree - Representation of ACPI Namespace — The Linux Kernel documentationhttps://docs.kernel.org/firmware-guide/acpi/namespace.html"
				}
			]
		},
		{
			"ID": "20250328014529-ghmayfj",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-ghmayfj",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/683e8a8659dcd09e75009cadb316aa3f.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20250328014529-jph0lq7",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-jph0lq7",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 其中"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "CID为PNP0A03的就是PCI Controller； 同时，这个Namespace还可以提供PCI Bus的Bus Number，所以，就不需要整个遍历PCI Configration Space。"
				}
			]
		},
		{
			"ID": "20250328014529-xe1a8da",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-xe1a8da",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 具体代码可以参考："
				}
			]
		},
		{
			"ID": "20250328014529-oqu81sw",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-oqu81sw",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 其中pci"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "bus"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "read"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "dev"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "vendor"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "id()用来读取vender id/device id来判断，这个槽位是否存在设备。之后，创建pci设备，注册进设备模型中，匹配驱动。"
				}
			]
		},
		{
			"ID": "20250328014529-3l07qhh",
			"Type": "NodeHeading",
			"HeadingLevel": 4,
			"Properties": {
				"id": "20250328014529-3l07qhh",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "2.2.3 Command \u0026 Status"
				}
			]
		},
		{
			"ID": "20250328014529-fm6i2x8",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-fm6i2x8",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/6e4122a780055bc1d2ba45a366421da1.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20250328014529-wku1mrj",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20250328014529-wku1mrj",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20250328014529-kzuojag",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20250328014529-kzuojag",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "This is a read/write register, and it is per-device. If we use MMIO (which we will), we want to ensure Memory Space is 1 so that the PCI device can respond to MMIO reads/writes. We will not be using PIO, so the I/O Space bit should be set to 0."
						}
					]
				},
				{
					"ID": "20250328014529-uj0fttm",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20250328014529-uj0fttm",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"Type": "NodeTextMark",
							"TextMarkType": "strong",
							"TextMarkTextContent": "Bus Mastering"
						},
						{
							"Type": "NodeText",
							"Data": " is only important if we need a particular PCI to write to RAM. This is usually necessary for "
						},
						{
							"Type": "NodeTextMark",
							"TextMarkType": "a",
							"TextMarkAHref": "https://so.csdn.net/so/search?q=MSI\u0026amp;spm=1001.2101.3001.7020",
							"TextMarkTextContent": "MSI"
						},
						{
							"Type": "NodeText",
							"Data": "/MSI-X writes which uses a physical MMIO address to signal a message."
						}
					]
				},
				{
					"ID": "20250328014529-0f179h4",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20250328014529-0f179h4",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "Make sure that you set the command register BEFORE loading or storing to the address assigned to the BARs! All devices should have bit 1 set, and all bridges should have bits 1 and 2 set. ​"
						},
						{
							"Type": "NodeTextMark",
							"TextMarkType": "strong",
							"TextMarkTextContent": "NOTE"
						},
						{
							"Type": "NodeText",
							"Data": "​: The “info pci” command in QEMU will not display the addresses you store into the BARs until the command register is set to accept memory space requests (bit index 1)."
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-pwyqs0z",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-pwyqs0z",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 参考nvme驱动代码："
				}
			]
		},
		{
			"ID": "20250328014529-c5ytola",
			"Type": "NodeHeading",
			"HeadingLevel": 4,
			"Properties": {
				"id": "20250328014529-c5ytola",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "2.2.4 BAR"
				}
			]
		},
		{
			"ID": "20250328014529-2soled7",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-2soled7",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " BAR，Base Address Register，用来建立Host和Device的沟通通道，IO port或者MMIO。"
				}
			]
		},
		{
			"ID": "20250328014529-u9v19yy",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-u9v19yy",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/29bdc37271b0acc61c4c0e3d8af3e75a.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20250328014529-cv7gj2t",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-cv7gj2t",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 以MMIO为例，首先，我们需要确定设备需要的MMIO地址空间的大小，方法如下:"
				}
			]
		},
		{
			"ID": "20250328014529-j5qssmq",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20250328014529-j5qssmq",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20250328014529-wj9ta3r",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20250328014529-wj9ta3r",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "To determine the amount of address space needed by a PCI device, you must save the original value of the BAR, write a value of all 1's to the register, then read it back. The amount of memory can then be determined by masking the information bits, performing a bitwise NOT ('"
						},
						{
							"Type": "NodeBackslash",
							"Data": "span",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "~"
								}
							]
						},
						{
							"Type": "NodeText",
							"Data": "' in C), and incrementing the value by 1. The original value of the BAR should then be restored. The BAR register is naturally aligned and as such you can only modify the bits that are set. For example, if a device utilizes 16 MB it will have BAR0 filled with 0xFF000000 (0x1000000 after decoding) and you can only modify the upper 8-bits."
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-fhv0khc",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-fhv0khc",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 简单说就是，写个全1到bar里，然后将读出来的值取反加1；"
				}
			]
		},
		{
			"ID": "20250328014529-vz17yi0",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-vz17yi0",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 在确定所需的长度之后，需要设置一段地址进去，这个操作通常由BIOS完成，参考连接，"
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "icon-default.png?t=N7T8"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/003a2ce7eb50c2e24a8c624c260c5930.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://www.linux-mips.org/wiki/PCI_Subsystem#BAR_assignment_in_Linux",
					"TextMarkATitle": "PCI Subsystem - LinuxMIPS",
					"TextMarkTextContent": "https://www.linux-mips.org/wiki/PCI_Subsystem#BAR_assignment_in_LinuxPCI Subsystem - LinuxMIPShttps://www.linux-mips.org/wiki/PCI\\_Subsystem#BAR\\_assignment\\_in\\_Linux"
				}
			]
		},
		{
			"ID": "20250328014529-9i7zk5e",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20250328014529-9i7zk5e",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20250328014529-f4tt067",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20250328014529-f4tt067",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "On all IBM PC-compatible machines, BARs are assigned by the BIOS. Linux simply scans through the buses and records the BAR values."
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-tlf8xwp",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-tlf8xwp",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 参考"
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "strong",
					"TextMarkTextContent": "seabios"
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://github.com/qemu/seabios.git",
					"TextMarkATitle": "https://github.com/qemu/seabios.git",
					"TextMarkTextContent": "https://github.com/qemu/seabios.git"
				},
				{
					"Type": "NodeText",
					"Data": " 代码："
				}
			]
		},
		{
			"ID": "20250328014529-wmyb959",
			"Type": "NodeThematicBreak",
			"Properties": {
				"id": "20250328014529-wmyb959",
				"updated": "20250328014529"
			}
		},
		{
			"ID": "20250328014529-163k8jr",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-163k8jr",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " BIOS设置BAR的地址之后，操作系统在设备初始化的时候，会将相应的地址读出并保存起来，参考代码："
				}
			]
		},
		{
			"ID": "20250328014529-flkhpx6",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-flkhpx6",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 以nvme驱动为例，这些resource的后续处理为："
				}
			]
		},
		{
			"ID": "20250328014529-fh2qb1b",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20250328014529-fh2qb1b",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "Y3Bw"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "nvme_probe()\n  -\u003e nvme_dev_map()\n\t-\u003e pci_request_mem_regions()\n\t  -\u003e pci_request_selected_regions()\n\t    -\u003e __pci_request_region()\n\t      -\u003e __request_mem_region()\n\t        -\u003e __request_region(\u0026iomem_resource, start, n, name, IORESOURCE_EXCLUSIVE)\n  -\u003e nvme_remap_bar()\n\t-\u003e dev-\u003ebar = ioremap(pci_resource_start(pdev, 0), size)\n\n这里映射的是bar 0\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20250328014529-fr46tju",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20250328014529-fr46tju",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "2.3 MSI"
				}
			]
		},
		{
			"ID": "20250328014529-sasauxe",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-sasauxe",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 关于MSI，我在另一边关于中断的blog里做了详解，这里不再赘述，参考"
				}
			]
		},
		{
			"ID": "20250328014529-uq7pf3w",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-uq7pf3w",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "icon-default.png?t=N7T8"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/003a2ce7eb50c2e24a8c624c260c5930.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "http://t.csdn.cn/5tS8c",
					"TextMarkATitle": "Linux 中断处理",
					"TextMarkTextContent": "http://t.csdn.cn/5tS8cLinux 中断处理http://t.csdn.cn/5tS8c"
				}
			]
		},
		{
			"ID": "20250328014529-3t6mgn8",
			"Type": "NodeHeading",
			"HeadingLevel": 2,
			"Properties": {
				"id": "20250328014529-3t6mgn8",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "3 I/O虚拟化(一)"
				}
			]
		},
		{
			"ID": "20250328014529-eq4qnuy",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20250328014529-eq4qnuy",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "3.1 Trap I/O 操作"
				}
			]
		},
		{
			"ID": "20250328014529-5dyj04f",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-5dyj04f",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 当前，CPU访问外设，通过PIO和MMIO两种方式，所以，要完成IO虚拟化，首先需要trap这两种操作；"
				}
			]
		},
		{
			"ID": "20250328014529-61ioqws",
			"Type": "NodeHeading",
			"HeadingLevel": 4,
			"Properties": {
				"id": "20250328014529-61ioqws",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "3.1.1 PIO"
				}
			]
		},
		{
			"ID": "20250328014529-i7scw24",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-i7scw24",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 通过trap对IO Port的IN/OUT指令操作来完成虚拟化；参考Intel SDM 3 24.6.4 I/O-BitmapAddresses ，"
				}
			]
		},
		{
			"ID": "20250328014529-p7ry54c",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-p7ry54c",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " The VM-execution control fields include the 64-bit physical addresses of I/O bitmaps A and B (each of which are 4 KBytes in size). I"
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "u",
					"TextMarkTextContent": "/O bitmap A contains one bit for each I/O port in the range 0000H through 7FFFH; I/O bitmap B contains bits for ports in the range 8000H through FFFFH"
				},
				{
					"Type": "NodeText",
					"Data": "."
				}
			]
		},
		{
			"ID": "20250328014529-75iw5au",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-75iw5au",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " A logical processor uses these bitmaps if and only if the “use I/O bitmaps” control is 1. If the bitmaps are used, "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "u",
					"TextMarkTextContent": "execution of an I/O instruction causes a VM exit if any bit in the I/O bitmaps corresponding to a port it accesses is 1"
				},
				{
					"Type": "NodeText",
					"Data": "."
				}
			]
		},
		{
			"ID": "20250328014529-m6q4t1r",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-m6q4t1r",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 不过现实情况是，"
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "u",
					"TextMarkTextContent": "KVM对所有的IO Port操作都无条件的VM-Exit"
				},
				{
					"Type": "NodeText",
					"Data": "，参考Intel SDM 24.6.2 Processor-Based VM-Execution Control"
				}
			]
		},
		{
			"ID": "20250328014529-eovx09r",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-eovx09r",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/accdb75c580ca6568db98c413c921e86.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20250328014529-nzuools",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-nzuools",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " KVM的配置是："
				}
			]
		},
		{
			"ID": "20250328014529-5fq4if0",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-5fq4if0",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " CPU"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "BASED"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "UNCOND"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "IO"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "EXITING被设置了。"
				}
			]
		},
		{
			"ID": "20250328014529-2f2hzmk",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-2f2hzmk",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " KVM对io exiting的处理流程，参考如下代码："
				}
			]
		},
		{
			"ID": "20250328014529-34codoo",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-34codoo",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 在qemu vcpu thread从内核态返回用户态之后，处理流程如下："
				}
			]
		},
		{
			"ID": "20250328014529-qkb8aj8",
			"Type": "NodeHeading",
			"HeadingLevel": 4,
			"Properties": {
				"id": "20250328014529-qkb8aj8",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "3.1.2 MMIO"
				}
			]
		},
		{
			"ID": "20250328014529-sessy8f",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-sessy8f",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 具体MMIO的拦截方式，可以参考另一篇blog；"
				}
			]
		},
		{
			"ID": "20250328014529-396sm9k",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-396sm9k",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "icon-default.png?t=N7T8"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/003a2ce7eb50c2e24a8c624c260c5930.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "http://t.csdn.cn/wkRGS",
					"TextMarkATitle": "KVM内存虚拟化 MMIO小节",
					"TextMarkTextContent": "http://t.csdn.cn/wkRGSKVM内存虚拟化 MMIO小节http://t.csdn.cn/wkRGS"
				}
			]
		},
		{
			"ID": "20250328014529-41srppk",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-41srppk",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 其处理流程与PIO相似，这里不再赘述"
				}
			]
		},
		{
			"ID": "20250328014529-6mkicy1",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20250328014529-6mkicy1",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "3.2 Emulate I/O"
				}
			]
		},
		{
			"ID": "20250328014529-lwqvo8b",
			"Type": "NodeHeading",
			"HeadingLevel": 2,
			"Properties": {
				"id": "20250328014529-lwqvo8b",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "4 PCI Emulation"
				}
			]
		},
		{
			"ID": "20250328014529-nreddx6",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-nreddx6",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 本小节，我们看下Qemu是如何模拟PCI总线机器设备的。"
				}
			]
		},
		{
			"ID": "20250328014529-c4w9xcm",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-c4w9xcm",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 在此之前，我们先了解下Q35；参考如下连接："
				}
			]
		},
		{
			"ID": "20250328014529-80bpv0r",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-80bpv0r",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "icon-default.png?t=N7T8"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/003a2ce7eb50c2e24a8c624c260c5930.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://www.linux-kvm.org/images/0/06/2012-forum-Q35.pdf",
					"TextMarkATitle": "A New Chipset For Qemu - Intel's Q35",
					"TextMarkTextContent": "https://www.linux-kvm.org/images/0/06/2012-forum-Q35.pdfA New Chipset For Qemu - Intel\u0026apos;s Q35https://www.linux-kvm.org/images/0/06/2012-forum-Q35.pdf"
				}
			]
		},
		{
			"ID": "20250328014529-wfuy5iy",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20250328014529-wfuy5iy",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"ID": "20250328014529-1r5szf6",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-1r5szf6",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-p2vvzia",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-p2vvzia",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "Intel chipset released September 2007"
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-szxd52w",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-szxd52w",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-thdpu20",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-thdpu20",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "North Bridge: MCH"
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-1th8dtu",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-1th8dtu",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-ositygq",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-ositygq",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "South Bridge: ICH9"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-2w04h6y",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-2w04h6y",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 对比古老的I440FX，Q35最重要的就是支持PCIe !"
				}
			]
		},
		{
			"ID": "20250328014529-p8x92wh",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20250328014529-p8x92wh",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "4.1 PCI设备初始化"
				}
			]
		},
		{
			"ID": "20250328014529-4gp4xno",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-4gp4xno",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 下面我们看在Qemu，PCI设备的初始化流程；以下，以nvme为例。"
				}
			]
		},
		{
			"ID": "20250328014529-rt5zy7x",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-rt5zy7x",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 首先，看下PCI设备相关的class和object；"
				}
			]
		},
		{
			"ID": "20250328014529-s8oilzg",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20250328014529-s8oilzg",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "Y3Bw"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "DeviceClass\n      |\nPCIDeviceClass\n      |\n\t ...\nBut nvme_class_init() would overwrite PCIDeviceClass's some callback and fields\n\nDeviceState\n   |\nPCIDevice\n   |\nNvmeCtrl\n\nclass's class_init and object's instance_init cannot be overwritten by\nchildren\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20250328014529-axndv7x",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-axndv7x",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 需要注意的是，在pci"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "qdev"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "init中，调用do"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "pci"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "register"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "device()之后，还调用了PCIDeviceClass的init函数；这个 函数在nvme"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "class"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "init()中，被重载成了nvme"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "init；"
				}
			]
		},
		{
			"ID": "20250328014529-1sechvu",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-1sechvu",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 在nvme"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "init()中，它使用的部分参数来自property的解析，参考以下配置："
				}
			]
		},
		{
			"ID": "20250328014529-42dqbn0",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20250328014529-42dqbn0",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "Y3Bw"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "-drive file=nvm.img,if=none,id=nvm\n-device nvme,serial=deadbeef,drive=nvm\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20250328014529-4ggesic",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-4ggesic",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " property的解析参考"
				}
			]
		},
		{
			"ID": "20250328014529-rnuxdse",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-rnuxdse",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "icon-default.png?t=N7T8"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/003a2ce7eb50c2e24a8c624c260c5930.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "http://t.csdn.cn/YTWMN",
					"TextMarkATitle": "QEMU代码详解",
					"TextMarkTextContent": "http://t.csdn.cn/YTWMNQEMU代码详解http://t.csdn.cn/YTWMN"
				},
				{
					"Type": "NodeText",
					"Data": "另外，nvme"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "init()还注册了bar的处理函数，参考代码："
				}
			]
		},
		{
			"ID": "20250328014529-85ky9l1",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20250328014529-85ky9l1",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "4.2 PCI Configuration Space"
				}
			]
		},
		{
			"ID": "20250328014529-kzjydqm",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-kzjydqm",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 在本篇的2.2小节，我们应详细介绍过PCI Configuration Space，这里我们看下QEMU如果模拟其行为。"
				}
			]
		},
		{
			"ID": "20250328014529-vsy83pg",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-vsy83pg",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 我们以支持PCIe的Q35为例，"
				}
			]
		},
		{
			"ID": "20250328014529-lamxpai",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20250328014529-lamxpai",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "4.3 PCI Bar"
				}
			]
		},
		{
			"ID": "20250328014529-autesv3",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-autesv3",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 在nvme"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "init()中，只是初始化了bar所对应的MemoryRegion，真正把它注册进Qemu的MMIO address space，是在向Bar中写入地址的时候，参考代码："
				}
			]
		},
		{
			"ID": "20250328014529-73sfaq8",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-73sfaq8",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " memory"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "region"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "add"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "subregion"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "overlap()，会通知到address"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "space"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "memory，参考以下连接："
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "icon-default.png?t=N7T8"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/003a2ce7eb50c2e24a8c624c260c5930.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "http://t.csdn.cn/YTWMN",
					"TextMarkATitle": "QEMU代码详解 3.2 Listeners",
					"TextMarkTextContent": "http://t.csdn.cn/YTWMNQEMU代码详解 3.2 Listenershttp://t.csdn.cn/YTWMN"
				}
			]
		},
		{
			"ID": "20250328014529-aohrk88",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-aohrk88",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " nvme的bar的在qemu端的处理代码，这里我们也大概看下："
				}
			]
		},
		{
			"ID": "20250328014529-wnr2pop",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-wnr2pop",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " BAR size的确定是通过向其中写入全1，然后取反加1，那么，QEMU的PCI的模拟代码是怎么做的？"
				}
			]
		},
		{
			"ID": "20250328014529-d8c4got",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20250328014529-d8c4got",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "4.4 MSI-X"
				}
			]
		},
		{
			"ID": "20250328014529-k2calf5",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-k2calf5",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 因为参考的是nvme的实现，所以，这里我们主要看下MSI-X的实现；MSI-X可以参照"
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "icon-default.png?t=N7T8"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/003a2ce7eb50c2e24a8c624c260c5930.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "http://t.csdn.cn/WwWJK",
					"TextMarkATitle": "Linux 中断处理  1.3 MSI",
					"TextMarkTextContent": "http://t.csdn.cn/WwWJKLinux 中断处理 1.3 MSIhttp://t.csdn.cn/WwWJK"
				}
			]
		},
		{
			"ID": "20250328014529-lke6adz",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-lke6adz",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " MSI-X在PCIE Capability list中保存的是MSI-X table和PBA的BAR的index和BAR指向内存内的偏移；"
				}
			]
		},
		{
			"ID": "20250328014529-p8rhade",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-p8rhade",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/c7de4f1f54f416b23c869861d0eedb1f.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20250328014529-2uypmek",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-2uypmek",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " PCIE驱动需要通过Capability list获取该设备的MSI-X的Table和PBA的对应的BAR；在QEMU端，对应的代码为："
				}
			]
		},
		{
			"ID": "20250328014529-mxzrsph",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-mxzrsph",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 这个BAR的size是4K，其中MSI-X Table和PBA各一半。"
				}
			]
		},
		{
			"ID": "20250328014529-4ggedbz",
			"Type": "NodeThematicBreak",
			"Properties": {
				"id": "20250328014529-4ggedbz",
				"updated": "20250328014529"
			}
		},
		{
			"ID": "20250328014529-9vzzojp",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-9vzzojp",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " MSI-X的中断在设备端的发出，是通过以下函数："
				}
			]
		},
		{
			"ID": "20250328014529-31dck7g",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-31dck7g",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 上面的代码的vector并不是x86 cpu的irq vector，这个信息保存在message.data中；此处的cq-"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "\u003e"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "vector，是在创建Completion queue时传入，参考Host端nvme驱动代码，cq-"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "\u003e"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "vector其实就是qid："
				}
			]
		},
		{
			"ID": "20250328014529-394wdja",
			"Type": "NodeThematicBreak",
			"Properties": {
				"id": "20250328014529-394wdja",
				"updated": "20250328014529"
			}
		},
		{
			"ID": "20250328014529-yumnq75",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-yumnq75",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 在msix"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "notify()中， 它使用了"
				}
			]
		},
		{
			"ID": "20250328014529-mi4u0i7",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20250328014529-mi4u0i7",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "Y3Bw"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "stl_le_phys(\u0026address_space_memory, msg.address, msg.data)\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20250328014529-s0gjckq",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-s0gjckq",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " MSI的address实际上对应的是local APIC的一个地址，我们看下QEMU是如何模拟这部分的。"
				}
			]
		},
		{
			"ID": "20250328014529-n9hrtuz",
			"Type": "NodeHeading",
			"HeadingLevel": 2,
			"Properties": {
				"id": "20250328014529-n9hrtuz",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "5 VirtIO"
				}
			]
		},
		{
			"ID": "20250328014529-g7jj2ml",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20250328014529-g7jj2ml",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "5.1 Virtio基础"
				}
			]
		},
		{
			"ID": "20250328014529-ku8paz6",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-ku8paz6",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 参考连接"
				}
			]
		},
		{
			"ID": "20250328014529-f0qtcv7",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-f0qtcv7",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "icon-default.png?t=N7T8"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/003a2ce7eb50c2e24a8c624c260c5930.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://www.cs.cmu.edu/~412/lectures/Virtio_2015-10-14.pdf",
					"TextMarkATitle": "Virtio: An I/O virtualization framework for Linux",
					"TextMarkTextContent": "https://www.cs.cmu.edu/~412/lectures/Virtio_2015-10-14.pdfVirtio: An I/O virtualization framework for Linuxhttps://www.cs.cmu.edu/\\~412/lectures/Virtio\\_2015-10-14.pdf"
				},
				{
					"Type": "NodeText",
					"Data": "初步了解VirtioIO；"
				}
			]
		},
		{
			"ID": "20250328014529-xumgsbq",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-xumgsbq",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " Virtio是用于实现GuestOS和VMM之间的半虚拟化设备的通信"
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "strong",
					"TextMarkTextContent": "接口标准，其中包括了数据格式和操作方式；"
				}
			]
		},
		{
			"ID": "20250328014529-ffsimon",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-ffsimon",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/a95a38202349691d2d4fc1bb2f11a485.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20250328014529-pq6s94r",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-pq6s94r",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 具体的实现方式，连接"
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "icon-default.png?t=N7T8"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/003a2ce7eb50c2e24a8c624c260c5930.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://www.redhat.com/en/blog/virtqueues-and-virtio-ring-how-data-travels",
					"TextMarkATitle": "Virtqueues and virtio ring: How the data travels",
					"TextMarkTextContent": "https://www.redhat.com/en/blog/virtqueues-and-virtio-ring-how-data-travelsVirtqueues and virtio ring: How the data travelsThis post continues where the \u0026quot;Virtio devices and drivers overview\u0026quot; leaves off. After we have explained the scenario in the previous post, we are reaching the main point: how does the data travel from the virtio-device to the driver and back?https://www.redhat.com/en/blog/virtqueues-and-virtio-ring-how-data-travels"
				},
				{
					"Type": "NodeText",
					"Data": "中做了非常详细的说明；我们看下virtioqueue的核心数据结构和工作方式："
				}
			]
		},
		{
			"ID": "20250328014529-8jva7rf",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-8jva7rf",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/43b99f42d687be118770db5be033a104.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20250328014529-3aa4o6n",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20250328014529-3aa4o6n",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"ID": "20250328014529-dbfl8sh",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-dbfl8sh",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-vdw9enm",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-vdw9enm",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "以下，我们把Guest OS的virtio的driver端简称driver，把VMM的设备模拟软件称为device"
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-72jqaf7",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-72jqaf7",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-wepr7jb",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-wepr7jb",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "virtq"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "vail、virtq"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "used和virtq"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "desc[]所占用的内存，均由Driver提供，Device通过地址转换得到其可以访问的地址；"
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-7i0035x",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-7i0035x",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-vq453a8",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-vq453a8",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "virtq"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "avail的idx代表下一个空闲的slot，只能由Driver更新，virtq"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "avail.ring[]中小于idx的slot中，就是可以给Device端消费的virtq"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "desc；virtq"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "desc中包含的是给Device操作的内存；"
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-vdqxc8s",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-vdqxc8s",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-h72tm8y",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-h72tm8y",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "virtq"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "used的idx代表下一个空闲的slot，只能由Device更新，virtq"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "used.ring[]中小于idx的slot中，就是可以给Driver消费的virtq"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "used"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "elem，virtq"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "used"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "elem.idx代表完成的操作所对应的virtq"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "desc；"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-op8w8rd",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-op8w8rd",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 如上，virtio其实只是规范了GuestOS和VMM之间的​"
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "strong",
					"TextMarkTextContent": "通信的语法"
				},
				{
					"Type": "NodeText",
					"Data": "​，但是真正的通道的建立不同的平台实现方式不同；接下来，我们看下QEMU + KVM + Linux上的实现。"
				}
			]
		},
		{
			"ID": "20250328014529-2jehmyf",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-2jehmyf",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 除了virtqueue的layout和操作方式，virtio spec还规定了virtio-pci以及virtio-net、virtio-blk等各种设备类型的细节，参考连接"
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "icon-default.png?t=N7T8"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/003a2ce7eb50c2e24a8c624c260c5930.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://docs.oasis-open.org/virtio/virtio/v1.1/csprd01/virtio-v1.1-csprd01.pdf",
					"TextMarkATitle": "Virtual I/O Device (VIRTIO) Version 1.1",
					"TextMarkTextContent": "https://docs.oasis-open.org/virtio/virtio/v1.1/csprd01/virtio-v1.1-csprd01.pdfVirtual I/O Device (VIRTIO) Version 1.1https://docs.oasis-open.org/virtio/virtio/v1.1/csprd01/virtio-v1.1-csprd01.pdf"
				}
			]
		},
		{
			"ID": "20250328014529-2onyuwv",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20250328014529-2onyuwv",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "5.2 VirtIO in Qemu"
				}
			]
		},
		{
			"ID": "20250328014529-kzyqol2",
			"Type": "NodeHeading",
			"HeadingLevel": 4,
			"Properties": {
				"id": "20250328014529-kzyqol2",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "5.2.1 框架"
				}
			]
		},
		{
			"ID": "20250328014529-7nbqaxm",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-7nbqaxm",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " Qemu中VirtIO的的主要Object和Class如下："
				}
			]
		},
		{
			"ID": "20250328014529-9va5r7q",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-9va5r7q",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/486cdc91ddc931644a05c87016202fb1.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20250328014529-sco7kqv",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-sco7kqv",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 上图中，竖线代表继承，横线代表包含；"
				}
			]
		},
		{
			"ID": "20250328014529-8y837vb",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20250328014529-8y837vb",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"ID": "20250328014529-k2up3nt",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-k2up3nt",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-ktsanut",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-ktsanut",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "Frontend，virtio在QEMU中以一个PCI设备的形式呈现，Frontend部分负责与QEMU PCI子系统对接；"
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-putvm69",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-putvm69",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-f8w1oxg",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-f8w1oxg",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "BUS，用于对接Frontend和Backend；VirtIODevice的操作，会调用到VirtIOBusState的回调；QEMU使用PCI实现了一套VirtIOBusState的回调"
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-3uduep5",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-3uduep5",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-w58b9hl",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-w58b9hl",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "Backend，设备后端具体实现；"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-4zg02ej",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-4zg02ej",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 接下来，我们还是以VirtIOBlkPCI为例，看下Virtio的具体初始化过程；初始化过程分为两条线，即："
				}
			]
		},
		{
			"ID": "20250328014529-nbn6m9w",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20250328014529-nbn6m9w",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"ID": "20250328014529-2mftg1a",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-2mftg1a",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-54ucy9a",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-54ucy9a",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "object"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "new()线，用于初始化数据结构，主要是从上parent到child调用class"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "init和instance"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "init回调；参考代码："
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-9osaczv",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-9osaczv",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-vywzmx5",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-vywzmx5",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "set realize线，用于开启设备，主要调用realize()回调；但是，在QEMU pci子系统中，在PCIDeviceClass这一层，被转换成了init函数；参考函数："
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-jlftfdw",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-jlftfdw",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " virtio"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "device"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "realize()很好的体现了QEMU中PCI和Virtio的关系，"
				}
			]
		},
		{
			"ID": "20250328014529-34wqdme",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20250328014529-34wqdme",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"ID": "20250328014529-imtyzsc",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-imtyzsc",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-f7kiki0",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-f7kiki0",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "PCI子系统通过VritioDeviceClass的回调进入后端，另外一个例子还可以参考get"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "config回调，"
								}
							]
						},
						{
							"ID": "20250328014529-htdrgk0",
							"Type": "NodeCodeBlock",
							"IsFencedCodeBlock": true,
							"Properties": {
								"id": "20250328014529-htdrgk0",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeCodeBlockFenceOpenMarker",
									"Data": "```"
								},
								{
									"Type": "NodeCodeBlockFenceInfoMarker",
									"CodeBlockInfo": "Y3Bw"
								},
								{
									"Type": "NodeCodeBlockCode",
									"Data": "virtio_pci_config_read()\n  -\u003e virtio_config_readb()\n\t ---\n    VirtioDeviceClass *k = VIRTIO_DEVICE_GET_CLASS(vdev);\n\t...\n    k-\u003eget_config(vdev, vdev-\u003econfig);\n\t ---\n"
								},
								{
									"Type": "NodeCodeBlockFenceCloseMarker",
									"Data": "```"
								}
							]
						},
						{
							"ID": "20250328014529-s5mpzn6",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-s5mpzn6",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "VirtioDeviceClass的回调的重载由virtio"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "blk"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "class"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "init()完成；"
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-fcq7gq5",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-fcq7gq5",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-i9g2m7n",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-i9g2m7n",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "Virtio 后端则通过virtio-bus调用PCI前端的功能，参考"
								}
							]
						},
						{
							"ID": "20250328014529-m4f4fnu",
							"Type": "NodeCodeBlock",
							"IsFencedCodeBlock": true,
							"Properties": {
								"id": "20250328014529-m4f4fnu",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeCodeBlockFenceOpenMarker",
									"Data": "```"
								},
								{
									"Type": "NodeCodeBlockFenceInfoMarker",
									"CodeBlockInfo": "Y3Bw"
								},
								{
									"Type": "NodeCodeBlockCode",
									"Data": "virtio_blk_req_complete()\n  -\u003e virtio_notify()\n\t-\u003e virtio_notify_vector()\n\t   ---\n\t    VirtioBusClass *k = VIRTIO_BUS_GET_CLASS(qbus);\n\n\t    if (k-\u003enotify) {\n    \t    k-\u003enotify(qbus-\u003eparent, vector);\n   \t\t }\n\t   ---\n\t   -\u003e virtio_pci_notify()\n\t     -\u003e msix_notify()\n"
								},
								{
									"Type": "NodeCodeBlockFenceCloseMarker",
									"Data": "```"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-kdfqwgl",
			"Type": "NodeHeading",
			"HeadingLevel": 4,
			"Properties": {
				"id": "20250328014529-kdfqwgl",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "5.2.2 virtio queue"
				}
			]
		},
		{
			"ID": "20250328014529-nxx3qj2",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-nxx3qj2",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " virtio的queue是在QEMU中设置和工作的？"
				}
			]
		},
		{
			"ID": "20250328014529-2d32inm",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-2d32inm",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 首先看下virtio-pci设备的realize，"
				}
			]
		},
		{
			"ID": "20250328014529-to6jayw",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20250328014529-to6jayw",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "Y3Bw"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "virtio_device_realize()\n  -\u003e virtio_bus_device_plugged(vdev);\n    -\u003e virtio_pci_device_plugged()\n    ---\n        VirtIOPCIProxy *proxy = VIRTIO_PCI(d);\n\t    ...\n        proxy-\u003epci_dev.config_write = virtio_write_config;\n\t    ...\n        memory_region_init_io(\u0026proxy-\u003ebar, OBJECT(proxy), \u0026virtio_pci_config_ops,\n                          proxy, \"virtio-pci\", size);\n        pci_register_bar(\u0026proxy-\u003epci_dev, 0, PCI_BASE_ADDRESS_SPACE_IO, \n                \u0026proxy-\u003ebar);\n    ---\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20250328014529-7nvis65",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-7nvis65",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 其ioport操作函数中包含了三条与virtio queue有关的命令，"
				}
			]
		},
		{
			"ID": "20250328014529-w2sptf7",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-w2sptf7",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " virtio的地址来自Guest OS的物理地址，QEMU如何访问这个地址呢？参考代码："
				}
			]
		},
		{
			"ID": "20250328014529-sidi191",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-sidi191",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 在Guest OS端的virtioqueue的初始化代码，如下："
				}
			]
		},
		{
			"ID": "20250328014529-xvan6ci",
			"Type": "NodeThematicBreak",
			"Properties": {
				"id": "20250328014529-xvan6ci",
				"updated": "20250328014529"
			}
		},
		{
			"ID": "20250328014529-ysm6qaa",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-ysm6qaa",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 当Guest OS更新完virtioqueue之后，需要notify backend，或者说QEMU端，也就是VIRTIO"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "PCI"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "QUEUE"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "NOTIFY；参考代码："
				}
			]
		},
		{
			"ID": "20250328014529-yegh7x3",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20250328014529-yegh7x3",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "Y3Bw"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "virtio_queue_notify()\n  -\u003e virtio_queue_notify_vq()\n\t---\n\t    if (vq-\u003evring.desc) {\n       \t\tVirtIODevice *vdev = vq-\u003evdev;\n        \tvq-\u003ehandle_output(vdev, vq);\n    \t}\n\t---\n\nvirtio_blk_handle_output()\n  -\u003e virtio_blk_handle_request()\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20250328014529-m9yskej",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-m9yskej",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 在Guest OS端的代码为："
				}
			]
		},
		{
			"ID": "20250328014529-61q6y48",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20250328014529-61q6y48",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "Y3Bw"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "virtqueue_notify()\n  -\u003e vq-\u003enotify()\n    -\u003e vp_notify()\n\t   ---\n\t\tiowrite16(vq-\u003eindex, (void __iomem *)vq-\u003epriv);\n\t   ---\n\nvq-\u003epriv的设置在\nsetup_vq()\n---\n    vq-\u003epriv = (void __force *)vp_dev-\u003eioaddr + VIRTIO_PCI_QUEUE_NOTIFY;\n---\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20250328014529-dzs8vy9",
			"Type": "NodeHeading",
			"HeadingLevel": 4,
			"Properties": {
				"id": "20250328014529-dzs8vy9",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "5.2.3 vring工作方式"
				}
			]
		},
		{
			"ID": "20250328014529-cfr7wh4",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-cfr7wh4",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 参考下图："
				}
			]
		},
		{
			"ID": "20250328014529-gx8u4lm",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-gx8u4lm",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/36e4d3cf7024eb25843201d863728e3e.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20250328014529-iqr7foz",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-iqr7foz",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 套用RDMA和NVMe中的队列名称更加贴切；virtq"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "avail可以称为SQ，即submit queue，virtq"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "used则可以称为CQ，即complete queue。上图中，有以下几条信息："
				}
			]
		},
		{
			"ID": "20250328014529-zn403vk",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20250328014529-zn403vk",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"ID": "20250328014529-2lk16j5",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-2lk16j5",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-9d45dm5",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-9d45dm5",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "紫色的是由Qemu或者Vhost端更新维护；而绿色，则是由GuestOS的驱动更新维护。"
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-rvep4ba",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-rvep4ba",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-nljpnx3",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-nljpnx3",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "SQ的idx的更新，是在GuestOS发出请求时，参考block存储设备发出IO请求；而CQ的idx的更新则是由Qemu或者Vhost端更新，参考其完成IO请求，将IO结构信息返回给GuestOS；"
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-qhnwn8n",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-qhnwn8n",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-mko61qd",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-mko61qd",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "virtqueue中只维护了ring head，那ring tail呢？参考上图中的last"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "avail"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "idx和last"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "used"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "idx，"
								}
							]
						},
						{
							"ID": "20250328014529-8y3d4uo",
							"Type": "NodeList",
							"ListData": {},
							"Properties": {
								"id": "20250328014529-8y3d4uo",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"ID": "20250328014529-5jce2py",
									"Type": "NodeListItem",
									"ListData": {
										"BulletChar": 42,
										"Marker": "Kg=="
									},
									"Properties": {
										"id": "20250328014529-5jce2py",
										"updated": "20250328014529"
									},
									"Children": [
										{
											"ID": "20250328014529-ehj3ys0",
											"Type": "NodeParagraph",
											"Properties": {
												"id": "20250328014529-ehj3ys0",
												"updated": "20250328014529"
											},
											"Children": [
												{
													"Type": "NodeText",
													"Data": "last"
												},
												{
													"Type": "NodeBackslash",
													"Data": "span",
													"Children": [
														{
															"Type": "NodeText",
															"Data": "_"
														}
													]
												},
												{
													"Type": "NodeText",
													"Data": "avail"
												},
												{
													"Type": "NodeBackslash",
													"Data": "span",
													"Children": [
														{
															"Type": "NodeText",
															"Data": "_"
														}
													]
												},
												{
													"Type": "NodeText",
													"Data": "idx就是SQ的ring tail，它由Qemu或者Vhost在本地维护；"
												}
											]
										}
									]
								},
								{
									"ID": "20250328014529-gsy3664",
									"Type": "NodeListItem",
									"ListData": {
										"BulletChar": 42,
										"Marker": "Kg=="
									},
									"Properties": {
										"id": "20250328014529-gsy3664",
										"updated": "20250328014529"
									},
									"Children": [
										{
											"ID": "20250328014529-xb28yhx",
											"Type": "NodeParagraph",
											"Properties": {
												"id": "20250328014529-xb28yhx",
												"updated": "20250328014529"
											},
											"Children": [
												{
													"Type": "NodeText",
													"Data": "last"
												},
												{
													"Type": "NodeBackslash",
													"Data": "span",
													"Children": [
														{
															"Type": "NodeText",
															"Data": "_"
														}
													]
												},
												{
													"Type": "NodeText",
													"Data": "used"
												},
												{
													"Type": "NodeBackslash",
													"Data": "span",
													"Children": [
														{
															"Type": "NodeText",
															"Data": "_"
														}
													]
												},
												{
													"Type": "NodeText",
													"Data": "idx是CQ的ring tail，它由GuestOS驱动在本地维护"
												}
											]
										}
									]
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-ro14fuh",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-ro14fuh",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-7nr0yov",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-7nr0yov",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "如果ring tail都有对端维护，那在更新ring head时，如何保证不会发生over-write？这个问题由GuestOS的驱动保证，它通过SQ发出的请求，不会超过ring的长度；例如virtio-blk的ring length就体现为其block request queue的长度。"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-k3dgbtp",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-k3dgbtp",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 以下是qemu中操作vring的代码："
				}
			]
		},
		{
			"ID": "20250328014529-zi4ftux",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20250328014529-zi4ftux",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "Y3Bw"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "virtqueue_pop()\n  -\u003e virtqueue_split_pop()\n\t ---\n\t    if (!virtqueue_get_head(vq, vq-\u003elast_avail_idx++, \u0026head)) {\n\t        goto done;\n\t    }\n\t\t...\n\t    caches = vring_get_region_caches(vq);\n\t\t...\n\t    desc_cache = \u0026caches-\u003edesc;\n\t    vring_split_desc_read(vdev, \u0026desc, desc_cache, i);\n\t\t...\n    \tvq-\u003einuse++;\n\t ---\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20250328014529-9cyeroy",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20250328014529-9cyeroy",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "5.3 vhost"
				}
			]
		},
		{
			"ID": "20250328014529-0ogcuct",
			"Type": "NodeHeading",
			"HeadingLevel": 4,
			"Properties": {
				"id": "20250328014529-0ogcuct",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "5.3.1 目的"
				}
			]
		},
		{
			"ID": "20250328014529-nvxdso6",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-nvxdso6",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 为什么需要引入vhost ？可参考链接："
				}
			]
		},
		{
			"ID": "20250328014529-9f5up7q",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-9f5up7q",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "icon-default.png?t=N7T8"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/003a2ce7eb50c2e24a8c624c260c5930.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://www.redhat.com/en/blog/deep-dive-virtio-networking-and-vhost-net",
					"TextMarkATitle": "Deep dive into Virtio-networking and vhost-net",
					"TextMarkTextContent": "https://www.redhat.com/en/blog/deep-dive-virtio-networking-and-vhost-netDeep dive into Virtio-networking and vhost-netIn this post we will explain the vhost-net architecture described in the solution overview (link), to make it clear how everything works together from a technical point of view. This is part of the series of blogs that introduces you to the realm of virtio-networking which brings together the world of virtualization and the world of networking.https://www.redhat.com/en/blog/deep-dive-virtio-networking-and-vhost-net"
				}
			]
		},
		{
			"ID": "20250328014529-6rxu285",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-6rxu285",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/f051de54f173aa6268e964817c553dfe.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20250328014529-53bbenb",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-53bbenb",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 原virtio方案有以下问题："
				}
			]
		},
		{
			"ID": "20250328014529-sqjq8yv",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20250328014529-sqjq8yv",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"ID": "20250328014529-k1b8ygl",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-k1b8ygl",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-r266jee",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-r266jee",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "After the virtio driver sends an Available Buffer Notification, the vCPU stops running and control is returned to the hypervisor causing an expensive context switch."
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-8581tfa",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-8581tfa",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-sa0j9z0",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-sa0j9z0",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "QEMU additional tasks/threads synchronization mechanisms."
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-nssgdnw",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-nssgdnw",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-gyctaia",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-gyctaia",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "The syscall and the data copy for each packet to actually send or receive it via tap (no batching)."
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-sr965k3",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-sr965k3",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-qam5e4l",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-qam5e4l",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "The ioctl to send the available buffer notification (vCPU interruption)."
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-6gbckrh",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-6gbckrh",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-6rq1l9g",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-6rq1l9g",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "We also need to add another syscall to resume vCPU execution, with all the associated mapping switching, etc."
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-4dvyaqs",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-4dvyaqs",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " vhost方案将virtio的主要工作负载offload到内核态，如下："
				}
			]
		},
		{
			"ID": "20250328014529-3nm4f7e",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-3nm4f7e",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/8d99c46484a0da0fe924e99944f44a28.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20250328014529-qd99mas",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-qd99mas",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 要实现vhost的offload，主要有两件事要做："
				}
			]
		},
		{
			"ID": "20250328014529-694lnj0",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20250328014529-694lnj0",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"ID": "20250328014529-jfebpov",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-jfebpov",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-abm2erw",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-abm2erw",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "建立起vhost与kvm之间的沟通机制，这个我们在下一小节中详解"
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-6njtn2n",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-6njtn2n",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-vj7m2is",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-vj7m2is",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "vhost必须可以向QEMU那样访问vring及其其中的desc对应Guest OS传入的buffer"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-lzqkgpd",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-lzqkgpd",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " vhost可以访问Guest OS的buffer，需要借助VHOST"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "SET"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "MEM"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "TABLE ioctl，建立起一个guest physical address和qemu userspace addr的mapping，参考代码："
				}
			]
		},
		{
			"ID": "20250328014529-e3wk6om",
			"Type": "NodeHeading",
			"HeadingLevel": 4,
			"Properties": {
				"id": "20250328014529-e3wk6om",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "5.3.2 evnetfd"
				}
			]
		},
		{
			"ID": "20250328014529-n1owm5p",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-n1owm5p",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " eventfd是一种事件通知机制，它有专门的系统调用，支持poll操作，代码在fs/eventfd.c，比较简单，这里不做深入。"
				}
			]
		},
		{
			"ID": "20250328014529-ibxkd4q",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-ibxkd4q",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " vhost机制中，kvm和vhost之间的通信是通过eventfd建立起来的，它有两个方向："
				}
			]
		},
		{
			"ID": "20250328014529-8006n23",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20250328014529-8006n23",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"ID": "20250328014529-0lwfe5s",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-0lwfe5s",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-y2v6vqr",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-y2v6vqr",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "irqfd，用于vhost向kvm发送中断；QEMU通过KVM"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "IRQFD创建一个可以发送中断的eventfd，然后通过VHOST"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "SET"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "VRING"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "CALL将该eventfd告诉vhost；"
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-lsrcwbp",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-lsrcwbp",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-g2hev2y",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-g2hev2y",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "ioeventfd，用于kvm拦截pio/mmio write，然后通知vhost；QEMU通过KVM"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "IOEVENTFD将eventfd和pio/mmio的address space联系起来，然后通过VHOST"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "SET"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "VRING"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "KICK将该eventfd告诉vhost；"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-jovjsb9",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-jovjsb9",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " ioeventfd，用于Guest OS通知vhost；QEMU virtio可以给一段pio/mmio mr指定eventfd，参考如下代码："
				}
			]
		},
		{
			"ID": "20250328014529-zcb8l3i",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-zcb8l3i",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 从代码中可以看到，这个过程并没有避免vm-exit，只是避免了内核态和用户态的两次转换；"
				}
			]
		},
		{
			"ID": "20250328014529-p707fwm",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-p707fwm",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 当Guest OS的virtio driver写对应的mmio/pio之后，会调用对应的eventfd的singal操作；"
				}
			]
		},
		{
			"ID": "20250328014529-w58xca5",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-w58xca5",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " vhost对这个eventfd做了以下处理："
				}
			]
		},
		{
			"ID": "20250328014529-fmmlhy4",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-fmmlhy4",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 所以，这个ioeventfd被signal之后，最终会唤醒vhost"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "worker，这个是vhost的处理线程。"
				}
			]
		},
		{
			"ID": "20250328014529-103nusr",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20250328014529-103nusr",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20250328014529-5uwkgdj",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20250328014529-5uwkgdj",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "注：vhost"
						},
						{
							"Type": "NodeBackslash",
							"Data": "span",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "_"
								}
							]
						},
						{
							"Type": "NodeText",
							"Data": "poll"
						},
						{
							"Type": "NodeBackslash",
							"Data": "span",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "_"
								}
							]
						},
						{
							"Type": "NodeText",
							"Data": "wakeup()并没有主动把wait"
						},
						{
							"Type": "NodeBackslash",
							"Data": "span",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "_"
								}
							]
						},
						{
							"Type": "NodeText",
							"Data": "queue"
						},
						{
							"Type": "NodeBackslash",
							"Data": "span",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "_"
								}
							]
						},
						{
							"Type": "NodeText",
							"Data": "entry从wait"
						},
						{
							"Type": "NodeBackslash",
							"Data": "span",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "_"
								}
							]
						},
						{
							"Type": "NodeText",
							"Data": "queue"
						},
						{
							"Type": "NodeBackslash",
							"Data": "span",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "_"
								}
							]
						},
						{
							"Type": "NodeText",
							"Data": "head中删除；这个删除并不是wake"
						},
						{
							"Type": "NodeBackslash",
							"Data": "span",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "_"
								}
							]
						},
						{
							"Type": "NodeText",
							"Data": "up的默认流程，具体可以参考autoremove"
						},
						{
							"Type": "NodeBackslash",
							"Data": "span",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "_"
								}
							]
						},
						{
							"Type": "NodeText",
							"Data": "wake"
						},
						{
							"Type": "NodeBackslash",
							"Data": "span",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "_"
								}
							]
						},
						{
							"Type": "NodeText",
							"Data": "function()"
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-y3nhj53",
			"Type": "NodeThematicBreak",
			"Properties": {
				"id": "20250328014529-y3nhj53",
				"updated": "20250328014529"
			}
		},
		{
			"ID": "20250328014529-9fgaqn5",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-9fgaqn5",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " irqfd也是一个eventfd，vhost用它来给kvm注入中断，代码参考："
				}
			]
		},
		{
			"ID": "20250328014529-usdzce3",
			"Type": "NodeHeading",
			"HeadingLevel": 2,
			"Properties": {
				"id": "20250328014529-usdzce3",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "6 Passthrough"
				}
			]
		},
		{
			"ID": "20250328014529-zbnmb3h",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-zbnmb3h",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 也称Direct Device Assignment，对比之前的Full-Virtualization和Para-Virtualization，这是性能\n最好的一种，实现设备的高效直通需要硬件支持，以下内容，参考了连接"
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "icon-default.png?t=N7T8"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/003a2ce7eb50c2e24a8c624c260c5930.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://compas.cs.stonybrook.edu/~nhonarmand/courses/sp17/cse506/slides/hw_io_virtualization.pdf",
					"TextMarkATitle": "I/O Virtualization with Hardware Support",
					"TextMarkTextContent": "https://compas.cs.stonybrook.edu/~nhonarmand/courses/sp17/cse506/slides/hw_io_virtualization.pdfI/O Virtualization with Hardware Supporthttps://compas.cs.stonybrook.edu/\\~nhonarmand/courses/sp17/cse506/slides/hw\\_io\\_virtualization.pdf"
				}
			]
		},
		{
			"ID": "20250328014529-25p9g9b",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-25p9g9b",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 其中为实现设备直通技术提供了很好的大纲；"
				}
			]
		},
		{
			"ID": "20250328014529-ez6wqgn",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20250328014529-ez6wqgn",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"ID": "20250328014529-ibj5r3e",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-ibj5r3e",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-81wdxpd",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-81wdxpd",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "IOMMU allows for security and isolation；安全性和隔离性是虚拟化最重要的两个准则，Guest OS的任何行为都不能影响在同一个Host上的其他Guest；设备直通给了Guest OS直接访问设备的能力，它可以任意编写驱动，IOMMU可以限制Guest OS的设备驱动的权限；"
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-dyrfovs",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-dyrfovs",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-7fxvuho",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-7fxvuho",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "SRIOV allows for scalability"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-lv8hfkn",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-lv8hfkn",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 另外还有实现直通的软件空间VFIO；本节，我们将依次研究。"
				}
			]
		},
		{
			"ID": "20250328014529-10y0tec",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20250328014529-10y0tec",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "6.1 IOMMU"
				}
			]
		},
		{
			"ID": "20250328014529-eb06h43",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-eb06h43",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " IO MMU由Intel的VT-d技术提供(或者其他厂商的虚拟化拓展技术)，包括了两个方面："
				}
			]
		},
		{
			"ID": "20250328014529-8oyyvn7",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20250328014529-8oyyvn7",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"ID": "20250328014529-zwwc2aw",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-zwwc2aw",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-5fsoa6d",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-5fsoa6d",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "DMA Remapping (DMAR)"
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-5fy6l7o",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-5fy6l7o",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-73t6adj",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-73t6adj",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "Interrupt Remapping (IR)"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-6b471pd",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-6b471pd",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 其中IR在IO直通这里并不是为了提高性能，主要是为了隔离性和安全性；参考链接："
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "icon-default.png?t=N7T8"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/003a2ce7eb50c2e24a8c624c260c5930.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://www.spinics.net/lists/kvm/msg62976.html",
					"TextMarkATitle": "Re: What's the usage model (purpose) of interrupt remapping in IOMMU? — Linux KVM",
					"TextMarkTextContent": "https://www.spinics.net/lists/kvm/msg62976.htmlRe: What\u0026apos;s the usage model (purpose) of interrupt remapping in IOMMU? — Linux KVMLinux KVM: Re: What\u0026apos;s the usage model (purpose) of interrupt remapping in IOMMU?https://www.spinics.net/lists/kvm/msg62976.html"
				}
			]
		},
		{
			"ID": "20250328014529-qat38kz",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20250328014529-qat38kz",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20250328014529-35qggkl",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20250328014529-35qggkl",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "The hypervisor being able to direct interrupts to a target CPU also allows it the ability to filter interrupts and prevent the device from signaling spurious or malicious interrupts."
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-prmdpeq",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-prmdpeq",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " DMA Remapping的目的也基本类似，参考接下来两个小节。"
				}
			]
		},
		{
			"ID": "20250328014529-shymbmi",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-shymbmi",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 在VFIO的文档中，也提到了IOMMU提供的安全性保障，"
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "icon-default.png?t=N7T8"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/003a2ce7eb50c2e24a8c624c260c5930.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://www.kernel.org/doc/html/next/driver-api/vfio.html",
					"TextMarkATitle": "VFIO - “Virtual Function I/O” — The Linux Kernel  documentation",
					"TextMarkTextContent": "https://www.kernel.org/doc/html/next/driver-api/vfio.htmlVFIO - “Virtual Function I/O” — The Linux Kernel documentationhttps://www.kernel.org/doc/html/next/driver-api/vfio.html"
				}
			]
		},
		{
			"ID": "20250328014529-x98yd23",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20250328014529-x98yd23",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20250328014529-npq4vsj",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20250328014529-npq4vsj",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "Many modern systems now provide DMA and interrupt remapping facilities to help ensure I/O devices behave within the boundaries they’ve been allotted."
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-s32chkk",
			"Type": "NodeHeading",
			"HeadingLevel": 4,
			"Properties": {
				"id": "20250328014529-s32chkk",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "6.1.1 DMA Remapping"
				}
			]
		},
		{
			"ID": "20250328014529-c8qpacu",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-c8qpacu",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "icon-default.png?t=N7T8"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/003a2ce7eb50c2e24a8c624c260c5930.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://cdrdv2-public.intel.com/671081/vt-directed-io-spec.pdf",
					"TextMarkATitle": "Intel® Virtualization Technology for Directed I/O",
					"TextMarkTextContent": "https://cdrdv2-public.intel.com/671081/vt-directed-io-spec.pdfIntel® Virtualization Technology for Directed I/Ohttps://cdrdv2-public.intel.com/671081/vt-directed-io-spec.pdf"
				},
				{
					"Type": "NodeText",
					"Data": "IOMMU在系统中的位置，"
				}
			]
		},
		{
			"ID": "20250328014529-c8qfycu",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-c8qfycu",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/9f03b3b7238f25efdaf3fe6f8bdcf25f.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20250328014529-lrybtps",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-lrybtps",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 它可以实现类似MMU的功能，参考手册："
				}
			]
		},
		{
			"ID": "20250328014529-5hxan8p",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-5hxan8p",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/784022c31dca96e02ffda5a4982d8e3c.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20250328014529-rjme3x2",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-rjme3x2",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 在虚拟化领域，IOMMU可以让设备直接DMA到GPA，进而可以让Guest OS直接给设备提交IO，这是实现Device Passthrough的基础，如下图"
				}
			]
		},
		{
			"ID": "20250328014529-991afik",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-991afik",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/cc2ef0ab1b6b7bfa1a072f09359461c5.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20250328014529-nlixxut",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-nlixxut",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 另外，IOMMU还有一个Requester ID的概念， PCIe设备的每个transaction都带有一个tag，即Requester ID，它格式如下："
				}
			]
		},
		{
			"ID": "20250328014529-ehmdzg7",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-ehmdzg7",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/238dcda21e007fb3a26f7b86236248a5.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20250328014529-mbcv4jb",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-mbcv4jb",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " IOMMU使用这个requester ID来区分不同的IOV地址空间，参考下图："
				}
			]
		},
		{
			"ID": "20250328014529-qa5781t",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-qa5781t",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/d3792328d274043079ba7e018e4008c5.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20250328014529-wyv7e92",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-wyv7e92",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 传统的PCI总线因为是并行总线，并没有transaction的概念，于是也没有这个tag。"
				}
			]
		},
		{
			"ID": "20250328014529-ll94h5q",
			"Type": "NodeHeading",
			"HeadingLevel": 4,
			"Properties": {
				"id": "20250328014529-ll94h5q",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "6.1.2 IOMMU Group"
				}
			]
		},
		{
			"ID": "20250328014529-n20sdev",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-n20sdev",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 本小节主要参考，参考连接"
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "icon-default.png?t=N7T8"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/003a2ce7eb50c2e24a8c624c260c5930.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://vfio.blogspot.com/2014/08/iommu-groups-inside-and-out.html",
					"TextMarkATitle": "IOMMU Groups, inside and out",
					"TextMarkTextContent": "https://vfio.blogspot.com/2014/08/iommu-groups-inside-and-out.htmlIOMMU Groups, inside and outhttps://vfio.blogspot.com/2014/08/iommu-groups-inside-and-out.html"
				},
				{
					"Type": "NodeText",
					"Data": "类似MMU，IOMMU可实现IO地址空间的隔离；进程实现地址空间的基本单位是进程，IOMMU的基本单位则是IOMMU Groups；PCI设备会被划分到不同的IOMMU Groups，其划分的依据有两个，Requester ID和ACS。Requester ID在上一小节，已经解释过。"
				}
			]
		},
		{
			"ID": "20250328014529-guzdjy6",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-guzdjy6",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 另一个影响IOMMU Group划分的因素是ACS(PCIe Access Control Service)，它用来控制peer to peer，设想如下场景：               ​​​​​"
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/ae17ad6d77e682783a92eb82e68c6e94.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20250328014529-fzjn5mn",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-fzjn5mn",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 如上图中，两个Endpoint可以通过Peer to Peer DMA，transations可以通过两个downstream port直接转发，绕过了Root Complex以及IOMMU，如此就会直接访问Device 1的Config Space；ACS可以控制从Device 0直接Peer to Peer到Device 1的操作；但是，ACS在系统和设备中支持的并不完全；例如上图中，由于ACS的缺失，导致"
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "u",
					"TextMarkTextContent": "无法阻止Device 0和Device 1之间直接P2P转发，会强制把Device 0和Device 1放到一个IOMMU Group里"
				},
				{
					"Type": "NodeText",
					"Data": "。"
				}
			]
		},
		{
			"ID": "20250328014529-tcznvxv",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-tcznvxv",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 针对ACS的限制，下面的连接中提供了解决方案："
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "icon-default.png?t=N7T8"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/003a2ce7eb50c2e24a8c624c260c5930.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://superuser.com/questions/1350451/isolate-single-device-into-separate-iommu-group-for-pci-passthrough",
					"TextMarkATitle": "virtualization - Isolate single device into separate IOMMU group for PCI passthrough? - Super User",
					"TextMarkTextContent": "https://superuser.com/questions/1350451/isolate-single-device-into-separate-iommu-group-for-pci-passthroughvirtualization - Isolate single device into separate IOMMU group for PCI passthrough? - Super Userhttps://superuser.com/questions/1350451/isolate-single-device-into-separate-iommu-group-for-pci-passthrough"
				}
			]
		},
		{
			"ID": "20250328014529-ch98p5y",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20250328014529-ch98p5y",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20250328014529-32dms1u",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20250328014529-32dms1u",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "查看iommu group的划分结果，可以查看/sys/kernel/iommu"
						},
						{
							"Type": "NodeBackslash",
							"Data": "span",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "_"
								}
							]
						},
						{
							"Type": "NodeText",
							"Data": "groups，如果为空，需要先打开iommu功能，在Kernel command line中加入'intel"
						},
						{
							"Type": "NodeBackslash",
							"Data": "span",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "_"
								}
							]
						},
						{
							"Type": "NodeText",
							"Data": "iommu"
						},
						{
							"Type": "NodeBackslash",
							"Data": "span",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "="
								}
							]
						},
						{
							"Type": "NodeText",
							"Data": "on'"
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-qb4l4qu",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-qb4l4qu",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 另外，PCIe相关代码中，还有一个DMA Alias的概念，来源可参考连接："
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "icon-default.png?t=N7T8"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/003a2ce7eb50c2e24a8c624c260c5930.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://lists.sr.ht/~philmd/qemu/%3C156418830210.10856.17740359763468342629.stgit%40gimli.home%3E",
					"TextMarkATitle": "[Qemu-devel] [for-4.2 PATCH 0/2] PCI DMA alias support — sourcehut lists",
					"TextMarkTextContent": "https://lists.sr.ht/~philmd/qemu/%3C156418830210.10856.17740359763468342629.stgit%40gimli.home%3E[Qemu-devel] [for-4.2 PATCH 0/2] PCI DMA alias support — sourcehut listshttps://lists.sr.ht/\\~philmd/qemu/%3C156418830210.10856.17740359763468342629.stgit%40gimli.home%3E"
				}
			]
		},
		{
			"ID": "20250328014529-drfosxo",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20250328014529-drfosxo",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20250328014529-hpq9mq5",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20250328014529-hpq9mq5",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "PCIe requester IDs are used by modern IOMMUs to differentiate devices in order to provide a unique IOVA address space per device. These requester IDs are composed of the bus/device/function (BDF) of the requesting device. Conventional PCI pre-dates this concept and is simply a shared parallel bus where transactions are claimed by decoding target ranges rather than the packetized, point-to-point mechanisms of PCI-express. In order to interface conventional PCI to PCIe, the PCIe-to-PCI bridge creates and accepts packetized transactions on behalf of all downstream devices, using one of two potential forms of a requester ID relating to the bridge itself or its subordinate bus. "
						},
						{
							"Type": "NodeTextMark",
							"TextMarkType": "u",
							"TextMarkTextContent": "All downstream devices are therefore aliased by the bridge's requester ID"
						},
						{
							"Type": "NodeText",
							"Data": " and it's not possible for the IOMMU to create unique IOVA spaces for devices downstream of such buses."
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-0qklsi7",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-0qklsi7",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 总结起来就是DMA alias的出现是因为PCI to PCIe Bridge。"
				}
			]
		},
		{
			"ID": "20250328014529-cxrbf50",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-cxrbf50",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 相关函数在pci"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "device"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "group()其中考虑了ACS和DMA Alias... (不想写了，贴函数了)"
				}
			]
		},
		{
			"ID": "20250328014529-is6e74x",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20250328014529-is6e74x",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "6.2 VFIO"
				}
			]
		},
		{
			"ID": "20250328014529-hago6af",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-hago6af",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "icon-default.png?t=N7T8"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/003a2ce7eb50c2e24a8c624c260c5930.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://www.kernel.org/doc/html/next/driver-api/vfio.html",
					"TextMarkATitle": "VFIO - “Virtual Function I/O” — The Linux Kernel  documentation",
					"TextMarkTextContent": "https://www.kernel.org/doc/html/next/driver-api/vfio.htmlVFIO - “Virtual Function I/O” — The Linux Kernel documentationhttps://www.kernel.org/doc/html/next/driver-api/vfio.html"
				},
				{
					"Type": "NodeText",
					"Data": "其中对VFIO有明确的定义："
				}
			]
		},
		{
			"ID": "20250328014529-vr158wy",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20250328014529-vr158wy",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20250328014529-vx6xdd0",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20250328014529-vx6xdd0",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "The VFIO driver is an IOMMU/device agnostic framework for exposing direct device access to userspace, in a secure, IOMMU protected environment. In other words, this allows safe, non-privileged, userspace drivers."
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-7fbqvor",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-7fbqvor",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 同时，链接中也给了使用VFIO最简单例子。"
				}
			]
		},
		{
			"ID": "20250328014529-xi3glq8",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-xi3glq8",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 其中最先一步是，将设备unbind，即"
				}
			]
		},
		{
			"ID": "20250328014529-eehwy3r",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20250328014529-eehwy3r",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20250328014529-5tykw3c",
					"Type": "NodeHeading",
					"HeadingLevel": 1,
					"Properties": {
						"id": "20250328014529-5tykw3c",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "echo 0000:06:0d.0 "
						},
						{
							"Type": "NodeBackslash",
							"Data": "span",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "\u003e"
								}
							]
						},
						{
							"Type": "NodeText",
							"Data": " /sys/bus/pci/devices/0000:06:0d.0/driver/unbind"
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-9ilrhum",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-9ilrhum",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " unbind做的就是卸载驱动，参考代码："
				}
			]
		},
		{
			"ID": "20250328014529-lvt4wji",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20250328014529-lvt4wji",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "Y3Bw"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "unbind_store()\n  -\u003e device_release_driver()\n\t-\u003e device_release_driver_internal()\n\t  -\u003e __device_release_driver()\n\t    ---\n\t\tif (dev-\u003ebus \u0026\u0026 dev-\u003ebus-\u003eremove)\n\t\t\tdev-\u003ebus-\u003eremove(dev);\n\t\telse if (drv-\u003eremove)\n\t\t\tdrv-\u003eremove(dev);\n\t\t---\n\t    -\u003e pci_device_remove()\n\t      -\u003e nvme_remove()\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20250328014529-798bkbz",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-798bkbz",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 但是此时设备还在。"
				}
			]
		},
		{
			"ID": "20250328014529-bamvoss",
			"Type": "NodeHeading",
			"HeadingLevel": 4,
			"Properties": {
				"id": "20250328014529-bamvoss",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "6.2.1 Container/Group/Device"
				}
			]
		},
		{
			"ID": "20250328014529-glh17m4",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-glh17m4",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " Container的作用引用链接"
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "icon-default.png?t=N7T8"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/003a2ce7eb50c2e24a8c624c260c5930.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "\u003cspan data-type=\"a\" data-href=\"https://www.kernel.org/doc/Documentation/vfio.txt\" data-title=\"VFIO - \"Virtual Function I/O\"\"\u003ehttps://www.kernel.org/doc/Documentation/vfio.txt\u003c/span\u003e\u003cspan data-type=\"a\" data-href=\"https://www.kernel.org/doc/Documentation/vfio.txt\" data-title=\"VFIO - \"Virtual Function I/O\"\"\u003eVFIO - \"Virtual Function I/O\"\u003c/span\u003e\u003cspan data-type=\"a\" data-href=\"https://www.kernel.org/doc/Documentation/vfio.txt\" data-title=\"VFIO - \"Virtual Function I/O\"\"\u003ehttps://www.kernel.org/doc/Documentation/vfio.txt\u003c/span\u003e"
				}
			]
		},
		{
			"ID": "20250328014529-9unvtzl",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20250328014529-9unvtzl",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20250328014529-rqji63c",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20250328014529-rqji63c",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "While the group is the minimum granularity that must be used to ensure secure user access, it's not necessarily the preferred granularity.  "
						},
						{
							"Type": "NodeTextMark",
							"TextMarkType": "u",
							"TextMarkTextContent": "In IOMMUs which make use of page tables, it may be possible to share a set of page tables between different groups"
						},
						{
							"Type": "NodeText",
							"Data": ", reducing the overhead both to the platform (reduced TLB thrashing, reduced duplicate page tables), and to the user (programming only a single set of translations).  "
						},
						{
							"Type": "NodeTextMark",
							"TextMarkType": "u",
							"TextMarkTextContent": "For this reason, VFIO makes use of a container class, which may hold one or more groups"
						},
						{
							"Type": "NodeText",
							"Data": ".  A container is created by simply opening the /dev/vfio/vfio character device."
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-tk6qjj0",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-tk6qjj0",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 参考代码："
				}
			]
		},
		{
			"ID": "20250328014529-1o4uv93",
			"Type": "NodeThematicBreak",
			"Properties": {
				"id": "20250328014529-1o4uv93",
				"updated": "20250328014529"
			}
		},
		{
			"ID": "20250328014529-85fjiba",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-85fjiba",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " VFIO的Group和Device的创建在同一个时机；在我们把原来的PCI设备unbind之后，我们需要将其attach到vfio-pci driver里，即"
				}
			]
		},
		{
			"ID": "20250328014529-s0x10cw",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20250328014529-s0x10cw",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20250328014529-ngxznp6",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20250328014529-ngxznp6",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"Type": "NodeBackslash",
							"Data": "span",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "$"
								}
							]
						},
						{
							"Type": "NodeText",
							"Data": " lspci -n -s 0000:06:0d.0\n06:0d.0 0401: 1102:0002 (rev 08)"
						}
					]
				},
				{
					"ID": "20250328014529-4e6ov9z",
					"Type": "NodeHeading",
					"HeadingLevel": 1,
					"Properties": {
						"id": "20250328014529-4e6ov9z",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "echo 0000:06:0d.0 "
						},
						{
							"Type": "NodeBackslash",
							"Data": "span",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "\u003e"
								}
							]
						},
						{
							"Type": "NodeText",
							"Data": " /sys/bus/pci/devices/0000:06:0d.0/driver/unbind"
						}
					]
				},
				{
					"ID": "20250328014529-6hs9msn",
					"Type": "NodeHeading",
					"HeadingLevel": 1,
					"Properties": {
						"id": "20250328014529-6hs9msn",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "echo 1102 0002 "
						},
						{
							"Type": "NodeBackslash",
							"Data": "span",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "\u003e"
								}
							]
						},
						{
							"Type": "NodeText",
							"Data": " /sys/bus/pci/drivers/vfio-pci/new"
						},
						{
							"Type": "NodeBackslash",
							"Data": "span",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "_"
								}
							]
						},
						{
							"Type": "NodeText",
							"Data": "id"
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-9ajuwo6",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-9ajuwo6",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 其对应的代码操作为："
				}
			]
		},
		{
			"ID": "20250328014529-6s7qjca",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-6s7qjca",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 在执行到vfio"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "pci"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "probe之后，分别进入group和device的创建过程；"
				}
			]
		},
		{
			"ID": "20250328014529-2aownvq",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-2aownvq",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 这里在/dev/vfio/下创建了一个vfio group字符设备，比如：/dev/vfio/26；其fops为vfio"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "group"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "fops；"
				}
			]
		},
		{
			"ID": "20250328014529-1mjgy2b",
			"Type": "NodeThematicBreak",
			"Properties": {
				"id": "20250328014529-1mjgy2b",
				"updated": "20250328014529"
			}
		},
		{
			"ID": "20250328014529-pqf4hac",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-pqf4hac",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " vfio"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "device的创建的过程如下："
				}
			]
		},
		{
			"ID": "20250328014529-zdidfhg",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20250328014529-zdidfhg",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "Y3Bw"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "vfio_pci_probe()\n  -\u003e vfio_add_group_dev()\n\t-\u003e vfio_group_create_device()\n\t   ---\n\t\tdevice-\u003edev = dev; // pci_device\n\t\tdevice-\u003egroup = group; // vfio_group\n\t\tdevice-\u003eops = ops; //vfio_pci_ops\n\t\tdevice-\u003edevice_data = device_data; //vfio_pci_device\n\t\tdev_set_drvdata(dev, device);\n\t\t...\n\t\tmutex_lock(\u0026group-\u003edevice_lock);\n\t\tlist_add(\u0026device-\u003egroup_next, \u0026group-\u003edevice_list);\n\t\tmutex_unlock(\u0026group-\u003edevice_lock);\n\t   ---\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20250328014529-4s78xj5",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-4s78xj5",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 这些vfio"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "device需要通过vfio"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "group的ioctl VFIO"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "GROUP"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "GET"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "DEVICE"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "ID获得文件描述符，例如："
				}
			]
		},
		{
			"ID": "20250328014529-25wrwrd",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20250328014529-25wrwrd",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20250328014529-92vjlu4",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20250328014529-92vjlu4",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "/"
						},
						{
							"Type": "NodeBackslash",
							"Data": "span",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "*"
								}
							]
						},
						{
							"Type": "NodeText",
							"Data": " Get a file descriptor for the device "
						},
						{
							"Type": "NodeBackslash",
							"Data": "span",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "*"
								}
							]
						},
						{
							"Type": "NodeText",
							"Data": "/\ndevice "
						},
						{
							"Type": "NodeBackslash",
							"Data": "span",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "="
								}
							]
						},
						{
							"Type": "NodeText",
							"Data": " ioctl(group, VFIO"
						},
						{
							"Type": "NodeBackslash",
							"Data": "span",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "_"
								}
							]
						},
						{
							"Type": "NodeText",
							"Data": "GROUP"
						},
						{
							"Type": "NodeBackslash",
							"Data": "span",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "_"
								}
							]
						},
						{
							"Type": "NodeText",
							"Data": "GET"
						},
						{
							"Type": "NodeBackslash",
							"Data": "span",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "_"
								}
							]
						},
						{
							"Type": "NodeText",
							"Data": "DEVICE"
						},
						{
							"Type": "NodeBackslash",
							"Data": "span",
							"Children": [
								{
									"Type": "NodeText",
									"Data": "_"
								}
							]
						},
						{
							"Type": "NodeText",
							"Data": "FD, \"0000:06:0d.0\");"
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-wm3xbcm",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-wm3xbcm",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 对应的内核代码："
				}
			]
		},
		{
			"ID": "20250328014529-2tn0zaq",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-2tn0zaq",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 通过这里获得的fd，用户态就可以操作之前被unbind的pci设备的；通过读写该fd的不同的offset，可以访问该pci设备的不同的io空间，参考代码:"
				}
			]
		},
		{
			"ID": "20250328014529-oyf3qn2",
			"Type": "NodeHeading",
			"HeadingLevel": 4,
			"Properties": {
				"id": "20250328014529-oyf3qn2",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "6.2.2 Config/Bar"
				}
			]
		},
		{
			"ID": "20250328014529-dv6e9gp",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-dv6e9gp",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 本小节，我们详细看下如何使用VFIO如何让Guest OS访问到PCI设备的Config空间和Bar；"
				}
			]
		},
		{
			"ID": "20250328014529-e0y6rnr",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-e0y6rnr",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 首先看下Config Space；参考代码："
				}
			]
		},
		{
			"ID": "20250328014529-yn12u6j",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-yn12u6j",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 这里根据读写的config space的偏移获得一个perm"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "bits结构；那么对于标准的Config Space空间，它对应的perm"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "bits是哪个？"
				}
			]
		},
		{
			"ID": "20250328014529-r35nll3",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-r35nll3",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " "
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "u",
					"TextMarkTextContent": "对于已经attatch到vfio-pci的设备来说，我们是可以操作Config space的command的，也就是可以重启设备；而Bar是被虚拟化的，无法操作"
				},
				{
					"Type": "NodeText",
					"Data": "。（记住这里\n）"
				}
			]
		},
		{
			"ID": "20250328014529-a0urrqs",
			"Type": "NodeThematicBreak",
			"Properties": {
				"id": "20250328014529-a0urrqs",
				"updated": "20250328014529"
			}
		},
		{
			"ID": "20250328014529-ukd22bn",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-ukd22bn",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 下面我们看下QEMU如何让GuestOS操作这个PCI设备；在QEMU中，vfio-pci是一类特殊的pci设备，参考代码："
				}
			]
		},
		{
			"ID": "20250328014529-bn07n6z",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-bn07n6z",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 对于每一个bar，都会有两种操作模式："
				}
			]
		},
		{
			"ID": "20250328014529-x1ooyl8",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20250328014529-x1ooyl8",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"ID": "20250328014529-mjlv8u2",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-mjlv8u2",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-p5fs7cm",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-p5fs7cm",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "IO，也就是memory"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "region"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "init"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "io对应的vfio"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "bar"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "ops，对着个地址的操作会引起vm-exit，并最终由QEMU来处理，最终vfio"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "bar"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "read/write会通过pread/write操作vfio"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "device对应的偏移；"
								}
							]
						}
					]
				},
				{
					"ID": "20250328014529-agmzlne",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20250328014529-agmzlne",
						"updated": "20250328014529"
					},
					"Children": [
						{
							"ID": "20250328014529-ufr479a",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20250328014529-ufr479a",
								"updated": "20250328014529"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "mmap，这个就是直通模式，也就是Guest OS可以直接操作设备的Bar对应的设备内部的寄存器，而不用引起vm-exit；如何做到，我们深入看下vfio"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "mmap"
								},
								{
									"Type": "NodeBackslash",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeText",
											"Data": "_"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "bar()"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20250328014529-h86lfgq",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-h86lfgq",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 参考代码："
				}
			]
		},
		{
			"ID": "20250328014529-86z5mc2",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20250328014529-86z5mc2",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "Y3Bw"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "vfio_mmap_bar()\n---\n  if (VFIO_ALLOW_MMAP \u0026\u0026 size \u0026\u0026 bar-\u003eflags \u0026 VFIO_REGION_INFO_FLAG_MMAP) {\n\t  \t...\n        *map = mmap(NULL, size, prot, MAP_SHARED,\n                    bar-\u003efd, bar-\u003efd_offset + offset);\n\t\t...\n        memory_region_init_ram_ptr(submem, OBJECT(vdev), name, size, *map);\n    }\n\t...\n    memory_region_add_subregion(mem, offset, submem);\n---\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20250328014529-k940d8h",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-k940d8h",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 针对vfio"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "device的fd的mmap操作，在内核中对应的代码为："
				}
			]
		},
		{
			"ID": "20250328014529-m41dust",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20250328014529-m41dust",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker",
					"CodeBlockInfo": "Y3Bw"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "vfio_pci_mmap()\n---\n\tvma-\u003evm_private_data = vdev;\n\tvma-\u003evm_page_prot = pgprot_noncached(vma-\u003evm_page_prot);\n\tvma-\u003evm_pgoff = (pci_resource_start(pdev, index) \u003e\u003e PAGE_SHIFT) + pgoff;\n\n\treturn remap_pfn_range(vma, vma-\u003evm_start, vma-\u003evm_pgoff,\n\t\t\t       req_len, vma-\u003evm_page_prot);\n\n---\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20250328014529-7zhzzxn",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-7zhzzxn",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 内核将该PCI设备的对应的Bar在Host端的物理地址mmap到这块地址上，然后，QEMU将这块地址memory"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "region"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "init"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "ram"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "ptr()；"
				}
			]
		},
		{
			"ID": "20250328014529-ub9yfm0",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-ub9yfm0",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 参考内存虚拟化的\"1 Memory Slot\" 和 \"6.2 Trap MMIO\""
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "icon-default.png?t=N7T8"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "https://i-blog.csdnimg.cn/blog_migrate/003a2ce7eb50c2e24a8c624c260c5930.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "http://t.csdn.cn/JGKZv",
					"TextMarkATitle": "KVM 内存虚拟化",
					"TextMarkTextContent": "http://t.csdn.cn/JGKZvKVM 内存虚拟化http://t.csdn.cn/JGKZv"
				}
			]
		},
		{
			"ID": "20250328014529-ph762zj",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-ph762zj",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " ram类的memory region会被注册到kvm中称为Memory slot；当首次访问发生vm-exit后，会为之建立对应的页表(SPT或者TDT)；"
				}
			]
		},
		{
			"ID": "20250328014529-ksgl9q5",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-ksgl9q5",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 参考之前\"2.2.4 BAR\"和\"4.3 PCI Bar\"小节，在Guest OS启动的时候，对应的bar获得物理地址，即GPA，此时对设备的Config Space Bar的写操作并不会被更新进设备，而是在内核被执行虚拟化了，参考之前的内容；然后对QEMU使能对应的BAR，其GPA和在vfio"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "pci"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "_"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "mmap()或者的HVA便被注册进KVM；当Guest OS首次访问该GPA，发生vm-exit，之后建立GPA-"
				},
				{
					"Type": "NodeBackslash",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeText",
							"Data": "\u003e"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "HPA mapping；然后Guest OS就可以直接访问设备的Bar里设备寄存器了。"
				}
			]
		},
		{
			"ID": "20250328014529-0qa63dg",
			"Type": "NodeHeading",
			"HeadingLevel": 4,
			"Properties": {
				"id": "20250328014529-0qa63dg",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "6.2.3 Interrupt"
				}
			]
		},
		{
			"ID": "20250328014529-we4w3zy",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-we4w3zy",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 最近比较忙，这部分只是梳理出了中断的转发流程，代码参考："
				}
			]
		},
		{
			"ID": "20250328014529-sz7m2wt",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-sz7m2wt",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " 设备发生中断后，其中断处理代码通过基于eventfd的irqfd机制转发给GuestOS"
				}
			]
		},
		{
			"ID": "20250328014529-l15xlmk",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-l15xlmk",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " IR的部分 To be continued"
				}
			]
		},
		{
			"ID": "20250328014529-jj7e2sq",
			"Type": "NodeHeading",
			"HeadingLevel": 4,
			"Properties": {
				"id": "20250328014529-jj7e2sq",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "6.2.4 DMA"
				}
			]
		},
		{
			"ID": "20250328014529-b9wbq5s",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20250328014529-b9wbq5s",
				"updated": "20250328014529"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": " (To be continued)"
				}
			]
		}
	]
}