{
	"ID": "20230420153245-n8gv2lx",
	"Spec": "1",
	"Type": "NodeDocument",
	"Properties": {
		"id": "20230420153245-n8gv2lx",
		"scroll": "{\u0026quot;startId\u0026quot;:\u0026quot;20230420153245-furj6bn\u0026quot;,\u0026quot;endId\u0026quot;:\u0026quot;20230420153245-o2ge93w\u0026quot;,\u0026quot;scrollTop\u0026quot;:2430,\u0026quot;focusId\u0026quot;:\u0026quot;20230420153245-tt9zvtz\u0026quot;,\u0026quot;focusStart\u0026quot;:60,\u0026quot;focusEnd\u0026quot;:60}",
		"title": "thanos高可用prometheus集群部署",
		"updated": "20230420205729"
	},
	"Children": [
		{
			"ID": "20230420153245-furj6bn",
			"Type": "NodeThematicBreak",
			"Properties": {
				"id": "20230420153245-furj6bn",
				"updated": "20230420153245"
			}
		},
		{
			"ID": "20230420153245-t8th28x",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-t8th28x",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-x92nctu",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-x92nctu",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-zlv8asa",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-zlv8asa",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://www.cuiliangblog.cn/detail/article/30",
									"TextMarkTextContent": "https://www.cuiliangblog.cn/detail/article/30"
								}
							]
						}
					]
				},
				{
					"ID": "20230420153245-luuztou",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-luuztou",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-rr6f2hh",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-rr6f2hh",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "崔亮的个人博客，致力于分享运维开发等技术经验，由系统运维、脚本编程、devops等分类组成，涵盖了docker、k8s、vue、python、DevOps、linux、prometheus、自动化运维、云计算、虚拟化等内容。"
								}
							]
						}
					]
				},
				{
					"ID": "20230420153245-w4abppp",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-w4abppp",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-4rrftvb",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-4rrftvb",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "2023-04-20 15:32:45"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-cjm98zs",
			"Type": "NodeThematicBreak",
			"Properties": {
				"id": "20230420153245-cjm98zs",
				"updated": "20230420153245"
			}
		},
		{
			"ID": "20230420153245-5p4fqkp",
			"Type": "NodeHeading",
			"HeadingLevel": 2,
			"Properties": {
				"id": "20230420153245-5p4fqkp",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "一、prometheus痛点"
				}
			]
		},
		{
			"ID": "20230420153245-u6avmhp",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230420153245-u6avmhp",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "prometheus的单机痛点简单来说就是存在性能瓶颈，不得不降低采集频率，丢弃部分指标，缩小数据过去时间。想要实现水平扩容只能按服务进行拆分，或者服务分片。为了解决数据分散问题，可以指定远程集中存储，但抛弃了强大的promQL。上述方案虽然解决了prometheus的痛点，但是极大的提高了运维使用难度。针对这些问题上述问题，最好的方式办法是采用Thanos 的架构解决。\n详细内容可参见"
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "a",
					"TextMarkAHref": "https://cloud.tencent.com/developer/article/1605915?from=10680",
					"TextMarkTextContent": "https://cloud.tencent.com/developer/article/1605915?from=10680"
				},
				{
					"Type": "NodeText",
					"Data": "，总结的非常到位。在面试中也经常会问到prometheus监控上千台节点时如何进行优化，避免单点故障。"
				}
			]
		},
		{
			"ID": "20230420153245-3sv6zc7",
			"Type": "NodeHeading",
			"HeadingLevel": 2,
			"Properties": {
				"id": "20230420153245-3sv6zc7",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "二、thanos简介"
				}
			]
		},
		{
			"ID": "20230420153245-mffrdmi",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20230420153245-mffrdmi",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "1. thanos架构"
				}
			]
		},
		{
			"ID": "20230420153245-4lv8lom",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230420153245-4lv8lom",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "Sidecar模式：绑定部署在Prometheus 实例上，当进行查询时，由thanos sidecar返回监控数据给Thanos QueryT对数据进行聚合与去重。最新的监控数据存放于Prometheus 本机（适用于Sidecar数量少，单个prometheus集群，查询响应快的场景）\n​"
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "image.png"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "assets/imgProxy-20230420153245-0a27n4b.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "\nReceive模式:Prometheus 实例实时将数据 push 到 Thanos Receiver，最新数据也得以集中起来，然后 Thanos Query 也不用去所有 Sidecar 查最新数据了，直接查 Thanos Receiver 即可（适用于集群规模大，多个prometheus节点，跨集群查询响应慢的场景）\n​"
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "image.png"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "assets/imgProxy-20230420153245-rzd2iqj.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20230420153245-u26c1v6",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20230420153245-u26c1v6",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "2. thanos组件"
				}
			]
		},
		{
			"ID": "20230420153245-rygtvta",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-rygtvta",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-m0ah5ns",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-m0ah5ns",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-ixvbnda",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-ixvbnda",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "边车组件（Sidecar）：连接 Prometheus，并把 Prometheus 暴露给查询网关（Querier/Query），以供实时查询，并且可以上传 Prometheus 数据给云存储，以供长期保存"
								}
							]
						}
					]
				},
				{
					"ID": "20230420153245-vvz9ms6",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-vvz9ms6",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-g97mplo",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-g97mplo",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "查询网关（Querier/Query）：实现了 Prometheus API，与汇集底层组件（如边车组件 Sidecar，或是存储网关 Store Gateway）的数据"
								}
							]
						}
					]
				},
				{
					"ID": "20230420153245-br132co",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-br132co",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-mjw9bbm",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-mjw9bbm",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "存储网关（Store Gateway）：将对象存储的数据暴露给 Thanos Query 去查询。"
								}
							]
						}
					]
				},
				{
					"ID": "20230420153245-ttx0mln",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-ttx0mln",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-qbkbtdn",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-qbkbtdn",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "压缩器（Compactor）：将对象存储中的数据进行压缩和降低采样率，加速大时间区间监控数据查询的速度。"
								}
							]
						}
					]
				},
				{
					"ID": "20230420153245-7woynx9",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-7woynx9",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-3nym8s0",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-3nym8s0",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "接收器（Receiver）：从 Prometheus 的 remote-write WAL（Prometheus 远程预写式日志）获取数据，暴露出去或者上传到云存储"
								}
							]
						}
					]
				},
				{
					"ID": "20230420153245-skyfqrl",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-skyfqrl",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-szlseah",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-szlseah",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "规则组件（Ruler）：对监控数据进行评估和告警，还可以计算出新的监控数据，将这些新数据提供给 Thanos Query 查询并且/或者上传到对象存储，以供长期存储。"
								}
							]
						}
					]
				},
				{
					"ID": "20230420153245-noi4vd4",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-noi4vd4",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-ruk3psx",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-ruk3psx",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "存储（Bucket）：主要用于展示对象存储中历史数据的存储情况，查看每个指标源中数据块的压缩级别，解析度，存储时段和时间长度等信息。"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-rzcefo6",
			"Type": "NodeHeading",
			"HeadingLevel": 2,
			"Properties": {
				"id": "20230420153245-rzcefo6",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "三、thanos部署（基础组件）"
				}
			]
		},
		{
			"ID": "20230420153245-ejcx4dl",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20230420153245-ejcx4dl",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "1. 环境与版本"
				}
			]
		},
		{
			"ID": "20230420153245-8yd2vty",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20230420153245-8yd2vty",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20230420153245-3u81omg",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20230420153245-3u81omg",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "虽然网上有很多部署文档，官网也有demo示例。但在实际部署过程中仍然发现不少问题，以下部署过程本人是参考最新文档示例部署后总结的，如果和本人使用同样的环境，理论上部署不会存在任何问题。"
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-l9d7swd",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-l9d7swd",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban ~]# kubectl get node\nNAME         STATUS   ROLES    AGE    VERSION\nk8s-master   Ready    master   233d   v1.18.14\nk8s-work1    Ready    \u003cnone\u003e   233d   v1.18.14\nk8s-work2    Ready    \u003cnone\u003e   233d   v1.18.14\nk8s-work3    Ready    \u003cnone\u003e   233d   v1.18.14\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-tt9zvtz",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230420153245-tt9zvtz",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "prometheus：v2.30.0\nalertmanager：v0.23.0\nnode-exporter：v1.2.2\ngrafana：8.1.3\nthanos：0.23.0-rc.0"
				}
			]
		},
		{
			"ID": "20230420153245-55fwyq6",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-55fwyq6",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-dkczzra",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-dkczzra",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-kw3lht1",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-kw3lht1",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "本实验所有yaml文件已上传至github，欢迎访问下载\n"
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://github.com/cuiliang0302/thanos-install",
									"TextMarkTextContent": "https://github.com/cuiliang0302/thanos-install"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-ofqfh9q",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20230420153245-ofqfh9q",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "2. 准备工作"
				}
			]
		},
		{
			"ID": "20230420153245-q1rgbh4",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20230420153245-q1rgbh4",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20230420153245-ov0lmup",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20230420153245-ov0lmup",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "thanos推荐使用对象存储服务实现数据持久化，如果是公有云推荐腾讯云 COS 或者阿里云 OSS ，如果是私有云推荐使用minIO或者ceph的RGW。此处为了便于演示，直接使用local pv。"
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-h0lnm14",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-h0lnm14",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-7ty4b9i",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-7ty4b9i",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-sbz5s5f",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-sbz5s5f",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "宿主机创建目录（或挂载并格式化一个可用的磁盘）用于存储。"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-qam80sk",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-qam80sk",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "# 提前在所有work节点创建如下三个目录，用于存放数据。\nmkdir -p /tmp/{prometheus,grafana,thanos-store}\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-uqc9mod",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-uqc9mod",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-klqfr51",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-klqfr51",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-kastvvn",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-kastvvn",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "创建StorageClass"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-ns1acm1",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-ns1acm1",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban thanos]# cat storageClass.yaml \napiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: local-storage\nprovisioner: kubernetes.io/no-provisioner\nvolumeBindingMode: WaitForFirstConsumer\n[root@tiaoban thanos]# kubectl apply -f storageClass.yaml \nstorageclass.storage.k8s.io/local-storage created\n[root@tiaoban thanos]# kubectl get sc\nNAME            PROVISIONER                    RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE\nlocal-storage   kubernetes.io/no-provisioner   Delete          WaitForFirstConsumer   false                  3s\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-h2dy8e1",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230420153245-h2dy8e1",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "volumeBindingMode 字段定义为 WaitForFirstConsumer，即：延迟绑定。当在我们提交 PVC 文件时，StorageClass 为我们延迟绑定 PV 与 PVC 的对应关系。避免pod因pv资源而调度失败。"
				}
			]
		},
		{
			"ID": "20230420153245-of5g705",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-of5g705",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-592gek7",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-592gek7",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-7uydy2i",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-7uydy2i",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "创建namespace"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-pq47mpy",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230420153245-pq47mpy",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "​"
				},
				{
					"Type": "NodeTextMark",
					"TextMarkType": "code",
					"TextMarkTextContent": "kubectl create ns thanos"
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20230420153245-vhosr4y",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20230420153245-vhosr4y",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "3. 创建ServiceAccount"
				}
			]
		},
		{
			"ID": "20230420153245-ecun4vv",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20230420153245-ecun4vv",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20230420153245-63u0l14",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20230420153245-63u0l14",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "创建Prometheus账号，并为其绑定足够的 RBAC 权限，以便后续配置使用 k8s 的服务发现 (kubernetes_sd_configs) 时能够正常工作。"
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-y8s58uy",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-y8s58uy",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban thanos]# cat rbac.yaml \napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: prometheus\n  namespace: thanos\n\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRole\nmetadata:\n  name: prometheus\n  namespace: thanos\nrules:\n- apiGroups: [\"\"]\n  resources:\n  - nodes\n  - nodes/proxy\n  - nodes/metrics\n  - services\n  - endpoints\n  - pods\n  verbs: [\"get\", \"list\", \"watch\"]\n- apiGroups: [\"\"]\n  resources: [\"configmaps\"]\n  verbs: [\"get\"]\n- nonResourceURLs: [\"/metrics\"]\n  verbs: [\"get\"]\n\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRoleBinding\nmetadata:\n  name: prometheus\nsubjects:\n  - kind: ServiceAccount\n    name: prometheus\n    namespace: thanos\nroleRef:\n  kind: ClusterRole\n  name: prometheus\n  apiGroup: rbac.authorization.k8s.io\n[root@tiaoban thanos]# kubectl apply -f rbac.yaml \nserviceaccount/prometheus created\nclusterrole.rbac.authorization.k8s.io/prometheus unchanged\nclusterrolebinding.rbac.authorization.k8s.io/prometheus unchanged\n[root@tiaoban thanos]# kubectl get sa -n thanos \nNAME         SECRETS   AGE\ndefault      1         2m35s\nprometheus   1         12s\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-053njyz",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20230420153245-053njyz",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "4. 部署prometheus和Sidecar"
				}
			]
		},
		{
			"ID": "20230420153245-90sc0v2",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-90sc0v2",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-8rz9fkq",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-8rz9fkq",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-ulegupp",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-ulegupp",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "创建pv资源，供Prometheus 使用 StatefulSet使用"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-43uqaeh",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20230420153245-43uqaeh",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20230420153245-rla5jhh",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20230420153245-rla5jhh",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "此处部署三个 Prometheus StatefulSet，用于实现高可用，模拟实际生产环境多个prometheus集群情况。"
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-o2ge93w",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-o2ge93w",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban thanos]# cat prometheus-pv.yaml \napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: prometheus-pv1\nspec:\n  capacity:\n    storage: 10Gi\n  volumeMode: Filesystem\n  accessModes:\n  - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Delete\n  storageClassName: local-storage\n  local:\n    path: /data/prometheus\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n      - matchExpressions:\n        - key: kubernetes.io/hostname\n          operator: In\n          values:\n          - k8s-work1\n---\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: prometheus-pv2\nspec:\n  capacity:\n    storage: 10Gi\n  volumeMode: Filesystem\n  accessModes:\n  - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Delete\n  storageClassName: local-storage\n  local:\n    path: /data/prometheus\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n      - matchExpressions:\n        - key: kubernetes.io/hostname\n          operator: In\n          values:\n          - k8s-work2\n---\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: prometheus-pv3\nspec:\n  capacity:\n    storage: 10Gi\n  volumeMode: Filesystem\n  accessModes:\n  - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Delete\n  storageClassName: local-storage\n  local:\n    path: /data/prometheus\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n      - matchExpressions:\n        - key: kubernetes.io/hostname\n          operator: In\n          values:\n          - k8s-work3\n[root@tiaoban thanos]# kubectl apply -f prometheus-pv.yaml \npersistentvolume/prometheus-pv1 created\npersistentvolume/prometheus-pv2 created\npersistentvolume/prometheus-pv3 created\n[root@tiaoban thanos]# kubectl get pv\nNAME             CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS    REASON   AGE\nprometheus-pv1   10Gi       RWO            Delete           Available           local-storage            4s\nprometheus-pv2   10Gi       RWO            Delete           Available           local-storage            4s\nprometheus-pv3   10Gi       RWO            Delete           Available           local-storage            4s\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-5c5j60y",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-5c5j60y",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-ua2spvb",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-ua2spvb",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-q7y07pr",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-q7y07pr",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "创建prometheus配置文件和roles告警规则文件"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-710wq0m",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20230420153245-710wq0m",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20230420153245-p8i0y74",
					"Type": "NodeList",
					"ListData": {},
					"Properties": {
						"id": "20230420153245-p8i0y74",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-br197gn",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-br197gn",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-z4s4wfg",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-z4s4wfg",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "Prometheus 使用 --storage.tsdb.retention.time 指定数据保留时长，默认15天，可以根据数据增长速度和数据盘大小做适当调整(数据增长取决于采集的指标和目标端点的数量和采集频率)。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-czqal90",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-czqal90",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-icotni7",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-icotni7",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "通常会给 Prometheus 附带一个 quay.io/coreos/prometheus-config-reloader 来监听配置变更并动态加载，但 thanos sidecar 也为我们提供了这个功能，所以可以直接用 thanos sidecar 来实现此功能，也支持配置文件根据模板动态生成：–reloader.config-file 指定 Prometheus 配置文件模板–reloader.config-envsubst-file 指定生成配置文件的存放路径，假设是 /etc/prometheus/config_out/prometheus.yaml ，那么 /etc/prometheus/config_out 这个路径使用 emptyDir 让 Prometheus 与 Sidecar 实现配置文件共享挂载，Prometheus 再通过 --config.file 指定生成出来的配置文件，当配置有更新时，挂载的配置文件也会同步更新，Sidecar 也会通知 Prometheus 重新加载配置。另外，Sidecar 与 Prometheus 也挂载同一份 rules 配置文件，配置更新后 Sidecar 仅通知 Prometheus 加载配置，不支持模板，因为 rules 配置不需要模板来动态生成。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-qm3htht",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-qm3htht",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-2rlfqlm",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-2rlfqlm",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "Prometheus 实例采集的所有指标数据里都会额外加上 external_labels 里指定的 label，通常用 cluster 区分当前 Prometheus 所在集群的名称，我们再加了个 prometheus_replica，用于区分相同 Prometheus 副本（这些副本所采集的数据除了 prometheus_replica 的值不一样，其它几乎一致，这个值会被 Thanos Sidecar 替换成 Pod 副本的名称，用于 Thanos 实现 Prometheus 高可用）"
										}
									]
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-3j886i9",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-3j886i9",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban thanos]# cat prometheus-config.yaml \napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus-config-tmpl\n  namespace: thanos\ndata:\n  prometheus.yaml.tmpl: |-\n    global:\n      scrape_interval: 5s\n      evaluation_interval: 5s\n      external_labels:\n        cluster: prometheus-ha\n        prometheus_replica: $(POD_NAME)\n    rule_files:\n    - /etc/prometheus/rules/*.yaml\n    scrape_configs:\n    - job_name: node_exporter\n      kubernetes_sd_configs:\n      - role: node\n      relabel_configs:\n      - source_labels: [__address__]\n        regex: '(.*):10250'\n        replacement: '${1}:9100'\n        target_label: __address__\n        action: replace\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\n    - job_name: kubelet\n      metrics_path: /metrics/cadvisor\n      scrape_interval: 10s\n      scrape_timeout: 10s\n      scheme: https\n      tls_config:\n        insecure_skip_verify: true\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      kubernetes_sd_configs:\n      - role: node\n      relabel_configs:\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\n    - job_name: 'kube-state-metrics'\n      kubernetes_sd_configs:\n      - role: pod\n      relabel_configs:\n      - source_labels: [__meta_kubernetes_pod_name]\n        action: replace\n        target_label: pod\n      - action: labelmap\n        regex: __meta_kubernetes_pod_label_(.+)\n      - source_labels: [__meta_kubernetes_pod_ip]\n        regex: (.+)\n        target_label: __address__\n        replacement: ${1}:8080\n      - source_labels:  [\"__meta_kubernetes_pod_container_name\"]\n        regex: \"^kube-state-metrics.*\"\n        action: keep\n    - job_name: prometheus\n      honor_labels: false\n      kubernetes_sd_configs:\n      - role: endpoints\n      scrape_interval: 30s\n      relabel_configs:\n      - source_labels:\n          - __meta_kubernetes_service_label_name\n        regex: k8s-prometheus\n        action: keep\n      - source_labels: [__meta_kubernetes_pod_ip]\n        regex: (.+)\n        target_label: __address__\n        replacement: ${1}:9090\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus-rules\n  labels:\n    name: prometheus-rules\n  namespace: thanos\ndata:\n  alert-rules.yaml: |-\n    groups:\n    - name: k8s.rules\n      rules:\n      - expr: |\n          sum(rate(container_cpu_usage_seconds_total{job=\"cadvisor\", image!=\"\", container!=\"\"}[5m])) by (namespace)\n        record: namespace:container_cpu_usage_seconds_total:sum_rate\n      - expr: |\n          sum(container_memory_usage_bytes{job=\"cadvisor\", image!=\"\", container!=\"\"}) by (namespace)\n        record: namespace:container_memory_usage_bytes:sum\n      - expr: |\n          sum by (namespace, pod, container) (\n            rate(container_cpu_usage_seconds_total{job=\"cadvisor\", image!=\"\", container!=\"\"}[5m])\n          )\n        record: namespace_pod_container:container_cpu_usage_seconds_total:sum_rate\n[root@tiaoban thanos]# kubectl apply -f prometheus-config.yaml \nconfigmap/prometheus-config-tmpl created\nconfigmap/prometheus-rules created\n[root@tiaoban thanos]# kubectl get configmaps -n thanos \nNAME                     DATA   AGE\nprometheus-config-tmpl   1      8s\nprometheus-rules         1      8s\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-2wypizp",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-2wypizp",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-rmxnklq",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-rmxnklq",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-j91azbe",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-j91azbe",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "部署prometheus和sidecar"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-le3jjz3",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20230420153245-le3jjz3",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20230420153245-5h2269r",
					"Type": "NodeList",
					"ListData": {},
					"Properties": {
						"id": "20230420153245-5h2269r",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-pb01vye",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-pb01vye",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-2qcvxxy",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-2qcvxxy",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "Prometheus 使用 StatefulSet 方式部署，挂载数据盘以便存储最新监控数据。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-qq5shpo",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-qq5shpo",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-it3idtd",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-it3idtd",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "由于 Prometheus 副本之间没有启动顺序的依赖，所以 podManagementPolicy 指定为 Parallel，加快启动速度。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-s2epk3e",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-s2epk3e",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-b7vjjqs",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-b7vjjqs",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "为 Prometheus 创建 headless 类型 service，为后续 Thanos Query 通过 DNS SRV 记录来动态发现 Sidecar 的 gRPC 端点做准备 (使用 headless service 才能让 DNS SRV 正确返回所有端点)。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-omh0fh9",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-omh0fh9",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-1d4vgzw",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-1d4vgzw",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "使用硬反亲和，避免 Prometheus 部署在同一节点，既可以分散压力也可以避免单点故障。"
										}
									]
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-jriy8n0",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-jriy8n0",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban thanos]# cat prometheus.yaml \nkind: Service\napiVersion: v1\nmetadata:\n  name: prometheus-headless\n  namespace: thanos\n  labels:\n    app.kubernetes.io/name: prometheus\n    name: k8s-prometheus\nspec:\n  type: ClusterIP\n  clusterIP: None\n  selector:\n    app.kubernetes.io/name: prometheus\n  ports:\n  - name: web\n    protocol: TCP\n    port: 9090\n    targetPort: web\n  - name: grpc\n    port: 10901\n    targetPort: grpc\n---\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: prometheus\n  namespace: thanos\n  labels:\n    app.kubernetes.io/name: thanos-query\nspec:\n  serviceName: prometheus-headless\n  podManagementPolicy: Parallel\n  replicas: 3\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: prometheus\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/name: prometheus\n    spec:\n      serviceAccountName: prometheus\n      securityContext:\n        fsGroup: 2000\n        runAsNonRoot: true\n        runAsUser: 1000\n      affinity:\n        podAntiAffinity:\n          requiredDuringSchedulingIgnoredDuringExecution:\n          - labelSelector:\n              matchExpressions:\n              - key: app.kubernetes.io/name\n                operator: In\n                values:\n                - prometheus\n            topologyKey: kubernetes.io/hostname\n      containers:\n      - name: prometheus\n        image: prom/prometheus:v2.30.0\n        imagePullPolicy: IfNotPresent\n        args:\n        - --config.file=/etc/prometheus/config_out/prometheus.yaml\n        - --storage.tsdb.path=/prometheus\n        - --storage.tsdb.retention.time=10d\n        - --web.route-prefix=/\n        - --web.enable-lifecycle\n        - --storage.tsdb.no-lockfile\n        - --storage.tsdb.min-block-duration=2h\n        - --storage.tsdb.max-block-duration=2h\n        - --log.level=debug\n        ports:\n        - containerPort: 9090\n          name: web\n          protocol: TCP\n        livenessProbe:\n          failureThreshold: 6\n          httpGet:\n            path: /-/healthy\n            port: web\n            scheme: HTTP\n          periodSeconds: 5\n          successThreshold: 1\n          timeoutSeconds: 3\n        readinessProbe:\n          failureThreshold: 120\n          httpGet:\n            path: /-/ready\n            port: web\n            scheme: HTTP\n          periodSeconds: 5\n          successThreshold: 1\n          timeoutSeconds: 3\n        volumeMounts:\n        - mountPath: /etc/prometheus/config_out\n          name: prometheus-config-out\n          readOnly: true\n        - mountPath: /prometheus\n          name: data\n        - mountPath: /etc/prometheus/rules\n          name: prometheus-rules\n      - name: thanos\n        image: thanosio/thanos:v0.23.0-rc.0\n        imagePullPolicy: IfNotPresent\n        args:\n        - sidecar\n        - --log.level=debug\n        - --tsdb.path=/prometheus\n        - --prometheus.url=http://127.0.0.1:9090\n        - --reloader.config-file=/etc/prometheus/config/prometheus.yaml.tmpl\n        - --reloader.config-envsubst-file=/etc/prometheus/config_out/prometheus.yaml\n        - --reloader.rule-dir=/etc/prometheus/rules/\n        env:\n        - name: POD_NAME\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.name\n        ports:\n        - name: http-sidecar\n          containerPort: 10902\n        - name: grpc\n          containerPort: 10901\n        livenessProbe:\n            httpGet:\n              port: 10902\n              path: /-/healthy\n        readinessProbe:\n          httpGet:\n            port: 10902\n            path: /-/ready\n        volumeMounts:\n        - name: prometheus-config-tmpl\n          mountPath: /etc/prometheus/config\n        - name: prometheus-config-out\n          mountPath: /etc/prometheus/config_out\n        - name: prometheus-rules\n          mountPath: /etc/prometheus/rules\n        - name: data\n          mountPath: /prometheus\n      volumes:\n      - name: prometheus-config-tmpl\n        configMap:\n          defaultMode: 420\n          name: prometheus-config-tmpl\n      - name: prometheus-config-out\n        emptyDir: {}\n      - name: prometheus-rules\n        configMap:\n          name: prometheus-rules\n  volumeClaimTemplates:\n  - metadata:\n      name: data\n    spec:\n      accessModes:\n      - ReadWriteOnce\n      storageClassName: local-storage\n      resources:\n        requests:\n          storage: 5Gi\n[root@tiaoban thanos]# kubectl apply -f prometheus.yaml \nservice/prometheus-headless created\nstatefulset.apps/prometheus created\n[root@tiaoban thanos]# kubectl get pod -n thanos \nNAME           READY   STATUS    RESTARTS   AGE\nprometheus-0   2/2     Running   1          2m46s\nprometheus-1   2/2     Running   1          2m37s\nprometheus-2   2/2     Running   1          3m22s\n[root@tiaoban thanos]# kubectl get pv\nNAME             CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                      STORAGECLASS    REASON   AGE\nprometheus-pv1   10Gi       RWO            Delete           Bound    thanos/data-prometheus-0   local-storage            58m\nprometheus-pv2   10Gi       RWO            Delete           Bound    thanos/data-prometheus-1   local-storage            58m\nprometheus-pv3   10Gi       RWO            Delete           Bound    thanos/data-prometheus-2   local-storage            58m\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-hdeefwv",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20230420153245-hdeefwv",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "5. 部署Thanos Querier"
				}
			]
		},
		{
			"ID": "20230420153245-movbodn",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20230420153245-movbodn",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20230420153245-nxxbz54",
					"Type": "NodeList",
					"ListData": {},
					"Properties": {
						"id": "20230420153245-nxxbz54",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-lsw8pye",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-lsw8pye",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-pn2a5wh",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-pn2a5wh",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "因为 Query 是无状态的，使用 Deployment 部署，也不需要 headless service，直接创建普通的 service。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-z6ugjkh",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-z6ugjkh",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-taqd8i3",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-taqd8i3",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "使用软反亲和，尽量不让 Query 调度到同一节点。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-j44qvff",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-j44qvff",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-1xn1mm7",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-1xn1mm7",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "部署多个副本，实现 Query 的高可用。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-53fgr46",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-53fgr46",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-gj1g9rx",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-gj1g9rx",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "–query.partial-response 启用 "
										},
										{
											"Type": "NodeTextMark",
											"TextMarkType": "a",
											"TextMarkAHref": "https://thanos.io/components/query.md/#partial-response",
											"TextMarkTextContent": "Partial Response"
										},
										{
											"Type": "NodeText",
											"Data": "，这样可以在部分后端 Store API 返回错误或超时的情况下也能看到正确的监控数据(如果后端 Store API 做了高可用，挂掉一个副本，Query 访问挂掉的副本超时，但由于还有没挂掉的副本，还是能正确返回结果；如果挂掉的某个后端本身就不存在我们需要的数据，挂掉也不影响结果的正确性；总之如果各个组件都做了高可用，想获得错误的结果都难，所以我们有信心启用 Partial Response 这个功能)。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-h0k3jfx",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-h0k3jfx",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-1cjkqgj",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-1cjkqgj",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "–query.auto-downsampling 查询时自动降采样，提升查询效率。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-g6b45zf",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-g6b45zf",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-vc9z9yo",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-vc9z9yo",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "–query.replica-label 指定我们刚刚给 Prometheus 配置的 prometheus_replica 这个 external label，Query 向 Sidecar 拉取 Prometheus 数据时会识别这个 label 并自动去重，这样即使挂掉一个副本，只要至少有一个副本正常也不会影响查询结果，也就是可以实现 Prometheus 的高可用。同理，再指定一个 rule_replica 用于给 Ruler 做高可用。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-k608ers",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-k608ers",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-scjip1b",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-scjip1b",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "–store 指定实现了 Store API 的地址(Sidecar, Ruler, Store Gateway, Receiver)，通常不建议写静态地址，而是使用服务发现机制自动发现 Store API 地址，如果是部署在同一个集群，可以用 DNS SRV 记录来做服务发现，比如 dnssrv+_grpc._tcp.prometheus-headless.thanos.svc.cluster.local，也就是我们刚刚为包含 Sidecar 的 Prometheus 创建的 headless service (使用 headless service 才能正确实现服务发现)，并且指定了名为 grpc 的 tcp 端口，同理，其它组件也可以按照这样加到 --store 参数里；如果是其它有些组件部署在集群外，无法通过集群 dns 解析 DNS SRV 记录，可以使用配置文件来做服务发现，也就是指定 --store.sd-files 参数，将其它 Store API 地址写在配置文件里 (挂载 ConfigMap)，需要增加地址时直接更新 ConfigMap (不需要重启 Query)。"
										}
									]
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-rm2ksr2",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-rm2ksr2",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-nxprury",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-nxprury",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-kdfgvvk",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-kdfgvvk",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "部署Thanos Querier"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-oatonlh",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-oatonlh",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban thanos]# cat thanos-query.yaml \napiVersion: v1\nkind: Service\nmetadata:\n  name: thanos-query\n  namespace: thanos\n  labels:\n    app.kubernetes.io/name: thanos-query\nspec:\n  ports:\n  - name: grpc\n    port: 10901\n    targetPort: grpc\n  - name: http\n    port: 9090\n    targetPort: http\n  selector:\n    app.kubernetes.io/name: thanos-query\n---\n\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: thanos-query\n  namespace: thanos\n  labels:\n    app.kubernetes.io/name: thanos-query\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: thanos-query\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/name: thanos-query\n    spec:\n      affinity:\n        podAntiAffinity:\n          preferredDuringSchedulingIgnoredDuringExecution:\n          - podAffinityTerm:\n              labelSelector:\n                matchExpressions:\n                - key: app.kubernetes.io/name\n                  operator: In\n                  values:\n                  - thanos-query\n              topologyKey: kubernetes.io/hostname\n            weight: 100\n      containers:\n      - args:\n        - query\n        - --log.level=debug\n        - --query.auto-downsampling\n        - --grpc-address=0.0.0.0:10901\n        - --http-address=0.0.0.0:9090\n        - --query.partial-response\n        - --query.replica-label=prometheus_replica\n        - --query.replica-label=rule_replica\n        - --store=dnssrv+_grpc._tcp.prometheus-headless.thanos.svc.cluster.local\n        - --store=dnssrv+_grpc._tcp.thanos-rule.thanos.svc.cluster.local\n        - --store=dnssrv+_grpc._tcp.thanos-store.thanos.svc.cluster.local\n        image: thanosio/thanos:v0.23.0-rc.0\n        imagePullPolicy: IfNotPresent\n        resources:\n          limits:\n            memory: \"2048Mi\"\n            cpu: \"500m\" \n          requests:\n            memory: \"128Mi\"\n            cpu: \"100m\" \n        livenessProbe:\n          failureThreshold: 4\n          httpGet:\n            path: /-/healthy\n            port: 9090\n            scheme: HTTP\n          periodSeconds: 30\n        name: thanos-query\n        ports:\n        - containerPort: 10901\n          name: grpc\n        - containerPort: 9090\n          name: http\n        readinessProbe:\n          failureThreshold: 20\n          httpGet:\n            path: /-/ready\n            port: 9090\n            scheme: HTTP\n          periodSeconds: 5\n        terminationMessagePolicy: FallbackToLogsOnError\n      terminationGracePeriodSeconds: 120\n[root@tiaoban thanos]# kubectl apply -f thanos-query.yaml \nservice/thanos-query created\ndeployment.apps/thanos-query created\n[root@tiaoban thanos]# kubectl get pod -n thanos \nNAME                           READY   STATUS    RESTARTS   AGE\nprometheus-0                   2/2     Running   1          14m\nprometheus-1                   2/2     Running   1          14m\nprometheus-2                   2/2     Running   1          15m\nthanos-query-5cd8dc8d7-rg75m   1/1     Running   0          33s\nthanos-query-5cd8dc8d7-xqbjp   1/1     Running   0          32s\nthanos-query-5cd8dc8d7-xth47   1/1     Running   0          32s\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-3hwfxsz",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20230420153245-3hwfxsz",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "6. 部署Thanos Store Gateway"
				}
			]
		},
		{
			"ID": "20230420153245-tsxywrr",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-tsxywrr",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-u53ac0r",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-u53ac0r",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-5xqvy5a",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-5xqvy5a",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "创建pv，用于store gateway数据存储"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-tcuqslb",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-tcuqslb",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban thanos]# cat thanos-store-pv.yaml \napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: thanos-store-pv1\nspec:\n  capacity:\n    storage: 5Gi\n  volumeMode: Filesystem\n  accessModes:\n  - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Delete\n  storageClassName: local-storage\n  local:\n    path: /data/thanos-store\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n      - matchExpressions:\n        - key: kubernetes.io/hostname\n          operator: In\n          values:\n          - k8s-work1\n---\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: thanos-store-pv2\nspec:\n  capacity:\n    storage: 5Gi\n  volumeMode: Filesystem\n  accessModes:\n  - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Delete\n  storageClassName: local-storage\n  local:\n    path: /data/thanos-store\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n      - matchExpressions:\n        - key: kubernetes.io/hostname\n          operator: In\n          values:\n          - k8s-work2\n[root@tiaoban thanos]# kubectl apply -f thanos-store-pv.yaml \npersistentvolume/thanos-store-pv1 created\npersistentvolume/thanos-store-pv2 created\n[root@tiaoban thanos]# kubectl get pv\nNAME               CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM                      STORAGECLASS    REASON   AGE\nprometheus-pv1     10Gi       RWO            Delete           Bound       thanos/data-prometheus-0   local-storage            70m\nprometheus-pv2     10Gi       RWO            Delete           Bound       thanos/data-prometheus-1   local-storage            70m\nprometheus-pv3     10Gi       RWO            Delete           Bound       thanos/data-prometheus-2   local-storage            70m\nthanos-store-pv1   5Gi        RWO            Delete           Available                              local-storage            5s\nthanos-store-pv2   5Gi        RWO            Delete           Available                              local-storage            5s\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-t43oevu",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-t43oevu",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-5fsckbc",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-5fsckbc",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-rptq4aq",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-rptq4aq",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "创建Store Gateway配置文件，此处使用FILESYSTEM便于演示"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-2t68ndf",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-2t68ndf",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban thanos]# cat thanos-store-config.yaml \napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: thanos-storage-config\n  namespace: thanos\ndata:\n  storage.yaml: |\n    type: FILESYSTEM\n    config:\n      directory: \"/data/thanos-store/\"\n\n[root@tiaoban thanos]# kubectl apply -f thanos-store-config.yaml \nconfigmap/thanos-storage-config created\n[root@tiaoban thanos]# kubectl get configmaps -n thanos \nNAME                     DATA   AGE\nprometheus-config-tmpl   1      69m\nprometheus-rules         1      69m\nthanos-storage-config    1      7s\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-r92jnn8",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-r92jnn8",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-02lfprd",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-02lfprd",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-9hwxpku",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-9hwxpku",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "部署Store Gateway"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-ihdrdvg",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20230420153245-ihdrdvg",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20230420153245-otxl97g",
					"Type": "NodeList",
					"ListData": {},
					"Properties": {
						"id": "20230420153245-otxl97g",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-pnxq6nt",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-pnxq6nt",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-z0ympv2",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-z0ympv2",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "Store Gateway 实际也可以做到一定程度的无状态，它会需要一点磁盘空间来对对象存储做索引以加速查询，但数据不那么重要，是可以删除的，删除后会自动去拉对象存储查数据重新建立索引。这里我们避免每次重启都重新建立索引，所以用 StatefulSet 部署 Store Gateway，挂载一块小容量的磁盘(索引占用不到多大空间)。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-pnzte39",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-pnzte39",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-ztfad8h",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-ztfad8h",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "同样创建 headless service，用于 Query 对 Store Gateway 进行服务发现。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-73p0n5j",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-73p0n5j",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-fplcc9e",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-fplcc9e",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "部署两个副本，实现 Store Gateway 的高可用。"
										}
									]
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-j8ub1vs",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-j8ub1vs",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban thanos]# cat thanos-store.yaml \napiVersion: v1\nkind: Service\nmetadata:\n  name: thanos-store\n  namespace: thanos\n  labels:\n    app.kubernetes.io/name: thanos-store\nspec:\n  clusterIP: None\n  ports:\n  - name: grpc\n    port: 10901\n    targetPort: 10901\n  - name: http\n    port: 10902\n    targetPort: 10902\n  selector:\n    app.kubernetes.io/name: thanos-store\n---\n\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: thanos-store\n  namespace: thanos\n  labels:\n    app.kubernetes.io/name: thanos-store\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: thanos-store\n  serviceName: thanos-store\n  podManagementPolicy: Parallel\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/name: thanos-store\n    spec:\n      containers:\n      - args:\n        - store\n        - --log.level=debug\n        - --data-dir=/var/thanos/store\n        - --grpc-address=0.0.0.0:10901\n        - --http-address=0.0.0.0:10902\n        - --objstore.config-file=/etc/thanos/storage.yaml\n        image: thanosio/thanos:v0.23.0-rc.0\n        imagePullPolicy: IfNotPresent\n        resources:\n          limits:\n            memory: \"2048Mi\"\n            cpu: \"500m\" \n          requests:\n            memory: \"128Mi\"\n            cpu: \"100m\" \n        livenessProbe:\n          failureThreshold: 8\n          httpGet:\n            path: /-/healthy\n            port: 10902\n            scheme: HTTP\n          periodSeconds: 30\n        name: thanos-store\n        ports:\n        - containerPort: 10901\n          name: grpc\n        - containerPort: 10902\n          name: http\n        readinessProbe:\n          failureThreshold: 20\n          httpGet:\n            path: /-/ready\n            port: 10902\n            scheme: HTTP\n          periodSeconds: 5\n        terminationMessagePolicy: FallbackToLogsOnError\n        volumeMounts:\n        - mountPath: /var/thanos/store\n          name: data\n          readOnly: false\n        - name: thanos-storage-config\n          subPath: storage.yaml\n          mountPath: /etc/thanos/storage.yaml\n      terminationGracePeriodSeconds: 120\n      volumes:\n      - name: thanos-storage-config\n        configMap:\n          name: thanos-storage-config\n  volumeClaimTemplates:\n  - metadata:\n      name: data\n    spec:\n      accessModes:\n      - ReadWriteOnce\n      storageClassName: local-storage\n      resources:\n        requests:\n          storage: 5Gi\n[root@tiaoban thanos]# kubectl apply -f thanos-store.yaml \nservice/thanos-store created\nstatefulset.apps/thanos-store created\n[root@tiaoban thanos]# kubectl get pod -n thanos \nNAME                           READY   STATUS    RESTARTS   AGE\nprometheus-0                   2/2     Running   1          33m\nprometheus-1                   2/2     Running   1          33m\nprometheus-2                   2/2     Running   1          34m\nthanos-query-5cd8dc8d7-rg75m   1/1     Running   0          19m\nthanos-query-5cd8dc8d7-xqbjp   1/1     Running   0          19m\nthanos-query-5cd8dc8d7-xth47   1/1     Running   0          19m\nthanos-store-0                 1/1     Running   0          45s\nthanos-store-1                 1/1     Running   0          45s\n[root@tiaoban thanos]# kubectl get pv\nNAME               CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                        STORAGECLASS    REASON   AGE\nprometheus-pv1     10Gi       RWO            Delete           Bound    thanos/data-prometheus-0     local-storage            86m\nprometheus-pv2     10Gi       RWO            Delete           Bound    thanos/data-prometheus-1     local-storage            86m\nprometheus-pv3     10Gi       RWO            Delete           Bound    thanos/data-prometheus-2     local-storage            86m\nthanos-store-pv1   5Gi        RWO            Delete           Bound    thanos/data-thanos-store-0   local-storage            81s\nthanos-store-pv2   5Gi        RWO            Delete           Bound    thanos/data-thanos-store-1   local-storage            81s\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-7opsewd",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20230420153245-7opsewd",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "7. 部署Thanos Compact"
				}
			]
		},
		{
			"ID": "20230420153245-4ykmy22",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-4ykmy22",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-5lzvwpk",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-5lzvwpk",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-eyqavxt",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-eyqavxt",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "创建pv，用于compact存储"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-qt2u0kh",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-qt2u0kh",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban thanos]# cat thanos-compact-pv.yaml \napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: thanos-compact-pv\nspec:\n  capacity:\n    storage: 10Gi\n  volumeMode: Filesystem\n  accessModes:\n  - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Delete\n  storageClassName: local-storage\n  local:\n    path: /data/thanos-compact\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n      - matchExpressions:\n        - key: kubernetes.io/hostname\n          operator: In\n          values:\n          - k8s-work3\n[root@tiaoban thanos]# kubectl apply -f thanos-compact-pv.yaml \npersistentvolume/thanos-compact-pv created\n[root@tiaoban thanos]# kubectl get pv\nNAME                CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM                        STORAGECLASS    REASON   AGE\nprometheus-pv1      10Gi       RWO            Delete           Bound       thanos/data-prometheus-0     local-storage            88m\nprometheus-pv2      10Gi       RWO            Delete           Bound       thanos/data-prometheus-1     local-storage            88m\nprometheus-pv3      10Gi       RWO            Delete           Bound       thanos/data-prometheus-2     local-storage            88m\nthanos-compact-pv   10Gi       RWO            Delete           Available                                local-storage            4s\nthanos-store-pv1    5Gi        RWO            Delete           Bound       thanos/data-thanos-store-0   local-storage            3m29s\nthanos-store-pv2    5Gi        RWO            Delete           Bound       thanos/data-thanos-store-1   local-storage            3m29s\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-6fwnj6j",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-6fwnj6j",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-hnt7uq4",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-hnt7uq4",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-jahtllg",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-jahtllg",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "部署thanos compact"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-55ud9tg",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20230420153245-55ud9tg",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20230420153245-8an2r2q",
					"Type": "NodeList",
					"ListData": {},
					"Properties": {
						"id": "20230420153245-8an2r2q",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-b53qms0",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-b53qms0",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-g0uha9y",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-g0uha9y",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "Compact 只能部署单个副本，因为如果多个副本都去对对象存储的数据做压缩和降采样的话，会造成冲突。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-1f7b3oo",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-1f7b3oo",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-cw9cnxx",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-cw9cnxx",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "使用 StatefulSet 部署，方便自动创建和挂载磁盘。磁盘用于存放临时数据，因为 Compact 需要一些磁盘空间来存放数据处理过程中产生的中间数据。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-jsom910",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-jsom910",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-ulyhc45",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-ulyhc45",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "–wait 让 Compact 一直运行，轮询新数据来做压缩和降采样。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-jouhdk1",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-jouhdk1",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-0xz9rg5",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-0xz9rg5",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "Compact 也需要对象存储的配置，用于读取对象存储数据以及上传压缩和降采样后的数据到对象存储。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-sqqeoki",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-sqqeoki",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-pcqffcb",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-pcqffcb",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "创建一个普通 service，主要用于被 Prometheus 使用 kubernetes 的 endpoints 服务发现来采集指标(其它组件的 service 也一样有这个用途)。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-emoogt2",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-emoogt2",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-q6iv3yp",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-q6iv3yp",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "–retention.resolution-raw 指定原始数据存放时长，–retention.resolution-5m 指定降采样到数据点 5 分钟间隔的数据存放时长，–retention.resolution-1h 指定降采样到数据点 1 小时间隔的数据存放时长，它们的数据精细程度递减，占用的存储空间也是递减，通常建议它们的存放时间递增配置 (一般只有比较新的数据才会放大看，久远的数据通常只会使用大时间范围查询来看个大致，所以建议将精细程度低的数据存放更长时间)"
										}
									]
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-3fgnsog",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-3fgnsog",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban thanos]# cat thanos-compact.yaml \napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app.kubernetes.io/name: thanos-compact\n  name: thanos-compact\n  namespace: thanos\nspec:\n  ports:\n  - name: http\n    port: 10902\n    targetPort: http\n  selector:\n    app.kubernetes.io/name: thanos-compact\n---\n\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  labels:\n    app.kubernetes.io/name: thanos-compact\n  name: thanos-compact\n  namespace: thanos\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: thanos-compact\n  serviceName: thanos-compact\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/name: thanos-compact\n    spec:\n      containers:\n      - args:\n        - compact\n        - --wait\n        - --objstore.config-file=/etc/thanos/storage.yaml\n        - --data-dir=/var/thanos/compact\n        - --debug.accept-malformed-index\n        - --log.level=debug\n        - --retention.resolution-raw=90d\n        - --retention.resolution-5m=180d\n        - --retention.resolution-1h=360d\n        image: thanosio/thanos:v0.23.0-rc.0\n        imagePullPolicy: IfNotPresent\n        resources:\n          limits:\n            memory: \"2048Mi\"\n            cpu: \"500m\" \n          requests:\n            memory: \"128Mi\"\n            cpu: \"100m\" \n        livenessProbe:\n          failureThreshold: 4\n          httpGet:\n            path: /-/healthy\n            port: 10902\n            scheme: HTTP\n          periodSeconds: 30\n        name: thanos-compact\n        ports:\n        - containerPort: 10902\n          name: http\n        readinessProbe:\n          failureThreshold: 20\n          httpGet:\n            path: /-/ready\n            port: 10902\n            scheme: HTTP\n          periodSeconds: 5\n        terminationMessagePolicy: FallbackToLogsOnError\n        volumeMounts:\n        - mountPath: /var/thanos/compact\n          name: data\n          readOnly: false\n        - name: thanos-storage-config\n          subPath: storage.yaml\n          mountPath: /etc/thanos/storage.yaml\n      terminationGracePeriodSeconds: 120\n      volumes:\n      - name: thanos-storage-config\n        configMap:\n          name: thanos-storage-config\n  volumeClaimTemplates:\n  - metadata:\n      name: data\n    spec:\n      accessModes:\n      - ReadWriteOnce\n      storageClassName: local-storage\n      resources:\n        requests:\n          storage: 10Gi\n[root@tiaoban thanos]# kubectl apply -f thanos-compact.yaml \nservice/thanos-compact created\nstatefulset.apps/thanos-compact created\n[root@tiaoban thanos]# kubectl get pod -n thanos \nNAME                           READY   STATUS    RESTARTS   AGE\nprometheus-0                   2/2     Running   1          40m\nprometheus-1                   2/2     Running   1          39m\nprometheus-2                   2/2     Running   1          40m\nthanos-compact-0               1/1     Running   0          8s\nthanos-query-5cd8dc8d7-rg75m   1/1     Running   0          26m\nthanos-query-5cd8dc8d7-xqbjp   1/1     Running   0          26m\nthanos-query-5cd8dc8d7-xth47   1/1     Running   0          26m\nthanos-store-0                 1/1     Running   0          7m23s\nthanos-store-1                 1/1     Running   0          7m23s\n[root@tiaoban thanos]# kubectl get pv\nNAME                CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                          STORAGECLASS    REASON   AGE\nprometheus-pv1      10Gi       RWO            Delete           Bound    thanos/data-prometheus-0       local-storage            92m\nprometheus-pv2      10Gi       RWO            Delete           Bound    thanos/data-prometheus-1       local-storage            92m\nprometheus-pv3      10Gi       RWO            Delete           Bound    thanos/data-prometheus-2       local-storage            92m\nthanos-compact-pv   10Gi       RWO            Delete           Bound    thanos/data-thanos-compact-0   local-storage            4m20s\nthanos-store-pv1    5Gi        RWO            Delete           Bound    thanos/data-thanos-store-0     local-storage            7m45s\nthanos-store-pv2    5Gi        RWO            Delete           Bound    thanos/data-thanos-store-1     local-storage            7m45s\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-dn9fsi3",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20230420153245-dn9fsi3",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "8. 部署Alertmanager"
				}
			]
		},
		{
			"ID": "20230420153245-g29kchj",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-g29kchj",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-nvc0r1b",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-nvc0r1b",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-l56clik",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-l56clik",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "创建alertmanager配置文件"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-a4r3yv5",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20230420153245-a4r3yv5",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20230420153245-syhz6vg",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20230420153245-syhz6vg",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "此处以最简单的webhook告警基础配置为例"
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-qyk60vc",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-qyk60vc",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban thanos]# cat alertmanager-config.yaml \nkind: ConfigMap\napiVersion: v1\nmetadata:\n  name: alertmanager-conf\n  namespace: thanos\ndata:\n  config.yaml: |-\n    global:\n      resolve_timeout: 5m\n    route:\n      group_by: ['alertname', 'cluster', 'service']\n      group_wait: 30s\n      group_interval: 5s\n      repeat_interval: 10s  \n      receiver: 'web.hook'\n    receivers:\n    - name: 'web.hook'\n      webhook_configs:\n      - url: 'http://127.0.0.1:5000'\n[root@tiaoban thanos]# kubectl apply -f alertmanager-config.yaml \nconfigmap/alertmanager-conf created\n[root@tiaoban thanos]# kubectl get configmaps -n thanos \nNAME                     DATA   AGE\nalertmanager-conf        1      10s\nprometheus-config-tmpl   1      94m\nprometheus-rules         1      94m\nthanos-storage-config    1      25m\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-xxe5nf9",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-xxe5nf9",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-svn46c7",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-svn46c7",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-br8n6em",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-br8n6em",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "部署alertmanager"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-d6r091x",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20230420153245-d6r091x",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20230420153245-vfmd7sf",
					"Type": "NodeList",
					"ListData": {},
					"Properties": {
						"id": "20230420153245-vfmd7sf",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-9jabx3h",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-9jabx3h",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-wrqdz28",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-wrqdz28",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "因为alertmanager是无状态的，使用 Deployment 部署，也不需要 headless service，直接创建普通的 service。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-g7hm5zj",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-g7hm5zj",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-oxsxsjt",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-oxsxsjt",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "使用软反亲和，尽量不让 Query 调度到同一节点。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-q2an44h",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-q2an44h",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-lddjj9j",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-lddjj9j",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "部署多个副本，实现alertmanager的高可用。"
										}
									]
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-w92smaz",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-w92smaz",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban thanos]# cat alertmanager.yaml \napiVersion: v1\nkind: Service\nmetadata:\n  name: alertmanager\n  namespace: thanos\nspec:\n  selector:\n    app: alertmanager\n  ports:\n  - name: alertmanager\n    protocol: TCP\n    port: 9093\n    targetPort: 9093\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: alertmanager\n  namespace: thanos\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: alertmanager\n  template:\n    metadata:\n      name: alertmanager\n      labels:\n        app: alertmanager\n    spec:\n      containers:\n      - name: alertmanager\n        image: prom/alertmanager:v0.23.0\n        imagePullPolicy: IfNotPresent\n        resources:\n          limits:\n            memory: \"512Mi\"\n            cpu: \"1000m\"\n          requests:\n            memory: \"128Mi\"\n            cpu: \"500m\"\n        args:\n          - '--config.file=/etc/alertmanager/config.yaml'\n          - '--storage.path=/alertmanager'\n        ports:\n        - name: alertmanager\n          containerPort: 9093\n        volumeMounts:\n        - name: alertmanager-conf\n          mountPath: /etc/alertmanager\n        - name: alertmanager\n          mountPath: /alertmanager\n      affinity:\n        podAntiAffinity:\n          requiredDuringSchedulingIgnoredDuringExecution:\n          - labelSelector:\n              matchExpressions:\n              - key: app\n                operator: In\n                values:\n                - alertmanager\n            topologyKey: \"kubernetes.io/hostname\"\n      volumes:\n      - name: alertmanager-conf\n        configMap:\n          name: alertmanager-conf\n      - name: alertmanager\n        emptyDir: {}\n[root@tiaoban thanos]# kubectl apply -f alertmanager.yaml \nservice/alertmanager created\ndeployment.apps/alertmanager created\n[root@tiaoban thanos]# kubectl get pod -n thanos \nNAME                            READY   STATUS    RESTARTS   AGE\nalertmanager-54d948fdf7-6gpc4   1/1     Running   0          25s\nalertmanager-54d948fdf7-qqvmp   1/1     Running   0          25s\nprometheus-0                    2/2     Running   1          50m\nprometheus-1                    2/2     Running   1          50m\nprometheus-2                    2/2     Running   1          50m\nthanos-compact-0                1/1     Running   0          10m\nthanos-query-5cd8dc8d7-rg75m    1/1     Running   0          36m\nthanos-query-5cd8dc8d7-xqbjp    1/1     Running   0          36m\nthanos-query-5cd8dc8d7-xth47    1/1     Running   0          36m\nthanos-store-0                  1/1     Running   0          17m\nthanos-store-1                  1/1     Running   0          17m\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-mvqhg7q",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20230420153245-mvqhg7q",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "9. 部署Node-Exporter"
				}
			]
		},
		{
			"ID": "20230420153245-qcu0wtc",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-qcu0wtc",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-pwcg9im",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-pwcg9im",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-1nuzs9w",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-1nuzs9w",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "部署node-exporter使用daemonset即可。记得挂载proc、sys、root，使用宿主机网络和pid"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-ozere5w",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-ozere5w",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban thanos]# cat node-exporter.yaml \napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  labels:\n    app: node-exporter\n  name: node-exporter\n  namespace: thanos\nspec:\n  selector:\n    matchLabels:\n      app: node-exporter\n  template:\n    metadata:\n      labels:\n        app: node-exporter\n    spec:\n      containers:\n      - args:\n        - --path.procfs=/host/proc\n        - --path.sysfs=/host/sys\n        - --path.rootfs=/host/root\n        image: prom/node-exporter:v1.2.2\n        name: node-exporter\n        resources:\n          limits:\n            cpu: 250m\n            memory: 180Mi\n          requests:\n            cpu: 100m\n            memory: 100Mi\n        volumeMounts:\n        - mountPath: /host/proc\n          name: proc\n          readOnly: false\n        - mountPath: /host/sys\n          name: sys\n          readOnly: false\n        - mountPath: /host/root\n          mountPropagation: HostToContainer\n          name: root\n          readOnly: true\n        ports:\n        - name: node-exporter\n          hostPort: 9100\n          containerPort: 9100\n          protocol: TCP\n      hostNetwork: true\n      hostPID: true\n      nodeSelector:\n        kubernetes.io/os: linux\n      securityContext:\n        runAsNonRoot: true\n        runAsUser: 65534\n      tolerations:\n      - operator: Exists\n      volumes:\n      - hostPath:\n          path: /proc\n        name: proc\n      - hostPath:\n          path: /sys\n        name: sys\n      - hostPath:\n          path: /\n        name: root\n[root@tiaoban thanos]# kubectl apply -f node-exporter.yaml \ndaemonset.apps/node-exporter created\n[root@tiaoban thanos]# kubectl get pod -n thanos -o wide -l app=node-exporter\nNAME                  READY   STATUS    RESTARTS   AGE     IP              NODE         NOMINATED NODE   READINESS GATES\nnode-exporter-4g577   1/1     Running   0          5m23s   192.168.10.13   k8s-work3    \u003cnone\u003e           \u003cnone\u003e\nnode-exporter-76phm   1/1     Running   0          5m23s   192.168.10.10   k8s-master   \u003cnone\u003e           \u003cnone\u003e\nnode-exporter-hb6p6   1/1     Running   0          5m23s   192.168.10.11   k8s-work1    \u003cnone\u003e           \u003cnone\u003e\nnode-exporter-hz8x9   1/1     Running   0          5m23s   192.168.10.12   k8s-work2    \u003cnone\u003e           \u003cnone\u003e\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-2a8tf8p",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20230420153245-2a8tf8p",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "10. 部署kube-state-metrics"
				}
			]
		},
		{
			"ID": "20230420153245-8kosjvf",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20230420153245-8kosjvf",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20230420153245-iccmd2d",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20230420153245-iccmd2d",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "如果已经部署过该组件直接跳过进行下一步，记得将server允许prometheus自动发现"
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-t6pzj87",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-t6pzj87",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-jcu6tud",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-jcu6tud",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-d8bd4tq",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-d8bd4tq",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "版本依赖\n| "
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "strong",
									"TextMarkTextContent": "kube-state-metrics"
								},
								{
									"Type": "NodeText",
									"Data": " | "
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "strong",
									"TextMarkTextContent": "Kubernetes 1.18"
								},
								{
									"Type": "NodeText",
									"Data": " | "
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "strong",
									"TextMarkTextContent": "Kubernetes 1.19"
								},
								{
									"Type": "NodeText",
									"Data": " | "
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "strong",
									"TextMarkTextContent": "Kubernetes 1.20"
								},
								{
									"Type": "NodeText",
									"Data": " | "
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "strong",
									"TextMarkTextContent": "Kubernetes 1.21"
								},
								{
									"Type": "NodeText",
									"Data": " | "
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "strong",
									"TextMarkTextContent": "Kubernetes 1.22"
								},
								{
									"Type": "NodeText",
									"Data": " |\n| — | — | — | — | — | — |\n| "
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "strong",
									"TextMarkTextContent": "v1.9.8"
								},
								{
									"Type": "NodeText",
									"Data": " | - | - | - | - | - |\n| "
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "strong",
									"TextMarkTextContent": "v2.0.0"
								},
								{
									"Type": "NodeText",
									"Data": " | -/✓ | ✓ | ✓ | -/✓ | -/✓ |\n| "
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "strong",
									"TextMarkTextContent": "v2.1.1"
								},
								{
									"Type": "NodeText",
									"Data": " | -/✓ | ✓ | ✓ | ✓ | -/✓ |\n| "
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "strong",
									"TextMarkTextContent": "v2.2.0"
								},
								{
									"Type": "NodeText",
									"Data": " | -/✓ | ✓ | ✓ | ✓ | ✓ |\n| "
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "strong",
									"TextMarkTextContent": "master"
								},
								{
									"Type": "NodeText",
									"Data": " | -/✓ | ✓ | ✓ | ✓ | ✓ |"
								}
							]
						}
					]
				},
				{
					"ID": "20230420153245-2n4n9ds",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-2n4n9ds",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-3uu7x62",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-3uu7x62",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "克隆项目至本地"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-75pwlt5",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-75pwlt5",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "git clone https://github.com/kubernetes/kube-state-metrics.git\ncd kube-state-metrics/examples/standard/\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-k9aalhu",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-k9aalhu",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-6a1u0n2",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-6a1u0n2",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-036kh8v",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-036kh8v",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "修改service，允许prometheus自动发现"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-13yk5gf",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-13yk5gf",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "vim service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app.kubernetes.io/name: kube-state-metrics\n    app.kubernetes.io/version: 2.2.0\n  name: kube-state-metrics\n  namespace: kube-system\n  annotations:  \n    prometheus.io/scrape: \"true\"       ##添加此参数，允许prometheus自动发现\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-a6aihja",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-a6aihja",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-l5qs4kt",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-l5qs4kt",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-pwejy1v",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-pwejy1v",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "创建资源"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-twzakza",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-twzakza",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "kubectl apply -f .\n[root@tiaoban standard]# kubectl get pod -n kube-system -l app.kubernetes.io/name=kube-state-metrics\nNAME                                 READY   STATUS    RESTARTS   AGE\nkube-state-metrics-bb59558c8-cx9pz   1/1     Running   0          1m\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-7597xbt",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-7597xbt",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-auq52db",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-auq52db",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-vjoqnhf",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-vjoqnhf",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "使用kubectl top node查看结果"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-ni5ngqm",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-ni5ngqm",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban  ~]# kubectl top node \nNAME         CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%\nk8s-master   422m         10%    1471Mi          40%\nk8s-work1    268m         6%     1197Mi          33%\nk8s-work2    239m         5%     1286Mi          35%\nk8s-work3    320m         8%     1091Mi          30%\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-tjbqccs",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20230420153245-tjbqccs",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "11. 部署grafana"
				}
			]
		},
		{
			"ID": "20230420153245-pd8enq4",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20230420153245-pd8enq4",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20230420153245-gcfwkng",
					"Type": "NodeList",
					"ListData": {},
					"Properties": {
						"id": "20230420153245-gcfwkng",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-liwfhiw",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-liwfhiw",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-zg80xux",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-zg80xux",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "grafana服务与数据非强关联，使用 Deployment 部署，创建普通的 service。然后挂载pvc即可"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-o8blwel",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-o8blwel",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-bnd2axc",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-bnd2axc",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "部署多个副本，实现alertmanager的高可用。"
										}
									]
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-f9wig6m",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-f9wig6m",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-f2gj0q9",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-f2gj0q9",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-abckgjx",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-abckgjx",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "创建pv和pvc。用于存储grafana数据"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-nvv949n",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-nvv949n",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban thanos]# cat grafana-storage.yaml \nkind: PersistentVolumeClaim\napiVersion: v1\nmetadata:\n  name: grafana-pvc\n  namespace: thanos\nspec:\n  accessModes:\n  - ReadWriteMany\n  resources:\n    requests:\n      storage: 5Gi\n  storageClassName: local-storage\n---\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: grafana-pv\nspec:\n  capacity:\n    storage: 5Gi\n  volumeMode: Filesystem\n  accessModes:\n  - ReadWriteMany\n  persistentVolumeReclaimPolicy: Delete\n  storageClassName: local-storage\n  local:\n    path: /data/grafana\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n      - matchExpressions:\n        - key: kubernetes.io/hostname\n          operator: In\n          values:\n          - k8s-work1\n[root@tiaoban thanos]# kubectl apply -f grafana-storage.yaml \npersistentvolumeclaim/grafana-pvc created\npersistentvolume/grafana-pv created\n[root@tiaoban thanos]# kubectl get pvc -n thanos \nNAME                    STATUS    VOLUME              CAPACITY   ACCESS MODES   STORAGECLASS    AGE\ndata-prometheus-0       Bound     prometheus-pv1      10Gi       RWO            local-storage   112m\ndata-prometheus-1       Bound     prometheus-pv2      10Gi       RWO            local-storage   112m\ndata-prometheus-2       Bound     prometheus-pv3      10Gi       RWO            local-storage   112m\ndata-thanos-compact-0   Bound     thanos-compact-pv   10Gi       RWO            local-storage   44m\ndata-thanos-store-0     Bound     thanos-store-pv1    5Gi        RWO            local-storage   51m\ndata-thanos-store-1     Bound     thanos-store-pv2    5Gi        RWO            local-storage   51m\ngrafana-pvc             Pending                                                 local-storage   30s.\n[root@tiaoban thanos]# kubectl get pv\nNAME                CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM                          STORAGECLASS    REASON   AGE\ngrafana-pv          5Gi        RWX            Delete           Available                                  local-storage            41s\nprometheus-pv1      10Gi       RWO            Delete           Bound       thanos/data-prometheus-0       local-storage            137m\nprometheus-pv2      10Gi       RWO            Delete           Bound       thanos/data-prometheus-1       local-storage            137m\nprometheus-pv3      10Gi       RWO            Delete           Bound       thanos/data-prometheus-2       local-storage            137m\nthanos-compact-pv   10Gi       RWO            Delete           Bound       thanos/data-thanos-compact-0   local-storage            48m\nthanos-store-pv1    5Gi        RWO            Delete           Bound       thanos/data-thanos-store-0     local-storage            52m\nthanos-store-pv2    5Gi        RWO            Delete           Bound       thanos/data-thanos-store-1     local-storage            52m\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-56e905n",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-56e905n",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-o05qs22",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-o05qs22",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-1mvsc3z",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-1mvsc3z",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "部署grafana"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-a358mo7",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-a358mo7",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban thanos]# cat grafana.yaml \napiVersion: v1\nkind: Service\nmetadata:\n  name: grafana\n  namespace: thanos\nspec:\n  ports:\n  - port: 3000\n    targetPort: 3000\n  selector:\n    name: grafana\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: grafana\n  namespace: thanos\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      name: grafana\n  template:\n    metadata:\n      labels:\n        name: grafana\n    spec:\n      containers:\n      - name: grafana\n        image: grafana/grafana:8.1.3\n        resources:\n          limits:\n            memory: \"1024Mi\"\n            cpu: \"1000m\"\n          requests:\n            memory: \"128Mi\"\n            cpu: \"500m\"\n        readinessProbe:\n          failureThreshold: 10\n          httpGet:\n            path: /api/health\n            port: 3000\n            scheme: HTTP\n          initialDelaySeconds: 60\n          periodSeconds: 10\n          successThreshold: 1\n          timeoutSeconds: 30\n        livenessProbe:\n          failureThreshold: 3\n          httpGet:\n            path: /api/health\n            port: 3000\n            scheme: HTTP\n          periodSeconds: 10\n          successThreshold: 1\n          timeoutSeconds: 1\n        ports:\n        - containerPort: 3000\n          protocol: TCP\n        volumeMounts:\n        - mountPath: /var/lib/grafana\n          name: grafana-storage\n        env:\n        - name: GF_SECURITY_ADMIN_USER\n          value: admin\n        - name: GF_SECURITY_ADMIN_PASSWORD\n          value: 123.com\n      volumes:\n      - name: grafana-storage\n        persistentVolumeClaim:\n          claimName: grafana-pvc\n[root@tiaoban thanos]# kubectl apply -f grafana.yaml \nservice/grafana created\ndeployment.apps/grafana created\n[root@tiaoban thanos]# kubectl get pod -n thanos -o wide -l name=grafana\nNAME                      READY   STATUS    RESTARTS   AGE   IP             NODE        NOMINATED NODE   READINESS GATES\ngrafana-56c9c5f87-stf2q   1/1     Running   0          80s   10.244.3.132   k8s-work1   \u003cnone\u003e           \u003cnone\u003e\ngrafana-56c9c5f87-xvxzc   1/1     Running   0          80s   10.244.3.133   k8s-work1   \u003cnone\u003e           \u003cnone\u003e\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-jf990sd",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20230420153245-jf990sd",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "12. 部署ingress"
				}
			]
		},
		{
			"ID": "20230420153245-f9di19f",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20230420153245-f9di19f",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20230420153245-6m2ng1d",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20230420153245-6m2ng1d",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "本次实验使用的ingress为traefik"
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-czlmgjj",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-czlmgjj",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-ok9nsq7",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-ok9nsq7",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-pi3qcoh",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-pi3qcoh",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "查看thanos命名空间下的服务"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-wjrfgrb",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-wjrfgrb",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban thanos]# kubectl get svc -n thanos \nNAME                  TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)               AGE\nalertmanager          ClusterIP   10.98.194.253    \u003cnone\u003e        9093/TCP              43m\ngrafana               ClusterIP   10.107.15.87     \u003cnone\u003e        3000/TCP              2m31s\nprometheus-headless   ClusterIP   None             \u003cnone\u003e        9090/TCP,10901/TCP    98m\nthanos-compact        ClusterIP   10.106.179.2     \u003cnone\u003e        10902/TCP             53m\nthanos-query          ClusterIP   10.110.129.217   \u003cnone\u003e        10901/TCP,9090/TCP    79m\nthanos-store          ClusterIP   None             \u003cnone\u003e        10901/TCP,10902/TCP   60m\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-a39q9um",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-a39q9um",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-omkms34",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-omkms34",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-vehx182",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-vehx182",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "依次对alertmanager、grafana、thanos-query、prometheus创建ingress"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-ck6ox52",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-ck6ox52",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban thanos]# cat alertmanager-ingress.yaml \napiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: alertmanager\n  namespace: thanos\nspec:\n  routes:\n    - match: Host(`alertmanager.local.com`)\n      kind: Rule\n      services:\n        - name: alertmanager\n          port: 9093\n[root@tiaoban thanos]# kubectl apply -f alertmanager.yaml \nservice/alertmanager unchanged\ndeployment.apps/alertmanager configured\n[root@tiaoban thanos]# cat alertmanager-ingress.yaml \napiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: alertmanager\n  namespace: thanos\nspec:\n  routes:\n    - match: Host(`alertmanager.local.com`)\n      kind: Rule\n      services:\n        - name: alertmanager\n          port: 9093\n[root@tiaoban thanos]# kubectl apply -f alertmanager-ingress.yaml \ningressroute.traefik.containo.us/alertmanager created\n[root@tiaoban thanos]# cat grafana-ingress.yaml \napiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: grafana\n  namespace: thanos\nspec:\n  routes:\n    - match: Host(`grafana.local.com`)\n      kind: Rule\n      services:\n        - name: grafana\n          port: 3000\n[root@tiaoban thanos]# kubectl apply -f grafana-ingress.yaml \ningressroute.traefik.containo.us/grafana created\n[root@tiaoban thanos]# cat thanos-query-ingress.yaml \napiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: thanos-querier\n  namespace: thanos\nspec:\n  routes:\n    - match: Host(`thanos-querier.local.com`)\n      kind: Rule\n      services:\n        - name: thanos-query\n          port: 9090\n[root@tiaoban thanos]# kubectl apply -f thanos-query-ingress.yaml \ningressroute.traefik.containo.us/thanos-querier created\n[root@tiaoban thanos]# cat prometheus-ingress.yaml \napiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: prometheus\n  namespace: thanos\nspec:\n  routes:\n    - match: Host(`prometheus.local.com`)\n      kind: Rule\n      services:\n        - name: prometheus-headless\n          port: 9090\n[root@tiaoban thanos]# kubectl apply -f prometheus-ingress.yaml \ningressroute.traefik.containo.us/prometheus created\n[root@tiaoban thanos]# kubectl get ingressroute -n thanos \nNAME             AGE\nalertmanager     88s\ngrafana          71s\nprometheus       7s\nthanos-querier   27s\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-ynsh5jv",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-ynsh5jv",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-7cbyotq",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-7cbyotq",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-ntwk3nw",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-ntwk3nw",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "修改hosts文件，访问测试"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-nt8i1ek",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-nt8i1ek",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "192.168.10.10 prometheus.local.com\n192.168.10.10 thanos-querier.local.com\n192.168.10.10 grafana.local.com\n192.168.10.10 alertmanager.local.com\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-5wvr4r7",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-5wvr4r7",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-2swa8q8",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-2swa8q8",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-wpaah7j",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-wpaah7j",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "prometheus"
								},
								{
									"Type": "NodeImage",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeBang"
										},
										{
											"Type": "NodeOpenBracket"
										},
										{
											"Type": "NodeLinkText",
											"Data": "image.png"
										},
										{
											"Type": "NodeCloseBracket"
										},
										{
											"Type": "NodeOpenParen"
										},
										{
											"Type": "NodeLinkDest",
											"Data": "assets/imgProxy-20230420153245-ee4cn5o.png"
										},
										{
											"Type": "NodeCloseParen"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "​"
								}
							]
						}
					]
				},
				{
					"ID": "20230420153245-3439jwh",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-3439jwh",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-fx1iulg",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-fx1iulg",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "alertmanager"
								},
								{
									"Type": "NodeImage",
									"Data": "span",
									"Children": [
										{
											"Type": "NodeBang"
										},
										{
											"Type": "NodeOpenBracket"
										},
										{
											"Type": "NodeLinkText",
											"Data": "image.png"
										},
										{
											"Type": "NodeCloseBracket"
										},
										{
											"Type": "NodeOpenParen"
										},
										{
											"Type": "NodeLinkDest",
											"Data": "assets/imgProxy-20230420153245-uqyq7fk.png"
										},
										{
											"Type": "NodeCloseParen"
										}
									]
								},
								{
									"Type": "NodeText",
									"Data": "​"
								}
							]
						}
					]
				},
				{
					"ID": "20230420153245-hkn7ik5",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-hkn7ik5",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-t3orkri",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-t3orkri",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "thanos-querier"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-7mwz4ql",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230420153245-7mwz4ql",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "​"
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "image.png"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "assets/imgProxy-20230420153245-hebcdd8.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20230420153245-nbp8dyl",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-nbp8dyl",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-0xh4czu",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-0xh4czu",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-43jz7a5",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-43jz7a5",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "grafana"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-tj33kw1",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230420153245-tj33kw1",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "​"
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "image.png"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "assets/imgProxy-20230420153245-167eh4i.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20230420153245-n61u1wj",
			"Type": "NodeHeading",
			"HeadingLevel": 2,
			"Properties": {
				"id": "20230420153245-n61u1wj",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "四、thanos部署（可选组件）"
				}
			]
		},
		{
			"ID": "20230420153245-51imrvy",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20230420153245-51imrvy",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "1. 部署Ruler"
				}
			]
		},
		{
			"ID": "20230420153245-ei9w49h",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230420153245-ei9w49h",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "推荐尽量使用 Prometheus 自带的 rule 功能 (生成新指标+告警)，这个功能需要一些 Prometheus 最新数据，直接使用 Prometheus 本机 rule 功能和数据，性能开销相比 Thanos Ruler 这种分布式方案小得多，并且几乎不会出错。\n如果某些有关联的数据分散在多个不同 Prometheus 上，比如对某个大规模服务采集做了分片，每个 Prometheus 仅采集一部分 endpoint 的数据，对于 record 类型的 rule (生成的新指标)，还是可以使用 Prometheus 自带的 rule 功能，在查询时再聚合一下就可以(如果可以接受的话)；对于 alert 类型的 rule，就需要用 Thanos Ruler 来做了，因为有关联的数据分散在多个 Prometheus 上，用单机数据去做 alert 计算是不准确的，就可能会造成误告警或不告警。"
				}
			]
		},
		{
			"ID": "20230420153245-eotl66f",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-eotl66f",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-lr0ln3b",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-lr0ln3b",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-zwj9r4q",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-zwj9r4q",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "创建pv资源，用于ruler存储"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-i7s6i07",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-i7s6i07",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban other]# cat thanos-ruler-pv.yaml \napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: thanos-ruler-pv1\nspec:\n  capacity:\n    storage: 5Gi\n  volumeMode: Filesystem\n  accessModes:\n  - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Delete\n  storageClassName: local-storage\n  local:\n    path: /data/thanos-ruler\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n      - matchExpressions:\n        - key: kubernetes.io/hostname\n          operator: In\n          values:\n          - k8s-work2\n---\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: thanos-ruler-pv2\nspec:\n  capacity:\n    storage: 5Gi\n  volumeMode: Filesystem\n  accessModes:\n  - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Delete\n  storageClassName: local-storage\n  local:\n    path: /data/thanos-ruler\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n      - matchExpressions:\n        - key: kubernetes.io/hostname\n          operator: In\n          values:\n          - k8s-work3\n[root@tiaoban other]# kubectl apply -f thanos-ruler-pv.yaml \npersistentvolume/thanos-ruler-pv1 created\npersistentvolume/thanos-ruler-pv2 created\n[root@tiaoban other]# kubectl get pv\nNAME                CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM                          STORAGECLASS    REASON   AGE\ngrafana-pv          5Gi        RWX            Delete           Bound       thanos/grafana-pvc             local-storage            9h\nprometheus-pv1      10Gi       RWO            Delete           Bound       thanos/data-prometheus-0       local-storage            11h\nprometheus-pv2      10Gi       RWO            Delete           Bound       thanos/data-prometheus-1       local-storage            11h\nprometheus-pv3      10Gi       RWO            Delete           Bound       thanos/data-prometheus-2       local-storage            11h\nthanos-compact-pv   10Gi       RWO            Delete           Bound       thanos/data-thanos-compact-0   local-storage            10h\nthanos-ruler-pv1    5Gi        RWO            Delete           Available                                  local-storage            36s\nthanos-ruler-pv2    5Gi        RWO            Delete           Available                                  local-storage            36s\nthanos-store-pv1    5Gi        RWO            Delete           Bound       thanos/data-thanos-store-0     local-storage            10h\nthanos-store-pv2    5Gi        RWO            Delete           Bound       thanos/data-thanos-store-1     local-storage            10h\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-f1ws6fu",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-f1ws6fu",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-97wjwlh",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-97wjwlh",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-i0apj1a",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-i0apj1a",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "创建ruler配置文件"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-jczz4hx",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-jczz4hx",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban other]# cat thanos-ruler-config.yaml \napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: thanos-rules\n  labels:\n    name: thanos-rules\n  namespace: thanos\ndata:\n  record.rules.yaml: |-\n    groups:\n    - name: k8s.rules\n      rules:\n      - expr: |\n          sum(rate(container_cpu_usage_seconds_total{job=\"cadvisor\", image!=\"\", container!=\"\"}[5m])) by (namespace)\n        record: namespace:container_cpu_usage_seconds_total:sum_rate\n      - expr: |\n          sum(container_memory_usage_bytes{job=\"cadvisor\", image!=\"\", container!=\"\"}) by (namespace)\n        record: namespace:container_memory_usage_bytes:sum\n      - expr: |\n          sum by (namespace, pod, container) (\n            rate(container_cpu_usage_seconds_total{job=\"cadvisor\", image!=\"\", container!=\"\"}[5m])\n          )\n        record: namespace_pod_container:container_cpu_usage_seconds_total:sum_rate\n[root@tiaoban other]# kubectl apply -f thanos-ruler-config.yaml \nconfigmap/thanos-rules created\n[root@tiaoban other]# kubectl get configmaps -n thanos \nNAME                     DATA   AGE\nalertmanager-conf        1      10h\nprometheus-config-tmpl   1      12h\nprometheus-rules         1      12h\nthanos-rules             1      3m46s\nthanos-storage-config    1      10h\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-mt926mo",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-mt926mo",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-qrjminx",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-qrjminx",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-8cmn8k2",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-8cmn8k2",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "部署ruler"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-29ywnjd",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20230420153245-29ywnjd",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20230420153245-zm5ux8o",
					"Type": "NodeList",
					"ListData": {},
					"Properties": {
						"id": "20230420153245-zm5ux8o",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-v2pyz0o",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-v2pyz0o",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-gsc2353",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-gsc2353",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "Ruler 是有状态服务，使用 Statefulset 部署，挂载磁盘以便存储根据 rule 配置计算出的新数据。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-k0jmthm",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-k0jmthm",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-3k9ddqn",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-3k9ddqn",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "同样创建 headless service，用于 Query 对 Ruler 进行服务发现。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-kflyxer",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-kflyxer",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-83b88cq",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-83b88cq",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "部署两个副本，且使用 --label=rule_replica= 给所有数据添加 rule_replica 的 label (与 Query 配置的 replica_label 相呼应)，用于实现 Ruler 高可用。同时指定 --alert.label-drop 为 rule_replica，在触发告警发送通知给 AlertManager 时，去掉这个 label，以便让 AlertManager 自动去重 (避免重复告警)。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-j6lrgkd",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-j6lrgkd",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-k8rxo6y",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-k8rxo6y",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "使用 --query 指定 Query 地址，这里还是用 DNS SRV 来做服务发现，但效果跟配 dns+thanos-query.thanos.svc.cluster.local:9090 是一样的，最终都是通过 Query 的 ClusterIP (VIP) 访问，因为它是无状态的，可以直接由 K8S 来给我们做负载均衡。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-lszzym4",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-lszzym4",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-5ay28u3",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-5ay28u3",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "Ruler 也需要对象存储的配置，用于上传计算出的数据到对象存储，所以要挂载对象存储的配置文件。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-736q0ry",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-736q0ry",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-0ineh39",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-0ineh39",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "–rule-file 指定挂载的 rule 配置，Ruler 根据配置来生成数据和触发告警。"
										}
									]
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-00fbipa",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-00fbipa",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban other]# cat thanos-ruler.yaml \napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app.kubernetes.io/name: thanos-rule\n  name: thanos-rule\n  namespace: thanos\nspec:\n  clusterIP: None\n  ports:\n  - name: grpc\n    port: 10901\n    targetPort: grpc\n  - name: http\n    port: 10902\n    targetPort: http\n  selector:\n    app.kubernetes.io/name: thanos-rule\n---\n\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  labels:\n    app.kubernetes.io/name: thanos-rule\n  name: thanos-rule\n  namespace: thanos\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: thanos-rule\n  serviceName: thanos-rule\n  podManagementPolicy: Parallel\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/name: thanos-rule\n    spec:\n      containers:\n      - args:\n        - rule\n        - --grpc-address=0.0.0.0:10901\n        - --http-address=0.0.0.0:10902\n        - --rule-file=/etc/thanos/rules/*rules.yaml\n        - --data-dir=/var/thanos/rule\n        - --label=rule_replica=\"$(NAME)\"\n        - --alert.label-drop=\"rule_replica\"\n        - --query=dnssrv+_http._tcp.thanos-query.thanos.svc.cluster.local\n        env:\n        - name: NAME\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.name\n        image: thanosio/thanos:v0.23.0-rc.0\n        imagePullPolicy: IfNotPresent\n        resources:\n          limits:\n            memory: \"2048Mi\"\n            cpu: \"500m\" \n          requests:\n            memory: \"128Mi\"\n            cpu: \"100m\" \n        livenessProbe:\n          failureThreshold: 24\n          httpGet:\n            path: /-/healthy\n            port: 10902\n            scheme: HTTP\n          periodSeconds: 5\n        name: thanos-rule\n        ports:\n        - containerPort: 10901\n          name: grpc\n        - containerPort: 10902\n          name: http\n        readinessProbe:\n          failureThreshold: 18\n          httpGet:\n            path: /-/ready\n            port: 10902\n            scheme: HTTP\n          initialDelaySeconds: 10\n          periodSeconds: 5\n        terminationMessagePolicy: FallbackToLogsOnError\n        volumeMounts:\n        - mountPath: /var/thanos/rule\n          name: data\n          readOnly: false\n        - name: thanos-rules\n          mountPath: /etc/thanos/rules\n      volumes:\n      - name: thanos-rules\n        configMap:\n          name: thanos-rules\n  volumeClaimTemplates:\n  - metadata:\n      name: data\n    spec:\n      accessModes:\n      - ReadWriteOnce\n      storageClassName: local-storage\n      resources:\n        requests:\n          storage: 5Gi\n[root@tiaoban other]# kubectl apply -f thanos-ruler.yaml \nservice/thanos-rule created\nstatefulset.apps/thanos-rule created\n[root@tiaoban other]# kubectl get pod -n thanos -o wide -l app.kubernetes.io/name=thanos-rule\nNAME            READY   STATUS    RESTARTS   AGE     IP             NODE        NOMINATED NODE   READINESS GATES\nthanos-rule-0   1/1     Running   0          6m53s   10.244.1.106   k8s-work2   \u003cnone\u003e           \u003cnone\u003e\nthanos-rule-1   1/1     Running   0          6m53s   10.244.2.100   k8s-work3   \u003cnone\u003e           \u003cnone\u003e\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-ou7nwj0",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-ou7nwj0",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-zfcx3ac",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-zfcx3ac",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-tgl124r",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-tgl124r",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "部署ingress"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-r4jaa5b",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-r4jaa5b",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban other]# cat thanos-ruler-ingress.yaml \napiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: thanos-rule\n  namespace: thanos\nspec:\n  routes:\n    - match: Host(`thanos-rule.local.com`)\n      kind: Rule\n      services:\n        - name: thanos-rule\n          port: 10902\n[root@tiaoban other]# kubectl apply -f thanos-ruler-ingress.yaml \n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-o9my2gt",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20230420153245-o9my2gt",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "2. 部署Receiver"
				}
			]
		},
		{
			"ID": "20230420153245-8mjnqrm",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230420153245-8mjnqrm",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "Receiver 是让 Prometheus 通过 remote wirte API 将数据 push 到 Receiver 集中存储 。\n如果你的 Query 跟 Sidecar 离的比较远，比如 Sidecar 分布在多个数据中心，Query 向所有 Sidecar 查数据，速度会很慢，这种情况可以考虑用 Receiver，将数据集中吐到 Receiver，然后 Receiver 与 Query 部署在一起，Query 直接向 Receiver 查最新数据，提升查询性能。\nSidecar和Receiver功能相似，都是获取prometheus的数据给thanos。区别在于sidecar采用边车模式读取prometheus数据，而receiver相当于存储服务，prometheus数据。当使用了Receiver 来统一接收 Prometheus 的数据时，Prometheus 不需要部署Sidecar"
				}
			]
		},
		{
			"ID": "20230420153245-sxds5ca",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-sxds5ca",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-gkrrtyz",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-gkrrtyz",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-jkujn4q",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-jkujn4q",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "创建pv资源，用于receiver存储"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-mgdq086",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-mgdq086",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban other]# cat thanos-receiver-pv.yaml \napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: thanos-receiver-pv1\nspec:\n  capacity:\n    storage: 10Gi\n  volumeMode: Filesystem\n  accessModes:\n  - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Delete\n  storageClassName: local-storage\n  local:\n    path: /data/thanos-receiver\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n      - matchExpressions:\n        - key: kubernetes.io/hostname\n          operator: In\n          values:\n          - k8s-work1\n---\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: thanos-receiver-pv2\nspec:\n  capacity:\n    storage: 10Gi\n  volumeMode: Filesystem\n  accessModes:\n  - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Delete\n  storageClassName: local-storage\n  local:\n    path: /data/thanos-receiver\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n      - matchExpressions:\n        - key: kubernetes.io/hostname\n          operator: In\n          values:\n          - k8s-work2\n---\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: thanos-receiver-pv3\nspec:\n  capacity:\n    storage: 10Gi\n  volumeMode: Filesystem\n  accessModes:\n  - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Delete\n  storageClassName: local-storage\n  local:\n    path: /data/thanos-receiver\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n      - matchExpressions:\n        - key: kubernetes.io/hostname\n          operator: In\n          values:\n          - k8s-work3\n[root@tiaoban other]# kubectl apply -f thanos-receiver-pv.yaml \npersistentvolume/thanos-receiver-pv1 created\npersistentvolume/thanos-receiver-pv2 created\npersistentvolume/thanos-receiver-pv3 created\n[root@tiaoban other]# kubectl get pv\nNAME                  CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM                          STORAGECLASS    REASON   AGE\ngrafana-pv            5Gi        RWX            Delete           Bound       thanos/grafana-pvc             local-storage            10h\nprometheus-pv1        10Gi       RWO            Delete           Bound       thanos/data-prometheus-0       local-storage            12h\nprometheus-pv2        10Gi       RWO            Delete           Bound       thanos/data-prometheus-1       local-storage            12h\nprometheus-pv3        10Gi       RWO            Delete           Bound       thanos/data-prometheus-2       local-storage            12h\nthanos-compact-pv     10Gi       RWO            Delete           Bound       thanos/data-thanos-compact-0   local-storage            11h\nthanos-receiver-pv1   10Gi       RWO            Delete           Available                                  local-storage            4s\nthanos-receiver-pv2   10Gi       RWO            Delete           Available                                  local-storage            3s\nthanos-receiver-pv3   10Gi       RWO            Delete           Available                                  local-storage            3s\nthanos-ruler-pv1      5Gi        RWO            Delete           Bound       thanos/data-thanos-rule-0      local-storage            45m\nthanos-ruler-pv2      5Gi        RWO            Delete           Bound       thanos/data-thanos-rule-1      local-storage            45m\nthanos-store-pv1      5Gi        RWO            Delete           Bound       thanos/data-thanos-store-0     local-storage            11h\nthanos-store-pv2      5Gi        RWO            Delete           Bound       thanos/data-thanos-store-1     local-storage            11h\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-jj63lld",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-jj63lld",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-auztodb",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-auztodb",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-l7t4v78",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-l7t4v78",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "创建receiver配置文件"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-4j7ao06",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-4j7ao06",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban other]# cat thanos-receiver-config.yaml \napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: thanos-receive-hashrings\n  namespace: thanos\ndata:\n  thanos-receive-hashrings.json: |\n    [\n      {\n        \"hashring\": \"soft-tenants\",\n        \"endpoints\":\n        [\n          \"thanos-receive-0.thanos-receive.kube-system.svc.cluster.local:10901\",\n          \"thanos-receive-1.thanos-receive.kube-system.svc.cluster.local:10901\",\n          \"thanos-receive-2.thanos-receive.kube-system.svc.cluster.local:10901\"\n        ]\n      }\n    ]\n[root@tiaoban other]# kubectl apply -f thanos-receiver-config.yaml \nconfigmap/thanos-receive-hashrings created\n[root@tiaoban other]# kubectl get configmaps -n thanos \nNAME                       DATA   AGE\nalertmanager-conf          1      11h\nprometheus-config-tmpl     1      12h\nprometheus-rules           1      12h\nthanos-receive-hashrings   1      13s\nthanos-rules               1      38m\nthanos-storage-config      1      11h\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-i09aqu5",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-i09aqu5",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-97gvqwf",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-97gvqwf",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-stzig1m",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-stzig1m",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "部署receiver"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-x1kstcz",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20230420153245-x1kstcz",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20230420153245-wdxraeh",
					"Type": "NodeList",
					"ListData": {},
					"Properties": {
						"id": "20230420153245-wdxraeh",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-ugbav38",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-ugbav38",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-f58gujn",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-f58gujn",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "部署 3 个副本， 配置 hashring， --label=receive_replica 为数据添加 receive_replica 这个 label (Query 的 --query.replica-label 也要加上这个) 来实现 Receiver 的高可用。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-gop5mdk",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-gop5mdk",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-kyb6tv4",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-kyb6tv4",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "Query 要指定 Receiver 后端地址: --store=dnssrv+_grpc._tcp.thanos-receive.thanos.svc.cluster.local"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-nj0lw8d",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-nj0lw8d",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-4u6yp2i",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-4u6yp2i",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "request, limit 根据自身规模情况自行做适当调整。"
										}
									]
								}
							]
						},
						{
							"ID": "20230420153245-oksnpzb",
							"Type": "NodeListItem",
							"ListData": {
								"BulletChar": 42,
								"Marker": "Kg=="
							},
							"Properties": {
								"id": "20230420153245-oksnpzb",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"ID": "20230420153245-e8l37b6",
									"Type": "NodeParagraph",
									"Properties": {
										"id": "20230420153245-e8l37b6",
										"updated": "20230420153245"
									},
									"Children": [
										{
											"Type": "NodeText",
											"Data": "–tsdb.retention 根据自身需求调整最新数据的保留时间。"
										}
									]
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-7456450",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-7456450",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "[root@tiaoban other]# cat thanos-receiver.yaml \napiVersion: v1\nkind: Service\nmetadata:\n  name: thanos-receive\n  namespace: thanos\n  labels:\n    kubernetes.io/name: thanos-receive\nspec:\n  ports:\n  - name: http\n    port: 10902\n    protocol: TCP\n    targetPort: 10902\n  - name: remote-write\n    port: 19291\n    protocol: TCP\n    targetPort: 19291\n  - name: grpc\n    port: 10901\n    protocol: TCP\n    targetPort: 10901\n  selector:\n    kubernetes.io/name: thanos-receive\n  clusterIP: None\n---\n\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  labels:\n    kubernetes.io/name: thanos-receive\n  name: thanos-receive\n  namespace: thanos\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      kubernetes.io/name: thanos-receive\n  serviceName: thanos-receive\n  template:\n    metadata:\n      labels:\n        kubernetes.io/name: thanos-receive\n    spec:\n      containers:\n      - args:\n        - receive\n        - --grpc-address=0.0.0.0:10901\n        - --http-address=0.0.0.0:10902\n        - --remote-write.address=0.0.0.0:19291\n        - --tsdb.path=/var/thanos/receive\n        - --tsdb.retention=12h\n        - --label=receive_replica=\"$(NAME)\"\n        - --label=receive=\"true\"\n        - --receive.hashrings-file=/etc/thanos/thanos-receive-hashrings.json\n        - --receive.local-endpoint=$(NAME).thanos-receive.thanos.svc.cluster.local:10901\n        env:\n        - name: NAME\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.name\n        image: thanosio/thanos:v0.23.0-rc.0\n        imagePullPolicy: IfNotPresent\n        resources:\n          limits:\n            memory: 2Gi\n            cpu: \"1\"\n          requests:\n            memory: \"128Mi\"\n            cpu: \"100m\" \n        livenessProbe:\n          failureThreshold: 4\n          httpGet:\n            path: /-/healthy\n            port: 10902\n            scheme: HTTP\n          periodSeconds: 30\n        name: thanos-receive\n        ports:\n        - containerPort: 10901\n          name: grpc\n        - containerPort: 10902\n          name: http\n        - containerPort: 19291\n          name: remote-write\n        readinessProbe:\n          httpGet:\n            path: /-/ready\n            port: 10902\n            scheme: HTTP\n          initialDelaySeconds: 10\n          periodSeconds: 30\n        volumeMounts:\n        - mountPath: /var/thanos/receive\n          name: data\n          readOnly: false\n        - mountPath: /etc/thanos/thanos-receive-hashrings.json\n          name: thanos-receive-hashrings\n          subPath: thanos-receive-hashrings.json\n      terminationGracePeriodSeconds: 120\n      volumes:\n      - configMap:\n          defaultMode: 420\n          name: thanos-receive-hashrings\n        name: thanos-receive-hashrings\n  volumeClaimTemplates:\n  - metadata:\n      name: data\n    spec:\n      accessModes:\n      - ReadWriteOnce\n      storageClassName: local-storage\n      resources:\n        requests:\n          storage: 10Gi\n[root@tiaoban other]# kubectl apply -f thanos-receiver.yaml \nservice/thanos-receive created\nstatefulset.apps/thanos-receive created\n[root@tiaoban other]# kubectl get pod -n thanos -o wide -l kubernetes.io/name=thanos-receive\nNAME               READY   STATUS    RESTARTS   AGE   IP             NODE        NOMINATED NODE   READINESS GATES\nthanos-receive-0   1/1     Running   0          76s   10.244.1.107   k8s-work2   \u003cnone\u003e           \u003cnone\u003e\nthanos-receive-1   1/1     Running   0          49s   10.244.3.134   k8s-work1   \u003cnone\u003e           \u003cnone\u003e\nthanos-receive-2   1/1     Running   0          33s   10.244.2.101   k8s-work3   \u003cnone\u003e           \u003cnone\u003e\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-k0ok69p",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-k0ok69p",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-trzq5x7",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-trzq5x7",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-sgzxqyj",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-sgzxqyj",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "部署完receiver后，sidecar就可以停用了。先修改Prometheus 配置文件里加下 remote_write，让 Prometheus 将数据 push 给 Receiver:"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-x1de9qs",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-x1de9qs",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "# 删除先前的prometheus配置文件\n[root@tiaoban other]# kubectl delete configmaps -n thanos prometheus-config-tmpl \nconfigmap \"prometheus-config-tmpl\" deleted\n[root@tiaoban other]# cat prometheus-receiver-config.yaml \napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus-config\n  namespace: thanos\ndata:\n  prometheus.yaml: |-\n    global:\n      scrape_interval: 5s\n      evaluation_interval: 5s\n      external_labels:\n        cluster: prometheus-ha\n        prometheus_replica: $(POD_NAME)\n    rule_files:\n    - /etc/prometheus/rules/*.yaml\n    remote_write: \n    - url: http://thanos-receive.thanos.svc.cluster.local:19291/api/v1/receive\n    scrape_configs:\n    - job_name: node_exporter\n      kubernetes_sd_configs:\n      - role: node\n      relabel_configs:\n      - source_labels: [__address__]\n        regex: '(.*):10250'\n        replacement: '${1}:9100'\n        target_label: __address__\n        action: replace\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\n    - job_name: kubelet\n      metrics_path: /metrics/cadvisor\n      scrape_interval: 10s\n      scrape_timeout: 10s\n      scheme: https\n      tls_config:\n        insecure_skip_verify: true\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      kubernetes_sd_configs:\n      - role: node\n      relabel_configs:\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\n    - job_name: 'kube-state-metrics'\n      kubernetes_sd_configs:\n      - role: pod\n      relabel_configs:\n      - source_labels: [__meta_kubernetes_pod_name]\n        action: replace\n        target_label: pod\n      - action: labelmap\n        regex: __meta_kubernetes_pod_label_(.+)\n      - source_labels: [__meta_kubernetes_pod_ip]\n        regex: (.+)\n        target_label: __address__\n        replacement: ${1}:8080\n      - source_labels:  [\"__meta_kubernetes_pod_container_name\"]\n        regex: \"^kube-state-metrics.*\"\n        action: keep\n    - job_name: prometheus\n      honor_labels: false\n      kubernetes_sd_configs:\n      - role: endpoints\n      scrape_interval: 30s\n      relabel_configs:\n      - source_labels:\n          - __meta_kubernetes_service_label_name\n        regex: k8s-prometheus\n        action: keep\n      - source_labels: [__meta_kubernetes_pod_ip]\n        regex: (.+)\n        target_label: __address__\n        replacement: ${1}:9090\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus-rules\n  labels:\n    name: prometheus-rules\n  namespace: thanos\ndata:\n  alert-rules.yaml: |-\n    groups:\n    - name: k8s.rules\n      rules:\n      - expr: |\n          sum(rate(container_cpu_usage_seconds_total{job=\"cadvisor\", image!=\"\", container!=\"\"}[5m])) by (namespace)\n        record: namespace:container_cpu_usage_seconds_total:sum_rate\n      - expr: |\n          sum(container_memory_usage_bytes{job=\"cadvisor\", image!=\"\", container!=\"\"}) by (namespace)\n        record: namespace:container_memory_usage_bytes:sum\n      - expr: |\n          sum by (namespace, pod, container) (\n            rate(container_cpu_usage_seconds_total{job=\"cadvisor\", image!=\"\", container!=\"\"}[5m])\n          )\n        record: namespace_pod_container:container_cpu_usage_seconds_total:sum_rate         \n[root@tiaoban other]# kubectl apply -f prometheus-receiver-config.yaml \nconfigmap/prometheus-config-tmpl created\nconfigmap/prometheus-rules unchanged\n[root@tiaoban other]# kubectl get configmaps -n thanos \nNAME                       DATA   AGE\nalertmanager-conf          1      11h\nprometheus-config          1      2m47s\nprometheus-rules           1      13h\nthanos-receive-hashrings   1      36m\nthanos-rules               1      74m\nthanos-storage-config      1      12h\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-v2sno8o",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-v2sno8o",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-xt66xzn",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-xt66xzn",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-0b26yus",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-0b26yus",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "修改prometheus部署，删除sidecar相关部分"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-zzj4zd6",
			"Type": "NodeCodeBlock",
			"IsFencedCodeBlock": true,
			"Properties": {
				"id": "20230420153245-zzj4zd6",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeCodeBlockFenceOpenMarker",
					"Data": "```"
				},
				{
					"Type": "NodeCodeBlockFenceInfoMarker"
				},
				{
					"Type": "NodeCodeBlockCode",
					"Data": "# 删除先前部署的prometheus\n[root@tiaoban other]# kubectl delete statefulsets.apps -n thanos prometheus \nstatefulset.apps \"prometheus\" deleted\n[root@tiaoban other]# cat prometheus-receiver.yaml \nkind: Service\napiVersion: v1\nmetadata:\n  name: prometheus-headless\n  namespace: thanos\n  labels:\n    app.kubernetes.io/name: prometheus\n    name: k8s-prometheus\nspec:\n  type: ClusterIP\n  clusterIP: None\n  selector:\n    app.kubernetes.io/name: prometheus\n  ports:\n  - name: web\n    protocol: TCP\n    port: 9090\n    targetPort: web\n  - name: grpc\n    port: 10901\n    targetPort: grpc\n---\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: prometheus\n  namespace: thanos\n  labels:\n    app.kubernetes.io/name: thanos-query\nspec:\n  serviceName: prometheus-headless\n  podManagementPolicy: Parallel\n  replicas: 3\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: prometheus\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/name: prometheus\n    spec:\n      serviceAccountName: prometheus\n      securityContext:\n        fsGroup: 2000\n        runAsNonRoot: true\n        runAsUser: 1000\n      affinity:\n        podAntiAffinity:\n          requiredDuringSchedulingIgnoredDuringExecution:\n          - labelSelector:\n              matchExpressions:\n              - key: app.kubernetes.io/name\n                operator: In\n                values:\n                - prometheus\n            topologyKey: kubernetes.io/hostname\n      containers:\n      - name: prometheus\n        image: prom/prometheus:v2.30.0\n        imagePullPolicy: IfNotPresent\n        resources:\n          limits:\n            memory: \"2048Mi\"\n            cpu: \"500m\" \n          requests:\n            memory: \"128Mi\"\n            cpu: \"100m\" \n        args:\n        - --config.file=/etc/prometheus/config/prometheus.yaml\n        - --storage.tsdb.path=/prometheus\n        - --storage.tsdb.retention.time=10d\n        - --web.route-prefix=/\n        - --web.enable-lifecycle\n        - --storage.tsdb.no-lockfile\n        - --storage.tsdb.min-block-duration=2h\n        - --storage.tsdb.max-block-duration=2h\n        - --log.level=debug\n        ports:\n        - containerPort: 9090\n          name: web\n          protocol: TCP\n        livenessProbe:\n          failureThreshold: 6\n          httpGet:\n            path: /-/healthy\n            port: web\n            scheme: HTTP\n          periodSeconds: 5\n          successThreshold: 1\n          timeoutSeconds: 3\n        readinessProbe:\n          failureThreshold: 120\n          httpGet:\n            path: /-/ready\n            port: web\n            scheme: HTTP\n          periodSeconds: 5\n          successThreshold: 1\n          timeoutSeconds: 3\n        volumeMounts:\n        - mountPath: /etc/prometheus/config\n          name: prometheus-config\n          readOnly: true\n        - mountPath: /prometheus\n          name: data\n        - mountPath: /etc/prometheus/rules\n          name: prometheus-rules\n      volumes:\n      - name: prometheus-config\n        configMap:\n          name: prometheus-config\n      - name: prometheus-rules\n        configMap:\n          name: prometheus-rules\n  volumeClaimTemplates:\n  - metadata:\n      name: data\n    spec:\n      accessModes:\n      - ReadWriteOnce\n      storageClassName: local-storage\n      resources:\n        requests:\n          storage: 5Gi\n[root@tiaoban other]# kubectl apply -f prometheus-receiver.yaml \nservice/prometheus-headless unchanged\nstatefulset.apps/prometheus created\n[root@tiaoban other]# kubectl get pod -n thanos -o wide -l app.kubernetes.io/name=prometheus\nNAME           READY   STATUS    RESTARTS   AGE     IP             NODE        NOMINATED NODE   READINESS GATES\nprometheus-0   1/1     Running   0          2m13s   10.244.3.136   k8s-work1   \u003cnone\u003e           \u003cnone\u003e\nprometheus-1   1/1     Running   0          119s    10.244.1.109   k8s-work2   \u003cnone\u003e           \u003cnone\u003e\nprometheus-2   1/1     Running   0          110s    10.244.2.104   k8s-work3   \u003cnone\u003e           \u003cnone\u003e\n"
				},
				{
					"Type": "NodeCodeBlockFenceCloseMarker",
					"Data": "```"
				}
			]
		},
		{
			"ID": "20230420153245-e2m9fcq",
			"Type": "NodeHeading",
			"HeadingLevel": 2,
			"Properties": {
				"id": "20230420153245-e2m9fcq",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "五、thanos使用"
				}
			]
		},
		{
			"ID": "20230420153245-zsr6o76",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20230420153245-zsr6o76",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "1. Thanos Querier"
				}
			]
		},
		{
			"ID": "20230420153245-i3hg8ex",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230420153245-i3hg8ex",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "使用thanos querier调试PromQL和prometheus上调试别无二致，最主要的一点是记得选择“Use Deldupication“ 删除重复数据。\n​"
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "image.png"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "assets/imgProxy-20230420153245-xj6b0r7.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20230420153245-dnhtd1y",
			"Type": "NodeHeading",
			"HeadingLevel": 3,
			"Properties": {
				"id": "20230420153245-dnhtd1y",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "2. Grafana"
				}
			]
		},
		{
			"ID": "20230420153245-3ym6nzz",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-3ym6nzz",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-1wcayei",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-1wcayei",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-3c91isa",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-3c91isa",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "grafana创建数据源时，由于thanos-query和grafana同属一个namespace，所以url地址填写thanos-query:9090即可。如果位于不同namespace，url地址填写为：http://(servicename).(namespace).svc.cluster.local:9090"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-5tnr3iy",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230420153245-5tnr3iy",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "​"
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "image.png"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "assets/imgProxy-20230420153245-vtmhvr6.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20230420153245-iidewrd",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-iidewrd",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-0dg15lu",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-0dg15lu",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-2zpge6y",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-2zpge6y",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "然后从grafana官网dashboard导入对应的dashboard即可"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-g2ee1po",
			"Type": "NodeParagraph",
			"Properties": {
				"id": "20230420153245-g2ee1po",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "​"
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "image.png"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "assets/imgProxy-20230420153245-5lyt6vh.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "\n​"
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "image.png"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "assets/imgProxy-20230420153245-nz2uvyg.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "\n​"
				},
				{
					"Type": "NodeImage",
					"Data": "span",
					"Children": [
						{
							"Type": "NodeBang"
						},
						{
							"Type": "NodeOpenBracket"
						},
						{
							"Type": "NodeLinkText",
							"Data": "image.png"
						},
						{
							"Type": "NodeCloseBracket"
						},
						{
							"Type": "NodeOpenParen"
						},
						{
							"Type": "NodeLinkDest",
							"Data": "assets/imgProxy-20230420153245-7adn7n1.png"
						},
						{
							"Type": "NodeCloseParen"
						}
					]
				},
				{
					"Type": "NodeText",
					"Data": "​"
				}
			]
		},
		{
			"ID": "20230420153245-660l6q6",
			"Type": "NodeHeading",
			"HeadingLevel": 2,
			"Properties": {
				"id": "20230420153245-660l6q6",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeText",
					"Data": "六、注意事项"
				}
			]
		},
		{
			"ID": "20230420153245-engasps",
			"Type": "NodeList",
			"ListData": {
				"Typ": 1
			},
			"Properties": {
				"id": "20230420153245-engasps",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-r452jg8",
					"Type": "NodeListItem",
					"ListData": {
						"Typ": 1,
						"Delimiter": 46,
						"Marker": "MS4=",
						"Num": 1
					},
					"Properties": {
						"id": "20230420153245-r452jg8",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-mn555vw",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-mn555vw",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "Ruler 组件获取评估数据的路径为 rule–\u003equery–\u003esidecar/receiver–\u003eprometheus 需要经过一整个查询链条，这也提升了发生故障的风险，且评估原本就可以在 Prometheus 中进行，所以在生产环境建议每个prometheus集群也部署alertmanager，防止因thanos某一组件异常而导致告警无法正常触发。"
								}
							]
						}
					]
				},
				{
					"ID": "20230420153245-p4nur4n",
					"Type": "NodeListItem",
					"ListData": {
						"Typ": 1,
						"Delimiter": 46,
						"Marker": "Mi4=",
						"Num": 2
					},
					"Properties": {
						"id": "20230420153245-p4nur4n",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-2kbnzld",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-2kbnzld",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "如果使用receive模式，保障每个prometheus配置文件external_labels标签全局唯一，否则receive组件会因写入数据重复而产生大量异常错误日志不断重启。详情参考链接"
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://thanos.io/tip/operating/troubleshooting.md/#out-of-order-samples-error",
									"TextMarkTextContent": "https://thanos.io/tip/operating/troubleshooting.md/#out-of-order-samples-error"
								}
							]
						}
					]
				},
				{
					"ID": "20230420153245-os74qba",
					"Type": "NodeListItem",
					"ListData": {
						"Typ": 1,
						"Delimiter": 46,
						"Marker": "My4=",
						"Num": 3
					},
					"Properties": {
						"id": "20230420153245-os74qba",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-d814lq7",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-d814lq7",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "实测thanos所有组件中receive最消耗性能，根据实际情况调高limits"
								}
							]
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-utqn2mt",
			"Type": "NodeBlockquote",
			"Properties": {
				"id": "20230420153245-utqn2mt",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"Type": "NodeBlockquoteMarker",
					"Data": "\u003e"
				},
				{
					"ID": "20230420153245-7k8nptf",
					"Type": "NodeParagraph",
					"Properties": {
						"id": "20230420153245-7k8nptf",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"Type": "NodeText",
							"Data": "参考链接"
						}
					]
				}
			]
		},
		{
			"ID": "20230420153245-tlunkny",
			"Type": "NodeList",
			"ListData": {},
			"Properties": {
				"id": "20230420153245-tlunkny",
				"updated": "20230420153245"
			},
			"Children": [
				{
					"ID": "20230420153245-uhd6ncs",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-uhd6ncs",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-wxk4yjn",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-wxk4yjn",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "thanos部署\n"
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://k8s.imroc.io/monitoring/build-cloud-native-large-scale-distributed-monitoring-system/thanos-deploy/",
									"TextMarkTextContent": "https://k8s.imroc.io/monitoring/build-cloud-native-large-scale-distributed-monitoring-system/thanos-deploy/"
								},
								{
									"Type": "NodeText",
									"Data": "\n"
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://www.kubernetes.org.cn/8308.html",
									"TextMarkTextContent": "https://www.kubernetes.org.cn/8308.html"
								}
							]
						}
					]
				},
				{
					"ID": "20230420153245-uguld1o",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-uguld1o",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-4jwst50",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-4jwst50",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "sidecar更多配置参见\n"
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://github.com/thanos-io/thanos/blob/main/docs/components/sidecar.md",
									"TextMarkTextContent": "https://github.com/thanos-io/thanos/blob/main/docs/components/sidecar.md"
								}
							]
						}
					]
				},
				{
					"ID": "20230420153245-zt4gk2j",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-zt4gk2j",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-yvp4yib",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-yvp4yib",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "query更多配置项参见\n"
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://github.com/thanos-io/thanos/blob/main/docs/components/query.md",
									"TextMarkTextContent": "https://github.com/thanos-io/thanos/blob/main/docs/components/query.md"
								}
							]
						}
					]
				},
				{
					"ID": "20230420153245-fgmne66",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-fgmne66",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-yydlpqc",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-yydlpqc",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "store更多配置项参见\n"
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://github.com/thanos-io/thanos/blob/main/docs/components/store.md",
									"TextMarkTextContent": "https://github.com/thanos-io/thanos/blob/main/docs/components/store.md"
								}
							]
						}
					]
				},
				{
					"ID": "20230420153245-asyycmm",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-asyycmm",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-ov0j0kl",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-ov0j0kl",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "compact更多配置项参见\n"
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://github.com/thanos-io/thanos/blob/main/docs/components/compact.md",
									"TextMarkTextContent": "https://github.com/thanos-io/thanos/blob/main/docs/components/compact.md"
								}
							]
						}
					]
				},
				{
					"ID": "20230420153245-6dhjds5",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-6dhjds5",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-xdtisiv",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-xdtisiv",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "rule更多配置项参见\n"
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://thanos.io/components/rule.md/#configuring-rules",
									"TextMarkTextContent": "https://thanos.io/components/rule.md/#configuring-rules"
								}
							]
						}
					]
				},
				{
					"ID": "20230420153245-kxhz800",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-kxhz800",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-9sw0z9d",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-9sw0z9d",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "k8s服务自动发现\n"
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://juejin.cn/post/6844903908251451406",
									"TextMarkTextContent": "https://juejin.cn/post/6844903908251451406"
								},
								{
									"Type": "NodeText",
									"Data": "\n"
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config",
									"TextMarkTextContent": "https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config"
								},
								{
									"Type": "NodeText",
									"Data": "\n"
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://github.com/prometheus/prometheus/blob/release-2.12/documentation/examples/prometheus-kubernetes.yml",
									"TextMarkTextContent": "https://github.com/prometheus/prometheus/blob/release-2.12/documentation/examples/prometheus-kubernetes.yml"
								}
							]
						}
					]
				},
				{
					"ID": "20230420153245-5m210di",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-5m210di",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-l92d33c",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-l92d33c",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "grafana模板\n"
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://grafana.com/grafana/dashboards/13105",
									"TextMarkTextContent": "https://grafana.com/grafana/dashboards/13105"
								},
								{
									"Type": "NodeText",
									"Data": "\n"
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://grafana.com/grafana/dashboards/8919",
									"TextMarkTextContent": "https://grafana.com/grafana/dashboards/8919"
								}
							]
						}
					]
				},
				{
					"ID": "20230420153245-w6de55o",
					"Type": "NodeListItem",
					"ListData": {
						"BulletChar": 42,
						"Marker": "Kg=="
					},
					"Properties": {
						"id": "20230420153245-w6de55o",
						"updated": "20230420153245"
					},
					"Children": [
						{
							"ID": "20230420153245-e769vtt",
							"Type": "NodeParagraph",
							"Properties": {
								"id": "20230420153245-e769vtt",
								"updated": "20230420153245"
							},
							"Children": [
								{
									"Type": "NodeText",
									"Data": "prometheus痛点分析\n"
								},
								{
									"Type": "NodeTextMark",
									"TextMarkType": "a",
									"TextMarkAHref": "https://cloud.tencent.com/developer/article/1605915?from=10680",
									"TextMarkTextContent": "https://cloud.tencent.com/developer/article/1605915?from=10680"
								}
							]
						}
					]
				}
			]
		}
	]
}